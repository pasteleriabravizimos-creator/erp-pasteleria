<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Pasteler√≠a Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Inter', -apple-system, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==================== CONFIGURACI√ìN ====================
        const CONFIG = {
            GOOGLE_SHEETS_ID: localStorage.getItem('sheets_id') || '',
            GOOGLE_API_KEY: localStorage.getItem('api_key') || '',
        };

        // ==================== DATOS INICIALES ====================
        const DATOS_INICIALES = {
            ventas: [],
            gastos: [],
            personal: [
                { nombre: 'VERITO', cargo: 'Vendedora Senior', sueldoBase: 1500, afp: 195, renta5ta: 0, planilla: true, ultimoPago: '2025-01-01', tipoPago: 'mensual' },
                { nombre: 'Deysi', cargo: 'Vendedora', sueldoBase: 1300, afp: 169, renta5ta: 0, planilla: true, ultimoPago: '2025-01-01', tipoPago: 'mensual' },
                { nombre: 'Sandy', cargo: 'Vendedora', sueldoBase: 1300, afp: 169, renta5ta: 0, planilla: false, ultimoPago: '2025-01-01', tipoPago: 'quincenal' },
                { nombre: 'Martin', cargo: 'Delivery', sueldoBase: 800, afp: 0, renta5ta: 0, planilla: false, ultimoPago: '2025-01-01', tipoPago: 'quincenal' },
                { nombre: 'Rosa', cargo: 'Producci√≥n', sueldoBase: 1200, afp: 156, renta5ta: 0, planilla: true, ultimoPago: '2025-01-01', tipoPago: 'mensual' },
                { nombre: 'Milagros', cargo: 'Producci√≥n', sueldoBase: 1200, afp: 156, renta5ta: 0, planilla: true, ultimoPago: '2025-01-01', tipoPago: 'mensual' },
            ],
            insumos: [
                { codigo: 'INS001', nombre: 'HARINA PREPARADA', stock: 250, unidad: 'KG', costoUnitario: 4.2, categoria: 'Materia Prima' },
                { codigo: 'INS002', nombre: 'ACEITE VEGETAL', stock: 45, unidad: 'LT', costoUnitario: 8.5, categoria: 'Materia Prima' },
                { codigo: 'INS003', nombre: 'AZUCAR BLANCA', stock: 180, unidad: 'KG', costoUnitario: 3.2, categoria: 'Materia Prima' },
                { codigo: 'INS004', nombre: 'MANTEQUILLA', stock: 12, unidad: 'KG', costoUnitario: 18, categoria: 'L√°cteos' },
                { codigo: 'INS005', nombre: 'HUEVOS', stock: 850, unidad: 'UND', costoUnitario: 0.45, categoria: 'Prote√≠nas' },
                { codigo: 'INS006', nombre: 'CARNE MOLIDA', stock: 55, unidad: 'KG', costoUnitario: 22, categoria: 'Prote√≠nas' },
            ],
            productos: [
                { 
                    codigo: 'PROD001', nombre: 'EMPANADA DE CARNE', precioVenta: 3.5, categoria: 'Salados',
                    receta: [
                        { insumo: 'INS001', cantidad: 0.08 },
                        { insumo: 'INS002', cantidad: 0.03 },
                        { insumo: 'INS006', cantidad: 0.05 },
                    ]
                },
                { 
                    codigo: 'PROD002', nombre: 'ALFAJOR CON MANJAR', precioVenta: 2.0, categoria: 'Dulces',
                    receta: [
                        { insumo: 'INS001', cantidad: 0.05 },
                        { insumo: 'INS004', cantidad: 0.025 },
                    ]
                },
            ],
            servicios: [
                { nombre: 'LUZ', monto: 850, vencimiento: '2025-01-20', pagado: 850, medioPago: 'Principal' },
                { nombre: 'AGUA', monto: 280, vencimiento: '2025-01-25', pagado: 0, medioPago: '' },
                { nombre: 'INTERNET', monto: 220, vencimiento: '2025-01-15', pagado: 220, medioPago: 'Principal' },
            ],
        };

        // ==================== COMPONENTE PRINCIPAL ====================
        const ERP = () => {
            const [module, setModule] = useState('dashboard');
            const [syncing, setSyncing] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [filtroFecha, setFiltroFecha] = useState({ inicio: '2025-01-01', fin: '2025-01-31' });
            
            const [ventas, setVentas] = useState(DATOS_INICIALES.ventas);
            const [gastos, setGastos] = useState(DATOS_INICIALES.gastos);
            const [personal, setPersonal] = useState(DATOS_INICIALES.personal);
            const [insumos, setInsumos] = useState(DATOS_INICIALES.insumos);
            const [productos, setProductos] = useState(DATOS_INICIALES.productos);
            const [servicios, setServicios] = useState(DATOS_INICIALES.servicios);

            // ==================== SINCRONIZACI√ìN ====================
            const syncSheets = async () => {
                setSyncing(true);
                try {
                    if (!CONFIG.GOOGLE_SHEETS_ID || !CONFIG.GOOGLE_API_KEY) {
                        alert('‚ö†Ô∏è Configura tu Google Sheets primero');
                        setSyncing(false);
                        return;
                    }

                    // Sincronizar VENTAS
                    const urlVentas = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.GOOGLE_SHEETS_ID}/values/VENTAS!A2:Z?key=${CONFIG.GOOGLE_API_KEY}`;
                    const resVentas = await fetch(urlVentas);
                    const dataVentas = await resVentas.json();
                    
                    if (dataVentas.values) {
                        const ventasSync = dataVentas.values.map((r, i) => ({
                            id: i + 1,
                            numero: r[0] || '',
                            fechaEmision: r[1] || '',
                            fechaEntrega: r[2] || '',
                            horaEntrega: r[3] || '',
                            nPedido: r[4] || '',
                            vendedor: r[5] || '',
                            cliente: r[6] || '',
                            docIdentidad: r[7] || '',
                            telefono: r[8] || '',
                            moneda: r[9] || 'PEN',
                            monto: parseFloat(r[10]) || 0,
                            contacto: r[11] || '',
                            nContacto: r[12] || '',
                            saldo: parseFloat(r[13]) || 0,
                            direccion: r[14] || '',
                            distrito: r[15] || '',
                            observaciones: r[16] || '',
                            estado: r[17] || 'Pendiente',
                        }));
                        setVentas(ventasSync);
                    }

                    // Sincronizar GASTOS
                    const urlGastos = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.GOOGLE_SHEETS_ID}/values/GASTOS!A2:Z?key=${CONFIG.GOOGLE_API_KEY}`;
                    const resGastos = await fetch(urlGastos);
                    const dataGastos = await resGastos.json();
                    
                    if (dataGastos.values) {
                        const gastosSync = dataGastos.values.map((r, i) => ({
                            id: i + 1,
                            periodo: r[0] || '',
                            area: r[1] || '',
                            razonSocial: r[2] || '',
                            tipoDoc: r[3] || '',
                            serie: r[4] || '',
                            numero: r[5] || '',
                            descripcion: r[6] || '',
                            monto: parseFloat(r[7]) || 0,
                            pendiente: parseFloat(r[8]) || 0,
                            medio: r[9] || '',
                            observaciones: r[10] || '',
                        }));
                        setGastos(gastosSync);
                    }

                    setLastSync(new Date());
                    alert('‚úÖ Sincronizado con Google Sheets');
                } catch (e) {
                    console.error(e);
                    alert('‚ùå Error al sincronizar');
                }
                setSyncing(false);
            };

            // Auto-sync cada 5 minutos
            useEffect(() => {
                const int = setInterval(() => {
                    if (CONFIG.GOOGLE_SHEETS_ID && CONFIG.GOOGLE_API_KEY) syncSheets();
                }, 300000);
                return () => clearInterval(int);
            }, []);

            // ==================== C√ÅLCULOS ====================
            const calcularCostoProducto = (productoId, cantidad) => {
                const producto = productos.find(p => p.codigo === productoId);
                if (!producto) return { costo: 0, insumos: [], total: 0 };

                const insumosNecesarios = producto.receta.map(r => {
                    const insumo = insumos.find(i => i.codigo === r.insumo);
                    return {
                        nombre: insumo?.nombre || '',
                        cantidad: r.cantidad * cantidad,
                        costo: (insumo?.costoUnitario || 0) * r.cantidad * cantidad,
                        unidad: insumo?.unidad || ''
                    };
                });

                const costoTotal = insumosNecesarios.reduce((sum, i) => sum + i.costo, 0);
                const precioVenta = producto.precioVenta * cantidad;
                const ganancia = precioVenta - costoTotal;

                return {
                    costo: costoTotal,
                    precio: precioVenta,
                    ganancia,
                    rentabilidad: (ganancia / costoTotal * 100).toFixed(2),
                    insumos: insumosNecesarios
                };
            };

            const verificarSueldos = () => {
                const hoy = new Date();
                const alertas = [];

                personal.forEach(p => {
                    const ultimoPago = new Date(p.ultimoPago);
                    const diasDiff = Math.floor((hoy - ultimoPago) / (1000 * 60 * 60 * 24));

                    if (p.tipoPago === 'mensual' && diasDiff >= 30) {
                        alertas.push(`‚ö†Ô∏è ${p.nombre}: Sueldo mensual pendiente (${diasDiff} d√≠as)`);
                    } else if (p.tipoPago === 'quincenal' && diasDiff >= 15) {
                        alertas.push(`‚ö†Ô∏è ${p.nombre}: Pago quincenal pendiente (${diasDiff} d√≠as)`);
                    }
                });

                return alertas;
            };

            // ==================== M√ìDULOS ====================
            
            const Dashboard = () => {
                const totalIngresos = ventas.reduce((s, v) => s + v.monto, 0);
                const totalGastos = gastos.reduce((s, g) => s + g.monto, 0);
                const balance = totalIngresos - totalGastos;
                const alertasSueldo = verificarSueldos();

                return (
                    <div className="space-y-6">
                        {/* Barra Sync */}
                        <div className="bg-blue-600 rounded-2xl p-4 text-white flex justify-between items-center">
                            <div>
                                <p className="font-bold text-lg">üìä Dashboard Principal</p>
                                {lastSync && <p className="text-sm">√öltima sync: {lastSync.toLocaleTimeString()}</p>}
                            </div>
                            <button onClick={syncSheets} disabled={syncing} className="bg-white text-blue-600 px-4 py-2 rounded-lg font-bold">
                                {syncing ? 'üîÑ Sincronizando...' : 'üîÑ Sincronizar'}
                            </button>
                        </div>

                        {/* Alertas de Sueldos */}
                        {alertasSueldo.length > 0 && (
                            <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4">
                                <p className="font-bold text-red-800 mb-2">üö® ALERTAS DE PAGO</p>
                                {alertasSueldo.map((a, i) => <p key={i} className="text-red-700">{a}</p>)}
                            </div>
                        )}

                        {/* KPIs */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 text-white">
                                <p className="text-3xl">üí∞</p>
                                <h3 className="text-2xl font-bold">S/ {totalIngresos.toLocaleString()}</h3>
                                <p className="text-sm">Ingresos</p>
                            </div>
                            <div className="bg-gradient-to-br from-red-500 to-rose-600 rounded-xl p-6 text-white">
                                <p className="text-3xl">üí∏</p>
                                <h3 className="text-2xl font-bold">S/ {totalGastos.toLocaleString()}</h3>
                                <p className="text-sm">Gastos</p>
                            </div>
                            <div className="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl p-6 text-white">
                                <p className="text-3xl">üìä</p>
                                <h3 className="text-2xl font-bold">S/ {balance.toLocaleString()}</h3>
                                <p className="text-sm">Balance</p>
                            </div>
                            <div className="bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl p-6 text-white">
                                <p className="text-3xl">üì¶</p>
                                <h3 className="text-2xl font-bold">{ventas.length}</h3>
                                <p className="text-sm">Pedidos</p>
                            </div>
                        </div>

                        {/* Ranking Vendedores */}
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-2xl font-bold mb-4">üèÜ Ranking de Vendedoras</h3>
                            <table className="w-full">
                                <thead><tr className="bg-gray-100"><th className="p-2">Vendedor</th><th className="p-2">Ventas</th><th className="p-2">Monto</th></tr></thead>
                                <tbody>
                                    {Object.entries(ventas.reduce((acc, v) => {
                                        if (!acc[v.vendedor]) acc[v.vendedor] = { cant: 0, monto: 0 };
                                        acc[v.vendedor].cant++;
                                        acc[v.vendedor].monto += v.monto;
                                        return acc;
                                    }, {})).sort((a, b) => b[1].monto - a[1].monto).map(([nombre, data]) => (
                                        <tr key={nombre} className="border-b">
                                            <td className="p-2 font-bold">{nombre}</td>
                                            <td className="p-2">{data.cant}</td>
                                            <td className="p-2 text-green-600 font-bold">S/ {data.monto.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const ReporteIngresos = () => {
                return <div className="bg-white rounded-xl p-6"><h2 className="text-2xl font-bold">üìà Reporte de Ingresos</h2><p>En desarrollo...</p></div>;
            };

            const Configuracion = () => {
                const [id, setId] = useState(CONFIG.GOOGLE_SHEETS_ID);
                const [key, setKey] = useState(CONFIG.GOOGLE_API_KEY);

                const save = () => {
                    localStorage.setItem('sheets_id', id);
                    localStorage.setItem('api_key', key);
                    CONFIG.GOOGLE_SHEETS_ID = id;
                    CONFIG.GOOGLE_API_KEY = key;
                    alert('‚úÖ Configuraci√≥n guardada. Recarga la p√°gina.');
                };

                return (
                    <div className="bg-white rounded-xl p-6">
                        <h2 className="text-2xl font-bold mb-4">‚öôÔ∏è Configuraci√≥n</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block font-bold mb-2">Google Sheets ID</label>
                                <input value={id} onChange={e => setId(e.target.value)} className="w-full p-3 border-2 rounded-lg" />
                            </div>
                            <div>
                                <label className="block font-bold mb-2">Google API Key</label>
                                <input value={key} onChange={e => setKey(e.target.value)} className="w-full p-3 border-2 rounded-lg" />
                            </div>
                            <button onClick={save} className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">üíæ Guardar</button>
                        </div>
                    </div>
                );
            };

            // ==================== RENDER ====================
            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
                    <div className="bg-gradient-to-r from-slate-900 to-blue-900 text-white p-4">
                        <h1 className="text-3xl font-bold">üéÇ ERP PASTELER√çA PROFESIONAL</h1>
                        <p className="text-sm">Sistema Integrado de Gesti√≥n</p>
                    </div>
                    <div className="bg-white border-b p-2 flex gap-2 overflow-x-auto scrollbar-hide">
                        {[
                            { id: 'dashboard', name: 'üìä Dashboard' },
                            { id: 'ingresos', name: 'üí∞ Ingresos' },
                            { id: 'config', name: '‚öôÔ∏è Config' },
                        ].map(m => (
                            <button key={m.id} onClick={() => setModule(m.id)} className={`px-4 py-2 rounded-lg font-bold whitespace-nowrap ${module === m.id ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
                                {m.name}
                            </button>
                        ))}
                    </div>
                    <div className="p-4">
                        {module === 'dashboard' && <Dashboard />}
                        {module === 'ingresos' && <ReporteIngresos />}
                        {module === 'config' && <Configuracion />}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ERP />, document.getElementById('root'));
    </script>
</body>
</html>