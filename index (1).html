<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Pasteler√≠a - Sistema Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const CONFIG = {
            GOOGLE_SHEETS_ID: localStorage.getItem('sheets_id') || '',
            GOOGLE_API_KEY: localStorage.getItem('api_key') || '',
        };

        const Icon = ({ type, size = 24 }) => {
            const icons = { chart: "üìä", dollar: "üí∞", sync: "üîÑ", check: "‚úì", cloud: "‚òÅÔ∏è", trending: "üìà", package: "üì¶" };
            return <span style={{fontSize: `${size}px`}}>{icons[type] || "‚Ä¢"}</span>;
        };

        const ERP = () => {
            const [module, setModule] = useState('dashboard');
            const [syncing, setSyncing] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [gastos, setGastos] = useState([
                { id: 1, fecha: '2025-01-04', tipo: 'Delivery', concepto: 'AGUSTINO', monto: 21, origen: 'WhatsApp' },
                { id: 2, fecha: '2025-01-04', tipo: 'Yape', concepto: 'Carlos A', monto: 71, origen: 'WhatsApp' },
            ]);

            const syncSheets = async () => {
                setSyncing(true);
                try {
                    if (!CONFIG.GOOGLE_SHEETS_ID || !CONFIG.GOOGLE_API_KEY) {
                        alert('‚ö†Ô∏è Configura tu Google Sheets primero');
                        setSyncing(false);
                        return;
                    }
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.GOOGLE_SHEETS_ID}/values/GASTOS!A:G?key=${CONFIG.GOOGLE_API_KEY}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.values) {
                        const nuevos = data.values.slice(1).map((r, i) => ({
                            id: 1000 + i,
                            fecha: r[0],
                            tipo: r[1],
                            concepto: r[2],
                            monto: parseFloat(r[3]),
                            origen: r[5] || 'Manual'
                        }));
                        setGastos(prev => [...prev, ...nuevos.filter(n => !prev.find(p => p.fecha === n.fecha && p.monto === n.monto))]);
                        setLastSync(new Date());
                        alert('‚úÖ Sincronizado con Google Sheets');
                    }
                } catch (e) {
                    alert('‚ùå Error al sincronizar');
                }
                setSyncing(false);
            };

            useEffect(() => {
                const int = setInterval(() => {
                    if (CONFIG.GOOGLE_SHEETS_ID && CONFIG.GOOGLE_API_KEY) syncSheets();
                }, 300000);
                return () => clearInterval(int);
            }, []);

            const Dashboard = () => {
                const total = gastos.reduce((s, g) => s + g.monto, 0);
                return (
                    <div className="space-y-6">
                        <div className="bg-blue-600 rounded-2xl p-4 text-white flex justify-between">
                            <div>
                                <p className="font-bold">üîÑ Sistema Sincronizado</p>
                                {lastSync && <p className="text-sm">{lastSync.toLocaleTimeString()}</p>}
                            </div>
                            <button onClick={syncSheets} disabled={syncing} className="bg-white text-blue-600 px-4 py-2 rounded-lg font-bold">
                                <Icon type="sync" /> {syncing ? 'Sincronizando...' : 'Sincronizar'}
                            </button>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 text-white">
                                <Icon type="trending" size={32} />
                                <h3 className="text-3xl font-bold mt-2">S/ 377</h3>
                                <p>Ventas</p>
                            </div>
                            <div className="bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl p-6 text-white">
                                <Icon type="dollar" size={32} />
                                <h3 className="text-3xl font-bold mt-2">S/ {total}</h3>
                                <p>Gastos</p>
                            </div>
                        </div>
                    </div>
                );
            };

            const Gastos = () => (
                <div className="bg-white rounded-2xl shadow-xl p-6">
                    <h2 className="text-2xl font-bold mb-4">üí∞ Gastos</h2>
                    <table className="w-full">
                        <thead><tr className="bg-gray-100"><th className="p-2">Fecha</th><th className="p-2">Tipo</th><th className="p-2">Concepto</th><th className="p-2">Monto</th></tr></thead>
                        <tbody>
                            {gastos.map(g => (
                                <tr key={g.id} className="border-b">
                                    <td className="p-2">{g.fecha}</td>
                                    <td className="p-2">{g.tipo}</td>
                                    <td className="p-2">{g.concepto}</td>
                                    <td className="p-2 font-bold text-red-600">S/ {g.monto}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );

            const Config = () => {
                const [id, setId] = useState(CONFIG.GOOGLE_SHEETS_ID);
                const [key, setKey] = useState(CONFIG.GOOGLE_API_KEY);
                const save = () => {
                    localStorage.setItem('sheets_id', id);
                    localStorage.setItem('api_key', key);
                    CONFIG.GOOGLE_SHEETS_ID = id;
                    CONFIG.GOOGLE_API_KEY = key;
                    alert('‚úÖ Configuraci√≥n guardada');
                };
                return (
                    <div className="bg-white rounded-2xl p-6">
                        <h2 className="text-2xl font-bold mb-4">‚öôÔ∏è Configuraci√≥n</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block font-bold mb-2">Google Sheets ID</label>
                                <input value={id} onChange={e => setId(e.target.value)} className="w-full p-3 border-2 rounded-lg" placeholder="1AbC...XyZ" />
                            </div>
                            <div>
                                <label className="block font-bold mb-2">Google API Key</label>
                                <input value={key} onChange={e => setKey(e.target.value)} className="w-full p-3 border-2 rounded-lg" placeholder="AIza..." />
                            </div>
                            <button onClick={save} className="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-bold">üíæ Guardar</button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50">
                    <div className="bg-gradient-to-r from-slate-900 to-blue-900 text-white p-4">
                        <h1 className="text-3xl font-bold">ERP INTEGRADO üöÄ</h1>
                        <p className="text-sm">WhatsApp ‚Ä¢ Google Sheets ‚Ä¢ Make.com</p>
                    </div>
                    <div className="bg-white border-b p-2 flex gap-2">
                        {['dashboard', 'gastos', 'config'].map(m => (
                            <button key={m} onClick={() => setModule(m)} className={`px-4 py-2 rounded-lg font-bold ${module === m ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
                                {m === 'dashboard' ? 'üìä Dashboard' : m === 'gastos' ? 'üí∞ Gastos' : '‚öôÔ∏è Config'}
                            </button>
                        ))}
                    </div>
                    <div className="p-4">
                        {module === 'dashboard' && <Dashboard />}
                        {module === 'gastos' && <Gastos />}
                        {module === 'config' && <Config />}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ERP />, document.getElementById('root'));
    </script>
</body>
</html>