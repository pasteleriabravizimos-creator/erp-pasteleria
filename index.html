<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel de Servicios - BRAVIZIMO'S</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

  <style>
    .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
  </style>
</head>

<body class="bg-gray-50">
  <nav class="gradient-bg shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="text-white font-bold text-xl">Gesti√≥n de Servicios</div>
      <div class="flex gap-4 text-white">
        <button class="hover:opacity-80" onclick="showView('servicios')">Servicios</button>
        <button class="hover:opacity-80" onclick="showView('dashboard')">Dashboard</button>
        <button class="hover:opacity-80" onclick="showView('historial')">Historial</button>
        <button class="hover:opacity-80" onclick="openConfig()">‚öôÔ∏è</button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-8">

    <!-- SERVICIOS -->
    <section id="view-servicios">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 bg-white rounded-2xl shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold" id="formTitle">Nuevo Servicio</h2>
            <button class="text-sm px-3 py-1 border rounded" onclick="resetForm()">Limpiar</button>
          </div>

          <form id="frm" class="space-y-4" onsubmit="saveService(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-medium">C√≥digo *</label>
                <input id="codigo" required class="w-full border rounded p-2" placeholder="SRV-001"/>
              </div>
              <div>
                <label class="text-sm font-medium">Proveedor *</label>
                <input id="proveedor" required class="w-full border rounded p-2" placeholder="Movistar"/>
              </div>
              <div class="md:col-span-2">
                <label class="text-sm font-medium">Servicio *</label>
                <input id="servicio" required class="w-full border rounded p-2" placeholder="Internet Fibra 100Mbps"/>
              </div>
              <div>
                <label class="text-sm font-medium">Categor√≠a</label>
                <select id="categoria" class="w-full border rounded p-2">
                  <option value="">Seleccionar...</option>
                  <option>Internet</option><option>Telefon√≠a</option><option>Software</option>
                  <option>Hosting</option><option>Energ√≠a</option><option>Otros</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-medium">Monto (S/)*</label>
                <input id="monto" type="number" step="0.01" required class="w-full border rounded p-2" placeholder="1200"/>
              </div>
              <div class="flex items-center gap-2 md:col-span-2">
                <input id="montoVariable" type="checkbox"/>
                <label class="text-sm">El monto var√≠a cada mes</label>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="text-sm font-medium">Fecha Servicio</label>
                <input id="fechaServicio" class="w-full border rounded p-2" placeholder="yyyy-mm-dd"/>
              </div>
              <div>
                <label class="text-sm font-medium">Fecha Vencimiento</label>
                <input id="fechaVencimiento" class="w-full border rounded p-2" placeholder="yyyy-mm-dd"/>
              </div>
              <div>
                <label class="text-sm font-medium">Fecha Pago</label>
                <input id="fechaPago" class="w-full border rounded p-2" placeholder="yyyy-mm-dd"/>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="text-sm font-medium">Estado *</label>
                <select id="estado" class="w-full border rounded p-2">
                  <option>PENDIENTE</option>
                  <option>FALTA PAGAR</option>
                  <option>PAGADO</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-medium">Medio de Pago</label>
                <select id="medioPago" class="w-full border rounded p-2">
                  <option value="">Seleccionar...</option>
                  <option>BCP</option><option>YAPE</option><option>PLIN</option>
                  <option>Efectivo</option><option>Transferencia</option><option>Tarjeta</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-medium">Cuenta</label>
                <input id="cuenta" class="w-full border rounded p-2" placeholder="Cuenta / N¬∫"/>
              </div>
            </div>

            <div>
              <label class="text-sm font-medium">Observaciones</label>
              <textarea id="observaciones" class="w-full border rounded p-2" rows="3"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="text-sm font-medium">Voucher (imagen/pdf)</label>
                <input id="voucher" type="file" accept="image/*,.pdf" class="w-full"/>
              </div>
              <div>
                <label class="text-sm font-medium">Recibo/Contrato/Otros (multi)</label>
                <input id="docs" type="file" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" class="w-full"/>
              </div>
            </div>

            <button class="w-full gradient-bg text-white font-semibold py-3 rounded-xl">
              Guardar Servicio (y Gastos si PAGADO)
            </button>
          </form>
        </div>

        <div class="space-y-6">
          <div class="bg-white rounded-2xl shadow p-6">
            <h3 class="font-bold mb-3">üìä Resumen</h3>
            <div class="text-sm flex justify-between"><span>Total</span><span id="kTotal">0</span></div>
            <div class="text-sm flex justify-between"><span>Pagados</span><span id="kPagados">0</span></div>
            <div class="text-sm flex justify-between"><span>Pendientes</span><span id="kPend">0</span></div>
            <div class="text-sm flex justify-between"><span>Falta pagar</span><span id="kFalta">0</span></div>
            <div class="mt-3 text-sm flex justify-between font-semibold">
              <span>Avance</span><span id="kAvance">0%</span>
            </div>
          </div>

          <div class="bg-white rounded-2xl shadow p-6">
            <h3 class="font-bold mb-3">üïí Recientes</h3>
            <div id="recientes" class="text-sm text-gray-600">Cargando...</div>
          </div>
        </div>
      </div>

      <div class="mt-8 bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <h3 class="font-bold text-lg">üìã Todos los servicios</h3>
          <div class="flex gap-3">
            <input id="q" class="border rounded p-2" placeholder="Buscar..." onkeyup="renderTable()"/>
            <select id="fEstado" class="border rounded p-2" onchange="renderTable()">
              <option value="">Todos</option>
              <option>PAGADO</option>
              <option>PENDIENTE</option>
              <option>FALTA PAGAR</option>
            </select>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left p-2">C√≥digo</th>
                <th class="text-left p-2">Proveedor</th>
                <th class="text-left p-2">Servicio</th>
                <th class="text-right p-2">Monto</th>
                <th class="text-left p-2">Estado</th>
                <th class="text-left p-2">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tb">
              <tr><td class="p-2" colspan="6">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="view-dashboard" class="hidden">
      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-xl font-bold mb-4">üìà Dashboard</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="border rounded-xl p-4">
            <canvas id="chartEstados"></canvas>
          </div>
          <div class="border rounded-xl p-4">
            <canvas id="chartMontos"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section id="view-historial" class="hidden">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">üßæ Historial</h2>
          <button class="px-3 py-2 border rounded" onclick="loadHistorial()">Actualizar</button>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left p-2">Fecha/Hora</th>
                <th class="text-left p-2">Acci√≥n</th>
                <th class="text-left p-2">C√≥digo</th>
                <th class="text-left p-2">Proveedor</th>
                <th class="text-left p-2">Servicio</th>
                <th class="text-right p-2">Monto</th>
                <th class="text-left p-2">Estado</th>
                <th class="text-left p-2">Voucher</th>
              </tr>
            </thead>
            <tbody id="tbHist">
              <tr><td class="p-2" colspan="8">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL CONFIG -->
  <div id="cfg" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
    <div class="bg-white w-full max-w-lg rounded-2xl p-6">
      <div class="flex justify-between items-center">
        <h3 class="font-bold text-lg">‚öôÔ∏è Configuraci√≥n</h3>
        <button onclick="closeConfig()">‚úñ</button>
      </div>
      <div class="mt-4 space-y-2">
        <label class="text-sm font-medium">URL del Web App (Apps Script)</label>
        <input id="webapp" class="w-full border rounded p-2" placeholder="https://script.google.com/macros/s/.../exec"/>
        <button class="w-full mt-3 gradient-bg text-white font-semibold py-2 rounded-xl" onclick="saveConfig()">
          Guardar
        </button>
        <p class="text-xs text-gray-500 mt-2">
          Nota: ya no necesitas API Key de Google Sheets.
        </p>
      </div>
    </div>
  </div>

<script>
  let WEB_APP_URL = localStorage.getItem('webAppUrl') || '';
  let servicios = [];
  let chartEstados = null;
  let chartMontos = null;

  flatpickr("#fechaServicio", { locale:"es", dateFormat:"Y-m-d" });
  flatpickr("#fechaVencimiento", { locale:"es", dateFormat:"Y-m-d" });
  flatpickr("#fechaPago", { locale:"es", dateFormat:"Y-m-d" });

  function showView(name){
    ['servicios','dashboard','historial'].forEach(v=>{
      document.getElementById('view-'+v).classList.toggle('hidden', v!==name);
    });
    if(name==='dashboard') renderDashboard();
    if(name==='historial') loadHistorial();
  }

  function openConfig(){
    document.getElementById('cfg').classList.remove('hidden');
    document.getElementById('cfg').classList.add('flex');
    document.getElementById('webapp').value = WEB_APP_URL;
  }
  function closeConfig(){
    document.getElementById('cfg').classList.add('hidden');
    document.getElementById('cfg').classList.remove('flex');
  }
  function saveConfig(){
    WEB_APP_URL = document.getElementById('webapp').value.trim();
    localStorage.setItem('webAppUrl', WEB_APP_URL);
    closeConfig();
    init();
  }

  async function apiGet(action){
    const url = `${WEB_APP_URL}?action=${encodeURIComponent(action)}`;
    const res = await fetch(url);
    return await res.json();
  }

  async function apiPost(action, data, filesPayload){
    const payload = { action, data, files: filesPayload || {} };
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  async function fileToBase64(f){
    const b64 = await new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result).split(',')[1]);
      r.onerror = reject;
      r.readAsDataURL(f);
    });
    return { name: f.name, mimeType: f.type || 'application/octet-stream', base64: b64 };
  }

  async function loadServicios(){
    const r = await apiGet('listServices');
    if(!r.ok) throw new Error(r.error || 'No se pudo cargar');
    servicios = r.rows.map(o=>({
      codigo: o['C√≥digo']||'',
      proveedor: o['Proveedor']||'',
      servicio: o['Servicio']||'',
      categoria: o['Categor√≠a']||'',
      monto: Number(o['Monto']||0),
      montoVariable: (String(o['Monto Variable']||'').toUpperCase()==='SI'),
      fechaServicio: o['Fecha Servicio']||'',
      fechaVencimiento: o['Fecha Vencimiento']||'',
      fechaPago: o['Fecha Pago']||'',
      estado: o['Estado']||'',
      medioPago: o['Medio Pago']||'',
      cuenta: o['Cuenta']||'',
      observaciones: o['Observaciones']||'',
      voucherUrl: o['Voucher URL']||'',
      docsUrl: o['Docs URL']||''
    }));
    renderKPIs();
    renderRecientes();
    renderTable();
  }

  async function loadStats(){
    const r = await apiGet('stats');
    if(!r.ok) return;
    document.getElementById('kTotal').textContent = r.total;
    document.getElementById('kPagados').textContent = r.pagados;
    document.getElementById('kPend').textContent = r.pendientes;
    document.getElementById('kFalta').textContent = r.falta;
    document.getElementById('kAvance').textContent = (r.avancePct||0) + '%';
  }

  function renderKPIs(){
    // KPIs principales vienen de stats
    loadStats();
  }

  function renderRecientes(){
    const rec = servicios.slice(-5).reverse();
    document.getElementById('recientes').innerHTML =
      rec.length
        ? rec.map(s=>`<div class="p-2 bg-gray-50 rounded mb-2">
            <div class="font-semibold">${s.proveedor}</div>
            <div class="text-xs text-gray-500">${s.servicio} - ${s.estado}</div>
          </div>`).join('')
        : '<div class="text-sm text-gray-500">Sin registros</div>';
  }

  function renderTable(){
    const q = (document.getElementById('q').value||'').toLowerCase();
    const f = (document.getElementById('fEstado').value||'').toUpperCase();
    const list = servicios.filter(s=>{
      const text = `${s.codigo} ${s.proveedor} ${s.servicio}`.toLowerCase();
      const okQ = !q || text.includes(q);
      const okF = !f || String(s.estado).toUpperCase()===f;
      return okQ && okF;
    });

    const tb = document.getElementById('tb');
    if(!list.length){
      tb.innerHTML = `<tr><td class="p-2" colspan="6">No hay servicios</td></tr>`;
      return;
    }
    tb.innerHTML = list.map(s=>`
      <tr class="border-t">
        <td class="p-2 font-mono text-purple-700">${s.codigo}</td>
        <td class="p-2">${s.proveedor}</td>
        <td class="p-2">${s.servicio}</td>
        <td class="p-2 text-right">S/ ${Number(s.monto||0).toFixed(2)}</td>
        <td class="p-2">${s.estado}</td>
        <td class="p-2">
          <button class="px-2 py-1 border rounded" onclick="edit('${s.codigo}')">Editar</button>
        </td>
      </tr>
    `).join('');
  }

  function edit(codigo){
    const s = servicios.find(x=>x.codigo===codigo);
    if(!s) return;
    document.getElementById('formTitle').textContent = 'Editar Servicio';
    codigoEl().value = s.codigo;
    proveedorEl().value = s.proveedor;
    servicioEl().value = s.servicio;
    categoriaEl().value = s.categoria;
    montoEl().value = s.monto;
    montoVariableEl().checked = !!s.montoVariable;
    fechaServicioEl().value = s.fechaServicio;
    fechaVencimientoEl().value = s.fechaVencimiento;
    fechaPagoEl().value = s.fechaPago;
    estadoEl().value = s.estado || 'PENDIENTE';
    medioPagoEl().value = s.medioPago;
    cuentaEl().value = s.cuenta;
    observacionesEl().value = s.observaciones;
    window.scrollTo({top:0,behavior:'smooth'});
    showView('servicios');
  }

  function resetForm(){
    document.getElementById('frm').reset();
    document.getElementById('formTitle').textContent = 'Nuevo Servicio';
  }

  async function saveService(ev){
    ev.preventDefault();
    if(!WEB_APP_URL){ openConfig(); return; }

    const data = {
      codigo: codigoEl().value.trim(),
      proveedor: proveedorEl().value.trim(),
      servicio: servicioEl().value.trim(),
      categoria: categoriaEl().value,
      monto: Number(montoEl().value||0),
      montoVariable: montoVariableEl().checked,
      fechaServicio: fechaServicioEl().value,
      fechaVencimiento: fechaVencimientoEl().value,
      fechaPago: fechaPagoEl().value,
      estado: estadoEl().value,
      medioPago: medioPagoEl().value,
      cuenta: cuentaEl().value,
      observaciones: observacionesEl().value
    };

    // archivos
    const voucherFile = document.getElementById('voucher').files[0];
    const docsFiles = Array.from(document.getElementById('docs').files || []);

    const filesPayload = {};
    if(voucherFile) filesPayload.voucher = [ await fileToBase64(voucherFile) ];
    if(docsFiles.length) filesPayload.docs = await Promise.all(docsFiles.map(fileToBase64));

    try{
      const r = await apiPost('upsertService', data, filesPayload);
      if(!r.ok) throw new Error(r.error || 'No guard√≥');
      alert('‚úÖ Guardado OK');
      resetForm();
      await loadServicios();
    }catch(err){
      console.error(err);
      alert('‚ùå Error: ' + err.message);
    }
  }

  async function loadHistorial(){
    if(!WEB_APP_URL) return;
    const tb = document.getElementById('tbHist');
    tb.innerHTML = `<tr><td class="p-2" colspan="8">Cargando...</td></tr>`;
    try{
      const r = await apiGet('listHistorial');
      if(!r.ok) throw new Error(r.error || 'No carga historial');
      tb.innerHTML = r.rows.map(o=>{
        const voucher = o['Voucher URL'] ? `<a class="text-blue-600 underline" href="${o['Voucher URL']}" target="_blank">Ver</a>` : '';
        return `
          <tr class="border-t">
            <td class="p-2">${o['Fecha/Hora Registro']||''}</td>
            <td class="p-2">${o['Acci√≥n']||''}</td>
            <td class="p-2 font-mono">${o['C√≥digo']||''}</td>
            <td class="p-2">${o['Proveedor']||''}</td>
            <td class="p-2">${o['Servicio']||''}</td>
            <td class="p-2 text-right">S/ ${Number(o['Monto']||0).toFixed(2)}</td>
            <td class="p-2">${o['Estado']||''}</td>
            <td class="p-2">${voucher}</td>
          </tr>
        `;
      }).join('') || `<tr><td class="p-2" colspan="8">Sin historial</td></tr>`;
    }catch(err){
      tb.innerHTML = `<tr><td class="p-2" colspan="8">‚ùå ${err.message}</td></tr>`;
    }
  }

  function renderDashboard(){
    const pagados = servicios.filter(s=>String(s.estado).toUpperCase()==='PAGADO');
    const pendientes = servicios.filter(s=>String(s.estado).toUpperCase()==='PENDIENTE');
    const falta = servicios.filter(s=>String(s.estado).toUpperCase()==='FALTA PAGAR');

    const totalMonto = servicios.reduce((a,s)=>a+Number(s.monto||0),0);
    const pagadoMonto = pagados.reduce((a,s)=>a+Number(s.monto||0),0);

    const ctx1 = document.getElementById('chartEstados');
    const ctx2 = document.getElementById('chartMontos');

    if(chartEstados) chartEstados.destroy();
    if(chartMontos) chartMontos.destroy();

    chartEstados = new Chart(ctx1, {
      type:'doughnut',
      data:{
        labels:['Pagado','Pendiente','Falta pagar'],
        datasets:[{ data:[pagados.length, pendientes.length, falta.length] }]
      }
    });

    chartMontos = new Chart(ctx2, {
      type:'bar',
      data:{
        labels:['Total','Pagado'],
        datasets:[{ data:[totalMonto, pagadoMonto] }]
      }
    });
  }

  function codigoEl(){ return document.getElementById('codigo'); }
  function proveedorEl(){ return document.getElementById('proveedor'); }
  function servicioEl(){ return document.getElementById('servicio'); }
  function categoriaEl(){ return document.getElementById('categoria'); }
  function montoEl(){ return document.getElementById('monto'); }
  function montoVariableEl(){ return document.getElementById('montoVariable'); }
  function fechaServicioEl(){ return document.getElementById('fechaServicio'); }
  function fechaVencimientoEl(){ return document.getElementById('fechaVencimiento'); }
  function fechaPagoEl(){ return document.getElementById('fechaPago'); }
  function estadoEl(){ return document.getElementById('estado'); }
  function medioPagoEl(){ return document.getElementById('medioPago'); }
  function cuentaEl(){ return document.getElementById('cuenta'); }
  function observacionesEl(){ return document.getElementById('observaciones'); }

  async function init(){
    if(!WEB_APP_URL){
      openConfig();
      return;
    }
    // ping r√°pido
    try{
      const r = await apiGet('ping');
      if(!r.ok) throw new Error(r.error||'No responde');
      await loadServicios();
    }catch(err){
      console.error(err);
      alert('‚ùå Tu Web App no responde. Revisa Deploy/Permisos/URL.\n' + err.message);
      openConfig();
    }
  }

  window.onload = init;
</script>
</body>
</html>
