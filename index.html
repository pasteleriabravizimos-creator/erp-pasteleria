<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BRAVIZIMOS ERP V2</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

<style>
/* ‚Äî‚Äî‚Äî estilos (no cambi√© nada aqu√≠) ‚Äî‚Äî‚Äî */
html,body{margin:0;padding:0;height:100%;font-family:'Inter',sans-serif;background:#0f172a;color:#e5e7eb}
.app{display:flex;min-height:100%}
.sidebar{width:250px;background:#020617;padding:1.5rem;display:flex;flex-direction:column}
.logo{font-size:1.3rem;font-weight:800;margin-bottom:2rem;color:#38bdf8;letter-spacing:.05em}
.nav-section{margin-bottom:1.5rem}
.nav-section-title{font-size:.75rem;color:#6b7280;text-transform:uppercase;margin-bottom:.5rem}
.nav-item{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;border-radius:.7rem;color:#9ca3af;cursor:pointer}
.nav-item i{width:18px;color:#6b7280}
.nav-item.active,.nav-item:hover{background:#0b1120;color:#fff}
.main{flex:1;padding:1.5rem}
header{display:flex;justify-content:space-between;align-items:center}
.page-header h1{margin:0;font-size:1.2rem}
.card{background:#020617;border:1px solid #1f2937;border-radius:.8rem;padding:1rem;margin-bottom:1rem}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
.stat-card{background:#020617;border:1px solid #1f2937;border-radius:.8rem;padding:1rem}
.stat-value{font-size:1.4rem;font-weight:700}
.chart-container{background:#020617;border:1px solid #1f2937;border-radius:.8rem;padding:1rem}
.table-container table{width:100%;border-collapse:collapse}
.table-container th,.table-container td{padding:.7rem;border-bottom:1px solid #1f2937}
.loader{display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column}
</style>
</head>

<body>
<div id="loader" class="loader">
<i class="fas fa-spinner fa-spin" style="font-size:2rem;color:#3b82f6"></i>
<p>Cargando BRAVIZIMOS ERP V2...</p>
</div>

<div class="app" id="app" style="display:none;">
<div class="sidebar">
<div class="logo">BRAVIZIMOS</div>

<div class="nav-section">
<div class="nav-section-title">General</div>
<div class="nav-item active" onclick="navigate('dashboard')"><i class="fas fa-chart-line"></i>Dashboard</div>
<div class="nav-item" onclick="navigate('ventas')"><i class="fas fa-shopping-cart"></i>Ventas / Pedidos</div>
<div class="nav-item" onclick="navigate('cotizaciones')"><i class="fas fa-file-invoice"></i>Cotizaciones</div>
<div class="nav-item" onclick="navigate('clientes')"><i class="fas fa-users"></i>Clientes</div>
<div class="nav-item" onclick="navigate('delivery')"><i class="fas fa-truck"></i>Delivery</div>
</div>

<div class="nav-section">
<div class="nav-section-title">Producci√≥n</div>
<div class="nav-item" onclick="navigate('productos')"><i class="fas fa-box"></i>Productos</div>
<div class="nav-item" onclick="navigate('inventario')"><i class="fas fa-warehouse"></i>Inventario</div>
<div class="nav-item" onclick="navigate('produccion')"><i class="fas fa-bread-slice"></i>Producci√≥n</div>
<div class="nav-item" onclick="navigate('recetas')"><i class="fas fa-utensils"></i>Recetas</div>
</div>
</div>

<div class="main">
<header>
<div class="page-header">
<h1>BRAVIZIMOS ERP V2</h1>
</div>
</header>

<div id="content"></div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* === API conectada === */
const API_URL = 'https://script.google.com/macros/s/AKfycbwM6jN82P7YEslJw1X-rW44w0mVmbx-86hJbaCVp-pACcGSAjFeeIYXwfoGHPxIRrq7/exec';

let DATA = {};

/* ============= Cargar datos ============= */
async function loadData() {
  try {
    const res = await fetch(API_URL + '?action=getAll');
    DATA = await res.json();

    document.getElementById("loader").style.display = "none";
    document.getElementById("app").style.display = "flex";

    navigate('dashboard');
  } catch(e) {
    alert("Error cargando datos: " + e);
  }
}

/* ============= Navegaci√≥n ============= */
function navigate(page) {
  document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
  const btn = [...document.querySelectorAll(".nav-item")].find(b => b.textContent.includes(page.charAt(0).toUpperCase()));
  if(btn) btn.classList.add("active");

  if(page === "dashboard") document.getElementById("content").innerHTML = renderDashboard();
}

/* ================= DASHBOARD ================= */

function renderDashboard() {
    const stats = DATA.estadisticas || {};
    const ventas = DATA.ventas || [];
    const alertas = [];
    
    const hoy = new Date();
    const ventasHoy = ventas.filter(v => {
        const f = new Date(v.fecharegistro || v.fecha);
        return f.toDateString() === hoy.toDateString();
    });
    const totalHoy = ventasHoy.reduce((s, v) => s + parseFloat(v.total || 0), 0);

    (DATA.insumos || []).forEach(i => {
        const stock = parseFloat(i.stockactual || i.stock || 0);
        const minimo = parseFloat(i.stockminimo || i.minimo || 0);
        if (stock <= minimo) {
            alertas.push({
                tipo: stock === 0 ? 'error' : 'warning',
                mensaje: `${stock === 0 ? 'Sin stock' : 'Stock bajo'}: ${i.nombreinsumo || i.nombre} (${stock})`
            });
        }
    });

    return `
        <div class="page-header">
            <div>
                <h1>Dashboard</h1>
                <p>Bienvenido a BRAVIZIMOS ERP V2</p>
            </div>
        </div>

        ${alertas.length ? `
            <div class="card">
                <h3 style="margin-bottom: 1rem;">üîî Alertas</h3>
                ${alertas.map(a => `
                    <div class="alert alert-${a.tipo}">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>${a.mensaje}</span>
                    </div>
                `).join('')}
            </div>` : ''}

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Ventas Hoy</div>
                <div class="stat-value">S/ ${totalHoy.toFixed(2)}</div>
                <div class="stat-change up">
                    <i class="fas fa-arrow-up"></i>
                    <span>${ventasHoy.length} pedidos</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Total Ventas</div>
                <div class="stat-value">S/ ${(stats.totalVentas || 0).toFixed(2)}</div>
                <div class="stat-change">
                    <i class="fas fa-shopping-cart"></i>
                    <span>${stats.cantidadVentas || 0} ventas</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Ticket Promedio</div>
                <div class="stat-value">S/ ${(stats.ticketPromedio || 0).toFixed(2)}</div>
                <div class="stat-change">
                    <i class="fas fa-chart-line"></i>
                    <span>Por venta</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Clientes</div>
                <div class="stat-value">${stats.totalClientes || 0}</div>
                <div class="stat-change">
                    <i class="fas fa-users"></i>
                    <span>Total registrados</span>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3 style="margin-bottom: 1rem;">üìà Ventas √öltimos 7 D√≠as</h3>
            <canvas id="chartVentas" style="max-height: 300px;"></canvas>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 1rem;">üèÜ Top 5 Productos</h3>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad (Stock)</th>
                        <th>Valor en Inventario</th>
                    </tr>
                </thead>
                <tbody>
                    ${(DATA.inventario || []).slice(0, 5).map(p => `
                        <tr>
                            <td>${p.nombreproducto || p.nombre || '-'}</td>
                            <td>${p.stockactual || 0}</td>
                            <td>S/ ${(parseFloat(p.precioventa || p.precio || 0) * parseFloat(p.stockactual || 0)).toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

/* ============ iniciar ============ */
loadData();
</script>
</body>
</html>
