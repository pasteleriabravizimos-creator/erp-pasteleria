<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BRAVIZIMO'S | Dashboard Financiero</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg1:#06121f; --bg2:#1a1230;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --text:#eaf2ff; --muted:rgba(234,242,255,.7);
      --ok:rgba(50,220,160,.16);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:radial-gradient(1200px 700px at 20% 20%, #0b2745 0%, transparent 50%),
                 radial-gradient(900px 600px at 80% 30%, #2a1747 0%, transparent 55%),
                 linear-gradient(120deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:34px 18px 60px;}
    .title{font-weight:800;letter-spacing:.2px}
    .sub{color:var(--muted);margin-top:4px;font-size:13px}
    .bar{
      margin-top:14px;padding:12px 14px;border-radius:12px;
      background:var(--ok);border:1px solid rgba(50,220,160,.25);
      color:#c7ffe9;font-weight:600;
    }
    .toprow{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:14px}
    .ctrl{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:10px 12px;border-radius:14px;background:var(--card);border:1px solid var(--stroke)
    }
    select,button{
      background:rgba(0,0,0,.25);color:var(--text);
      border:1px solid rgba(255,255,255,.15);
      border-radius:10px;padding:8px 10px;font-weight:600;
      outline:none;
    }
    button{cursor:pointer}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .tab{
      padding:8px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
      cursor:pointer;font-weight:700;font-size:13px;
    }
    .tab.active{background:rgba(255,255,255,.12)}
    .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:12px}
    .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
    @media (max-width:980px){.grid4{grid-template-columns:repeat(2,1fr)}.grid2{grid-template-columns:1fr}}
    .card{
      background:var(--card);border:1px solid var(--stroke);
      border-radius:18px;padding:14px; backdrop-filter: blur(10px);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .kpi-title{color:var(--muted);font-size:12px;font-weight:700}
    .kpi{font-size:24px;font-weight:900;margin-top:6px}
    .section{display:none}
    .section.active{display:block}
    .h{font-weight:900;margin:4px 0 2px}
    .p{color:var(--muted);font-size:12px;margin:0 0 10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px}
    th{color:var(--muted);text-align:left;font-weight:800}
    .right{text-align:right}
    .small{font-size:12px;color:var(--muted)}
    .err{background:rgba(255,70,70,.12);border:1px solid rgba(255,70,70,.25);color:#ffd4d4}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">BRAVIZIMO'S | Dashboard Financiero</div>
    <div class="sub">Sincronizado con Google Sheets (Apps Script)</div>

    <div id="status" class="bar">Cargando...</div>

    <div class="toprow">
      <div class="ctrl">
        <span class="small">Modo</span>
        <select id="mode">
          <option value="mes" selected>Mes</option>
          <option value="rango">Rango</option>
        </select>

        <span class="small">Mes</span>
        <select id="month"></select>

        <span class="small">A√±o</span>
        <select id="year"></select>

        <button id="btn">Actualizar</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="finanzas">Finanzas</div>
      <div class="tab" data-tab="delivery">Delivery</div>
      <div class="tab" data-tab="vendedoras">Vendedoras</div>
      <div class="tab" data-tab="productos">Productos</div>
      <div class="tab" data-tab="clientes">Clientes</div>
      <div class="tab" data-tab="gastos">Gastos</div>
      <div class="tab" data-tab="medios">Medios de pago</div>
      <div class="tab" data-tab="servicios">Servicios</div>
    </div>

    <!-- FINANZAS -->
    <div id="finanzas" class="section active">
      <div class="grid4">
        <div class="card"><div class="kpi-title">Ventas totales</div><div class="kpi" id="k_ventas">S/ 0.00</div></div>
        <div class="card"><div class="kpi-title">Gastos totales</div><div class="kpi" id="k_gastos">S/ 0.00</div></div>
        <div class="card"><div class="kpi-title">Utilidad</div><div class="kpi" id="k_utilidad">S/ 0.00</div></div>
        <div class="card"><div class="kpi-title">Saldo pendiente</div><div class="kpi" id="k_saldo">S/ 0.00</div></div>
      </div>

      <div class="grid4">
        <div class="card"><div class="kpi-title">Delivery cobrado</div><div class="kpi" id="k_del_cob">S/ 0.00</div></div>
        <div class="card"><div class="kpi-title">Costo delivery</div><div class="kpi" id="k_del_cos">S/ 0.00</div></div>
        <div class="card"><div class="kpi-title">Margen delivery</div><div class="kpi" id="k_del_mar">S/ 0.00</div></div>
        <div class="card"><div class="kpi-title">Clientes (total)</div><div class="kpi" id="k_cli">0</div></div>
      </div>

      <div class="grid4">
        <div class="card"><div class="kpi-title">Boletas / Facturas</div><div class="kpi" id="k_bf">0</div></div>
        <div class="card"><div class="kpi-title">Comprobantes faltantes</div><div class="kpi" id="k_cf">0</div></div>
        <div class="card"><div class="kpi-title">Promedio diario (hasta hoy)</div><div class="kpi" id="k_avg">S/ 0.00</div></div>
        <div class="card"><div class="kpi-title">Proyecci√≥n mensual (prom √ó 30)</div><div class="kpi" id="k_proj">S/ 0.00</div></div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="h">Ventas vs Gastos + Saldo (por d√≠a)</div>
          <div class="p">Ventas (nota de ventas), Gastos (GASTOS), Saldo pendiente (por pagar).</div>
          <canvas id="ch_fin"></canvas>
        </div>
        <div class="card">
          <div class="h">Acumulado de ventas</div>
          <div class="p">Suma progresiva por d√≠a.</div>
          <canvas id="ch_acum"></canvas>
        </div>
      </div>
    </div>

    <!-- DELIVERY -->
    <div id="delivery" class="section">
      <div class="grid2">
        <div class="card">
          <div class="h">Delivery por d√≠a</div>
          <div class="p">Cobrado vs costo vs diferencia (cobrado - costo).</div>
          <canvas id="ch_del"></canvas>
        </div>
        <div class="card">
          <div class="h">Recojo en tienda (por d√≠a)</div>
          <div class="p">Cantidad de recojos.</div>
          <canvas id="ch_rec"></canvas>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="h">Detalle delivery por d√≠a</div>
        <table>
          <thead><tr><th>Fecha</th><th class="right">Cobrado</th><th class="right">Costo</th><th class="right">Diferencia</th></tr></thead>
          <tbody id="tb_delivery"></tbody>
        </table>
      </div>
    </div>

    <!-- VENDEDORAS -->
    <div id="vendedoras" class="section">
      <div class="grid2">
        <div class="card">
          <div class="h">Resumen por vendedora (Top)</div>
          <div class="p">Monto y pedidos (nota de ventas).</div>
          <canvas id="ch_vtop"></canvas>
        </div>
        <div class="card">
          <div class="h">Vendedoras por d√≠a (ventas y saldo)</div>
          <div class="p">Detalle por fecha y vendedora.</div>
          <table>
            <thead><tr><th>Fecha</th><th>Vendedora</th><th class="right">Pedidos</th><th class="right">Monto</th><th class="right">Saldo</th></tr></thead>
            <tbody id="tb_vdia"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PRODUCTOS -->
    <div id="productos" class="section">
      <div class="card">
        <div class="h">Top productos (por cantidad acumulada)</div>
        <div class="p">Ordenado por cantidad (incluye monto si existe).</div>
        <table>
          <thead><tr><th>Producto</th><th class="right">Cantidad</th><th class="right">Monto</th></tr></thead>
          <tbody id="tb_topprod"></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="h">Productos por d√≠a (para saber qu√© preparar)</div>
        <div class="p">Agrupado por fecha y producto.</div>
        <table>
          <thead><tr><th>Fecha</th><th>Producto</th><th class="right">Cantidad</th></tr></thead>
          <tbody id="tb_proddia"></tbody>
        </table>
      </div>
    </div>

    <!-- CLIENTES -->
    <div id="clientes" class="section">
      <div class="card">
        <div class="h">Clientes del per√≠odo (hasta 200)</div>
        <div class="p">Ordenado por monto acumulado (desc). Incluye numeraci√≥n y cantidad de pedidos.</div>
        <table>
          <thead><tr><th>#</th><th>Cliente</th><th>Celular</th><th>√öltima compra</th><th class="right">Pedidos</th><th class="right">Monto</th></tr></thead>
          <tbody id="tb_clientes"></tbody>
        </table>
      </div>
    </div>

    <!-- GASTOS -->
    <div id="gastos" class="section">
      <div class="card">
        <div class="h">Gastos por categor√≠a</div>
        <div class="p">Se lee de hoja GASTOS (columna T.SOLES / Total).</div>
        <table>
          <thead><tr><th>Categor√≠a</th><th class="right">Registros</th><th class="right">Monto</th></tr></thead>
          <tbody id="tb_gcat"></tbody>
          <tfoot>
            <tr>
              <th colspan="2" class="right">TOTAL</th>
              <th class="right" id="gcat_total">S/ 0.00</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <!-- MEDIOS -->
    <div id="medios" class="section">
      <div class="card">
        <div class="h">Medios de pago (INGRESOS)</div>
        <div class="p">Suma de pagos registrados (1er Pago + 2do Pago) agrupado por cuenta destino.</div>
        <table>
          <thead><tr><th>Medio</th><th class="right">Registros</th><th class="right">Monto (ingresos)</th></tr></thead>
          <tbody id="tb_medios"></tbody>
        </table>
      </div>
    </div>

    <!-- SERVICIOS -->
    <div id="servicios" class="section">
      <div class="grid2">
        <div class="card">
          <div class="h">Servicios: Pagado vs Pendiente (por d√≠a)</div>
          <div class="p">Sumatoria por d√≠a seg√∫n estado.</div>
          <canvas id="ch_srv"></canvas>
        </div>
        <div class="card">
          <div class="h">Servicios (lista)</div>
          <div class="p">Tipo / Fecha / Monto / Estado / Medio / Obs.</div>
          <table>
            <thead><tr><th>Tipo</th><th>Fecha</th><th class="right">Monto</th><th>Estado</th><th>Medio</th><th>Obs</th></tr></thead>
            <tbody id="tb_srv"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script>
  // üëâ PON AQU√ç TU WEB APP URL (termina en /exec)
  const API_URL = "https://script.google.com/macros/s/AKfycbygNHtQPA-rmqpqChngcCuQMpQPO9NZSFQnabxH5-HwfhTgHEIU6zp5jbqxFOYyqdIM/exec";

  const $ = (id)=>document.getElementById(id);
  const fmt = (n)=>"S/ " + (Number(n||0).toFixed(2));
  const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

  // Fill selects
  const monthSel = $("month");
  months.forEach((m,i)=>{
    const opt=document.createElement("option");
    opt.value=String(i+1);
    opt.textContent=m;
    monthSel.appendChild(opt);
  });
  const yearSel = $("year");
  for(let y=2024;y<=2032;y++){
    const opt=document.createElement("option");
    opt.value=String(y);
    opt.textContent=String(y);
    yearSel.appendChild(opt);
  }
  // default hoy
  const now = new Date();
  monthSel.value = String(now.getMonth()+1);
  yearSel.value = String(now.getFullYear());

  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      t.classList.add("active");
      $(t.dataset.tab).classList.add("active");
    });
  });

  // Charts holders
  let CH = {};

  function destroyChart(id){
    if(CH[id]){ CH[id].destroy(); CH[id]=null; }
  }

  async function load(){
    $("status").classList.remove("err");
    $("status").textContent = "Cargando...";
    const mode = $("mode").value;
    const month = $("month").value;
    const year = $("year").value;

    const url = `${API_URL}?mode=${encodeURIComponent(mode)}&month=${encodeURIComponent(month)}&year=${encodeURIComponent(year)}`;
    const res = await fetch(url);
    const data = await res.json();

    if(!data.ok){
      $("status").classList.add("err");
      $("status").textContent = "ERROR: " + (data.error || "No se pudo cargar");
      return;
    }

    $("status").textContent = `OK: ${data.range.label}`;

    // KPIs
    $("k_ventas").textContent = fmt(data.metrics.ventasTotales);
    $("k_gastos").textContent = fmt(data.metrics.gastosTotales);
    $("k_utilidad").textContent = fmt(data.metrics.utilidad);
    $("k_saldo").textContent = fmt(data.metrics.saldoPendiente);

    $("k_del_cob").textContent = fmt(data.metrics.deliveryCobrado);
    $("k_del_cos").textContent = fmt(data.metrics.costoDelivery);
    $("k_del_mar").textContent = fmt(data.metrics.margenDelivery);

    $("k_cli").textContent = String(data.metrics.clientesTotal || 0);
    $("k_bf").textContent = String(data.metrics.boletasFacturas || 0);
    $("k_cf").textContent = String(data.metrics.comprobantesFaltantes || 0);

    // promedio y proyecci√≥n (seg√∫n d√≠as con ventas en el rango)
    const fin = data.charts.finanzasPorDia || [];
    const diasConVentas = fin.filter(x => Number(x.ventas||0) > 0).length || 0;
    const avg = diasConVentas ? (Number(data.metrics.ventasTotales||0) / diasConVentas) : 0;
    $("k_avg").textContent = fmt(avg);
    $("k_proj").textContent = fmt(avg * 30);

    // Chart Finanzas por d√≠a
    destroyChart("fin");
    const finLabels = fin.map(x=>x.date);
    CH.fin = new Chart($("ch_fin"), {
      type: "bar",
      data: {
        labels: finLabels,
        datasets: [
          { label:"Ventas", data: fin.map(x=>x.ventas) },
          { label:"Gastos", data: fin.map(x=>x.gastos) },
          { label:"Saldo Pendiente", type:"line", data: fin.map(x=>x.saldo) }
        ]
      },
      options: { responsive:true, maintainAspectRatio:false }
    });

    // Chart Acumulado
    destroyChart("acum");
    const acum = data.charts.acumuladoVentas || [];
    CH.acum = new Chart($("ch_acum"), {
      type:"line",
      data:{ labels: acum.map(x=>x.date), datasets:[ {label:"Ventas acumuladas", data: acum.map(x=>x.ventasAcum)} ] },
      options:{ responsive:true, maintainAspectRatio:false }
    });

    // Delivery charts + tabla
    const del = data.charts.deliveryPorDia || [];
    destroyChart("del");
    CH.del = new Chart($("ch_del"), {
      type:"bar",
      data:{
        labels: del.map(x=>x.date),
        datasets:[
          {label:"Cobrado", data: del.map(x=>x.cobrado)},
          {label:"Costo", data: del.map(x=>x.costo)},
          {label:"Diferencia", data: del.map(x=>x.diferencia)}
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false }
    });

    const rec = data.charts.recojoTiendaPorDia || [];
    destroyChart("rec");
    CH.rec = new Chart($("ch_rec"), {
      type:"line",
      data:{ labels: rec.map(x=>x.date), datasets:[{label:"Recojo (cant)", data: rec.map(x=>x.cant)}] },
      options:{ responsive:true, maintainAspectRatio:false }
    });

    renderTable($("tb_delivery"), data.tables.deliveryDetallePorDia || [], (r)=>`
      <tr>
        <td>${r.fecha}</td>
        <td class="right">${fmt(r.cobrado)}</td>
        <td class="right">${fmt(r.costo)}</td>
        <td class="right">${fmt(r.diferencia)}</td>
      </tr>
    `);

    // Vendedoras
    const vtop = data.charts.vendedorasTop || [];
    destroyChart("vtop");
    CH.vtop = new Chart($("ch_vtop"), {
      type:"bar",
      data:{
        labels: vtop.map(x=>x.vendedora),
        datasets:[
          {label:"Monto", data: vtop.map(x=>x.monto)},
          {label:"Pedidos", data: vtop.map(x=>x.pedidos)}
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false }
    });

    renderTable($("tb_vdia"), data.tables.vendedorasPorDia || [], (r)=>`
      <tr>
        <td>${r.fecha}</td>
        <td>${r.vendedora}</td>
        <td class="right">${r.pedidos}</td>
        <td class="right">${fmt(r.monto)}</td>
        <td class="right">${fmt(r.saldo)}</td>
      </tr>
    `);

    // Productos
    renderTable($("tb_topprod"), data.tables.topProductos || [], (r)=>`
      <tr>
        <td>${r.producto}</td>
        <td class="right">${Number(r.cantidad||0).toFixed(2)}</td>
        <td class="right">${fmt(r.monto)}</td>
      </tr>
    `);
    renderTable($("tb_proddia"), (data.tables.productosPorDia || []).slice(0,300), (r)=>`
      <tr>
        <td>${r.fecha}</td>
        <td>${r.producto}</td>
        <td class="right">${Number(r.cantidad||0).toFixed(2)}</td>
      </tr>
    `);

    // Clientes
    renderTable($("tb_clientes"), data.tables.clientesTop || [], (r)=>`
      <tr>
        <td>${r.n}</td>
        <td>${escapeHtml(r.cliente||"")}</td>
        <td>${escapeHtml(r.celular||"")}</td>
        <td>${r.ultimaCompra||""}</td>
        <td class="right">${r.pedidos||0}</td>
        <td class="right">${fmt(r.monto)}</td>
      </tr>
    `);

    // Gastos por categor√≠a + total
    const gcat = data.tables.gastosPorCategoria || {rows:[], total:0};
    renderTable($("tb_gcat"), gcat.rows || [], (r)=>`
      <tr>
        <td>${escapeHtml(r.categoria||"")}</td>
        <td class="right">${r.registros||0}</td>
        <td class="right">${fmt(r.monto)}</td>
      </tr>
    `);
    $("gcat_total").textContent = fmt(gcat.total || 0);

    // Medios de pago
    renderTable($("tb_medios"), data.tables.mediosPagoIngresos || [], (r)=>`
      <tr>
        <td>${escapeHtml(r.medio||"")}</td>
        <td class="right">${r.registros||0}</td>
        <td class="right">${fmt(r.monto)}</td>
      </tr>
    `);

    // Servicios
    const srv = data.charts.serviciosPagadoVsPendiente || [];
    destroyChart("srv");
    CH.srv = new Chart($("ch_srv"), {
      type:"bar",
      data:{
        labels: srv.map(x=>x.date),
        datasets:[
          {label:"Pagado", data: srv.map(x=>x.pagado)},
          {label:"Pendiente", data: srv.map(x=>x.pendiente)}
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false }
    });

    renderTable($("tb_srv"), (data.tables.serviciosLista || []).slice(0,200), (r)=>`
      <tr>
        <td>${escapeHtml(r.tipo||"")}</td>
        <td>${r.fecha||""}</td>
        <td class="right">${fmt(r.monto)}</td>
        <td>${escapeHtml(r.estado||"")}</td>
        <td>${escapeHtml(r.medio||"")}</td>
        <td>${escapeHtml(r.obs||"")}</td>
      </tr>
    `);
  }

  function renderTable(tbody, arr, rowTpl){
    if(!tbody) return;
    if(!arr || !arr.length){
      tbody.innerHTML = `<tr><td colspan="99" class="small">Sin registros.</td></tr>`;
      return;
    }
    tbody.innerHTML = arr.map(rowTpl).join("");
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  $("btn").addEventListener("click", load);
  load();
</script>
</body>
</html>
