<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BRAVIZIMO'S | Dashboard Financiero</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#ffffff;
      --muted:#6b7280;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
      --line:#e5e7eb;
    }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#f6f7fb; color:#0b0f17; }
    header{
      background:linear-gradient(135deg,#0b0f17,#111827);
      color:#fff;
      padding:22px 20px;
      position:sticky; top:0; z-index:10;
      box-shadow:0 8px 20px rgba(0,0,0,.2);
    }
    .wrap{ max-width:1200px; margin:0 auto; }
    .topbar{ display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .title{ font-size:18px; font-weight:800; letter-spacing:.2px; }
    .subtitle{ font-size:12px; color:#cbd5e1; margin-top:2px; }

    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    select, input, button{
      border-radius:12px; border:1px solid rgba(255,255,255,.2);
      padding:10px 12px; background:rgba(255,255,255,.06); color:#fff;
      outline:none;
    }
    button{ background:#fff; color:#0b0f17; font-weight:700; cursor:pointer; border:none; }
    button:hover{ opacity:.92; }

    main{ padding:18px 18px 40px; }
    .grid{ display:grid; grid-template-columns: repeat(4,1fr); gap:14px; }
    @media(max-width:1100px){ .grid{ grid-template-columns: repeat(2,1fr);} }
    @media(max-width:600px){ .grid{ grid-template-columns: 1fr;} }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      border:1px solid #f0f2f5;
    }
    .kpi-title{ font-size:12px; color:var(--muted); }
    .kpi-value{ font-size:22px; font-weight:900; margin-top:6px; }
    .kpi-sub{ font-size:12px; color:var(--muted); margin-top:4px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin:14px 0; }
    .tab{
      padding:8px 12px; border-radius:999px; border:1px solid var(--line);
      background:#fff; cursor:pointer; font-weight:700; font-size:12px;
    }
    .tab.active{ background:#0b0f17; color:#fff; border-color:#0b0f17; }

    .two{ display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; }
    @media(max-width:950px){ .two{ grid-template-columns:1fr; } }

    .chart{ height:360px; }
    .chart-sm{ height:320px; }

    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th, td{ padding:10px 8px; border-bottom:1px solid #eef0f3; text-align:left; }
    th{ color:#111827; background:#fafafa; position:sticky; top:0; z-index:1; }
    .scroll{ max-height:360px; overflow:auto; border:1px solid #eef0f3; border-radius:14px; }
    .status{ font-size:12px; color:#6b7280; margin-top:10px; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; background:#f1f5f9; font-size:12px; }
    .danger{ background:#fee2e2; color:#991b1b; font-weight:800; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">BRAVIZIMO'S | Dashboard Financiero</div>
        <div class="subtitle" id="sub">Sincronizado con Google Sheets</div>
      </div>

      <div class="controls">
        <span class="pill" id="periodPill">Periodo: —</span>

        <select id="monthSelect" title="Selecciona mes"></select>

        <button id="btnRefresh">Actualizar</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="err" class="status"></div>

  <!-- KPIs -->
  <div class="grid" id="kpis"></div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-view="finanzas">Finanzas</div>
    <div class="tab" data-view="distritos">Distritos</div>
    <div class="tab" data-view="vendedoras">Vendedoras</div>
    <div class="tab" data-view="delivery">Delivery</div>
    <div class="tab" data-view="productos">Productos</div>
    <div class="tab" data-view="clientes">Clientes</div>
    <div class="tab" data-view="gastos">Gastos</div>
    <div class="tab" data-view="pagos">Medios de pago</div>
  </div>

  <!-- FINANZAS -->
  <section id="view-finanzas">
    <div class="two">
      <div class="card">
        <h3>Ventas vs Gastos (por día) + Saldo</h3>
        <div class="chart" id="chartVGS"></div>
      </div>
      <div class="card">
        <h3>Acumulado de ventas</h3>
        <div class="chart" id="chartAcum"></div>
      </div>
    </div>
  </section>

  <!-- DISTRITOS -->
  <section id="view-distritos" style="display:none;">
    <div class="two">
      <div class="card">
        <h3>Ranking distritos (monto)</h3>
        <div class="chart-sm" id="chartDistritos"></div>
      </div>
      <div class="card">
        <h3>Detalle distritos (cantidad + monto)</h3>
        <div class="scroll">
          <table>
            <thead><tr><th>Distrito</th><th>Cantidad</th><th>Monto</th></tr></thead>
            <tbody id="tblDistritos"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- VENDEDORAS -->
  <section id="view-vendedoras" style="display:none;">
    <div class="card">
      <h3>Vendedoras por día (ventas, saldo y pedidos) + Total del periodo</h3>
      <div class="status" id="vendTotal"></div>
      <div class="scroll" style="max-height:420px;">
        <table>
          <thead><tr><th>Fecha</th><th>Vendedora</th><th>Ventas</th><th>Saldo</th><th>Pedidos</th></tr></thead>
          <tbody id="tblVendedoras"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- DELIVERY -->
  <section id="view-delivery" style="display:none;">
    <div class="two">
      <div class="card">
        <h3>Delivery vs Costo (por día) + Entregas</h3>
        <div class="chart-sm" id="chartDelivery"></div>
        <div class="status" id="recojoInfo"></div>
      </div>
      <div class="card">
        <h3>Personal delivery (por día) — “Lo que se le debe” (costo)</h3>
        <div class="scroll">
          <table>
            <thead><tr><th>Fecha</th><th>Nombre</th><th>Entregas</th><th>Costo</th></tr></thead>
            <tbody id="tblDeliveryPersonal"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- PRODUCTOS -->
  <section id="view-productos" style="display:none;">
    <div class="two">
      <div class="card">
        <h3>Top 20 productos por monto</h3>
        <div class="chart-sm" id="chartProdMonto"></div>
      </div>
      <div class="card">
        <h3>Top 20 productos por cantidad</h3>
        <div class="chart-sm" id="chartProdCant"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h3>Lista Top 20 (cantidad y monto)</h3>
      <div class="scroll" style="max-height:420px;">
        <table>
          <thead><tr><th>Producto</th><th>Cantidad</th><th>Monto</th></tr></thead>
          <tbody id="tblProductos"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CLIENTES -->
  <section id="view-clientes" style="display:none;">
    <div class="card">
      <h3>Clientes (nombre, celular, última compra)</h3>
      <div class="status" id="clientesCount"></div>
      <div class="scroll" style="max-height:420px;">
        <table>
          <thead><tr><th>Cliente</th><th>Celular</th><th>Última compra</th></tr></thead>
          <tbody id="tblClientes"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- GASTOS -->
  <section id="view-gastos" style="display:none;">
    <div class="two">
      <div class="card">
        <h3>Gastos por categoría</h3>
        <div class="chart-sm" id="chartGastosCat"></div>
      </div>
      <div class="card">
        <h3>Detalle (cantidad + monto)</h3>
        <div class="scroll">
          <table>
            <thead><tr><th>Categoría</th><th>Cantidad</th><th>Monto</th></tr></thead>
            <tbody id="tblGastosCat"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- PAGOS -->
  <section id="view-pagos" style="display:none;">
    <div class="two">
      <div class="card">
        <h3>Resumen por cuenta (1er pago + 2do pago)</h3>
        <div class="chart-sm" id="chartCuentas"></div>
      </div>
      <div class="card">
        <h3>Detalle por cuenta</h3>
        <div class="scroll">
          <table>
            <thead><tr><th>Cuenta</th><th>Monto</th></tr></thead>
            <tbody id="tblCuentas"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <div class="status" id="updated"></div>
</main>

<script>
  // ✅ Pega aquí tu URL /exec
  const APPS_SCRIPT_URL = "TU_URL_EXEC";

  google.charts.load("current", { packages: ["corechart"] });

  const $ = (id)=>document.getElementById(id);
  const money = (n)=> (Number(n||0)).toLocaleString("es-PE",{style:"currency",currency:"PEN"});
  const int = (n)=> (Number(n||0)).toLocaleString("es-PE");

  let state = { payload:null };

  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const cb = "CB_"+Math.random().toString(16).slice(2);
      window[cb] = (data)=>{ cleanup(); resolve(data); };

      const s = document.createElement("script");
      s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb + "&_=" + Date.now();
      s.onerror = ()=>{ cleanup(); reject(new Error("No se pudo cargar JSONP")); };
      document.body.appendChild(s);

      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        s.remove();
      }
    });
  }

  async function load(){
    $("err").textContent = "";
    const month = $("monthSelect").value || "";
    const url = `${APPS_SCRIPT_URL}?action=data&month=${encodeURIComponent(month)}`;

    const res = await jsonp(url);
    if(!res.ok){
      $("err").innerHTML = `<span class="pill danger">Error Apps Script:</span> ${res.error}`;
      return;
    }
    state.payload = res.payload;
    drawAll();
  }

  function drawAll(){
    const p = state.payload;
    if(!p) return;

    // header
    $("periodPill").textContent = `Periodo: ${p.meta.selectedPeriod.from} → ${p.meta.selectedPeriod.to}`;
    $("sub").textContent = `Sincronizado con Google Sheets (hoy: ${p.meta.today})`;

    // months
    fillMonths(p.meta.availableMonths, p.meta.selectedPeriod.month);

    // KPIs (incluye alerta comprobantes)
    renderKpis(p.kpis);

    // Charts
    google.charts.setOnLoadCallback(()=>{
      drawFinanzas(p.series);
      drawDistritos(p.tables.distritosRank);
      drawDelivery(p.series.deliveryDia);
      drawProductos(p.tables.top20ProdMonto, p.tables.top20ProdCant);
      drawGastos(p.tables.gastosPorCategoria);
      drawCuentas(p.tables.pagosPorCuenta);
    });

    // Tables
    renderVendedoras(p.tables.vendedorasPorDia);
    renderDeliveryPersonal(p.tables.deliveryPersonalDia);
    renderProductosTable(p.tables.top20ProdMonto);
    renderDistritosTable(p.tables.distritosRank);
    renderClientes(p.tables.clientesList, p.kpis.clientesTotalNotaVenta);
    renderGastosCatTable(p.tables.gastosPorCategoria);
    renderCuentasTable(p.tables.pagosPorCuenta);

    $("recojoInfo").textContent = `Recojo en tienda (sin delivery cobrado): ${int(p.kpis.recojoTienda)} entregas`;
    $("updated").textContent = `Actualizado: ${p.meta.generatedAt}`;
  }

  function fillMonths(months, selected){
    const sel = $("monthSelect");
    const current = sel.value;
    sel.innerHTML = "";
    const arr = (months||[]).slice().sort();
    if(arr.length===0){
      const opt = document.createElement("option");
      opt.value=""; opt.textContent="(sin meses)";
      sel.appendChild(opt);
      return;
    }
    for(const m of arr){
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      sel.appendChild(opt);
    }
    sel.value = selected || current || arr[arr.length-1];
  }

  function renderKpis(k){
    const items = [
      ["Ventas totales", money(k.totalVentas)],
      ["Gastos totales", money(k.totalGastos)],
      ["Utilidad", money(k.utilidad)],
      ["Saldo pendiente", money(k.saldoPendiente)],
      ["Delivery cobrado", money(k.deliveryCobrado)],
      ["Costo delivery", money(k.deliveryCosto)],
      ["Margen delivery", money(k.deliveryMargen)],
      ["Clientes (nota venta)", int(k.clientesTotalNotaVenta)],
      ["Promedio diario", money(k.promedioDiario)],
      ["Proyección mensual", money(k.proyeccionMensual)],
      ["Boletas / Facturas", `${int(k.comprobantes.boletas)} / ${int(k.comprobantes.facturas)}`],
      ["⚠️ Comprobantes faltantes", int(k.alertaComprobantesFaltan)],
    ];
    const box = $("kpis");
    box.innerHTML = "";
    for(const [t,v] of items){
      const d = document.createElement("div");
      d.className="card";
      d.innerHTML = `<div class="kpi-title">${t}</div><div class="kpi-value">${v}</div>`;
      box.appendChild(d);
    }
  }

  // FINANZAS
  function drawFinanzas(series){
    const vgs = series.ventasGastosSaldoDia || [];
    const dt = new google.visualization.DataTable();
    dt.addColumn("string","Fecha");
    dt.addColumn("number","Ventas");
    dt.addColumn("number","Gastos");
    dt.addColumn("number","Saldo");

    vgs.forEach(x=> dt.addRow([x.date, Number(x.ventas||0), Number(x.gastos||0), Number(x.saldo||0)]));

    new google.visualization.LineChart($("chartVGS"))
      .draw(dt, { legend:{position:"bottom"}, chartArea:{left:50, top:20, width:"85%", height:"70%"} });

    const acum = series.acumulado || [];
    const dt2 = new google.visualization.DataTable();
    dt2.addColumn("string","Fecha");
    dt2.addColumn("number","Acumulado");
    acum.forEach(x=> dt2.addRow([x.date, Number(x.acumulado||0)]));

    new google.visualization.LineChart($("chartAcum"))
      .draw(dt2, { legend:{position:"bottom"}, chartArea:{left:50, top:20, width:"85%", height:"70%"} });
  }

  // DISTRITOS
  function drawDistritos(rows){
    const top = (rows||[]).slice(0,10);
    const dt = new google.visualization.DataTable();
    dt.addColumn("string","Distrito");
    dt.addColumn("number","Monto");
    top.forEach(r=> dt.addRow([r.distrito, Number(r.monto||0)]));

    new google.visualization.BarChart($("chartDistritos"))
      .draw(dt, { legend:"none", chartArea:{left:140, top:20, width:"70%", height:"75%"} });
  }
  function renderDistritosTable(rows){
    const tb = $("tblDistritos"); tb.innerHTML="";
    (rows||[]).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.distrito}</td><td>${int(r.cantidad)}</td><td>${money(r.monto)}</td>`;
      tb.appendChild(tr);
    });
  }

  // VENDEDORAS
  function renderVendedoras(rows){
    const tb = $("tblVendedoras"); tb.innerHTML="";
    let totV=0, totS=0, totP=0;
    (rows||[]).forEach(r=>{
      totV += Number(r.ventas||0);
      totS += Number(r.saldo||0);
      totP += Number(r.pedidos||0);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.date}</td><td>${r.vendedor}</td><td>${money(r.ventas)}</td><td>${money(r.saldo)}</td><td>${int(r.pedidos)}</td>`;
      tb.appendChild(tr);
    });
    $("vendTotal").textContent = `Total periodo → Ventas: ${money(totV)} | Saldo: ${money(totS)} | Pedidos: ${int(totP)}`;
  }

  // DELIVERY
  function drawDelivery(series){
    const dt = new google.visualization.DataTable();
    dt.addColumn("string","Fecha");
    dt.addColumn("number","Delivery cobrado");
    dt.addColumn("number","Costo delivery");
    dt.addColumn("number","Entregas");

    (series||[]).forEach(x=>{
      dt.addRow([x.date, Number(x.delivery||0), Number(x.costo||0), Number(x.entregas||0)]);
    });

    new google.visualization.ColumnChart($("chartDelivery"))
      .draw(dt, { legend:{position:"bottom"}, chartArea:{left:50, top:20, width:"85%", height:"70%"} });
  }

  function renderDeliveryPersonal(rows){
    const tb = $("tblDeliveryPersonal"); tb.innerHTML="";
    (rows||[]).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.date}</td><td>${r.nombre}</td><td>${int(r.entregas)}</td><td>${money(r.costo)}</td>`;
      tb.appendChild(tr);
    });
  }

  // PRODUCTOS
  function drawProductos(topMonto, topCant){
    const dt1 = new google.visualization.DataTable();
    dt1.addColumn("string","Producto");
    dt1.addColumn("number","Monto");
    (topMonto||[]).forEach(r=> dt1.addRow([r.producto, Number(r.monto||0)]));
    new google.visualization.BarChart($("chartProdMonto"))
      .draw(dt1, { legend:"none", chartArea:{left:180, top:20, width:"65%", height:"75%"} });

    const dt2 = new google.visualization.DataTable();
    dt2.addColumn("string","Producto");
    dt2.addColumn("number","Cantidad");
    (topCant||[]).forEach(r=> dt2.addRow([r.producto, Number(r.cantidad||0)]));
    new google.visualization.BarChart($("chartProdCant"))
      .draw(dt2, { legend:"none", chartArea:{left:180, top:20, width:"65%", height:"75%"} });
  }

  function renderProductosTable(topMonto){
    const tb = $("tblProductos"); tb.innerHTML="";
    (topMonto||[]).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.producto}</td><td>${int(r.cantidad)}</td><td>${money(r.monto)}</td>`;
      tb.appendChild(tr);
    });
  }

  // CLIENTES
  function renderClientes(list, totalNotaVenta){
    const tb = $("tblClientes"); tb.innerHTML="";
    const rows = (list||[]).slice(0,2000);
    $("clientesCount").textContent = `Clientes en hoja clientes (mostrando ${rows.length}). Clientes únicos según Nota de ventas en este periodo: ${int(totalNotaVenta)}.`;
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.cliente}</td><td>${r.celular||""}</td><td>${r.ultimaCompra||""}</td>`;
      tb.appendChild(tr);
    });
  }

  // GASTOS
  function drawGastos(rows){
    const top = (rows||[]).slice(0,10);
    const dt = new google.visualization.DataTable();
    dt.addColumn("string","Categoría");
    dt.addColumn("number","Monto");
    top.forEach(r=> dt.addRow([r.categoria, Number(r.monto||0)]));
    new google.visualization.PieChart($("chartGastosCat"))
      .draw(dt, { legend:{position:"right"}, chartArea:{left:20, top:10, width:"80%", height:"80%"} });
  }

  function renderGastosCatTable(rows){
    const tb = $("tblGastosCat"); tb.innerHTML="";
    (rows||[]).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.categoria}</td><td>${int(r.cantidad)}</td><td>${money(r.monto)}</td>`;
      tb.appendChild(tr);
    });
  }

  // CUENTAS
  function drawCuentas(rows){
    const top = (rows||[]).slice(0,10);
    const dt = new google.visualization.DataTable();
    dt.addColumn("string","Cuenta");
    dt.addColumn("number","Monto");
    top.forEach(r=> dt.addRow([r.cuenta, Number(r.monto||0)]));
    new google.visualization.BarChart($("chartCuentas"))
      .draw(dt, { legend:"none", chartArea:{left:180, top:20, width:"65%", height:"75%"} });
  }
  function renderCuentasTable(rows){
    const tb = $("tblCuentas"); tb.innerHTML="";
    (rows||[]).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.cuenta}</td><td>${money(r.monto)}</td>`;
      tb.appendChild(tr);
    });
  }

  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const view = t.dataset.view;
      document.querySelectorAll("section[id^='view-']").forEach(s=>s.style.display="none");
      $("view-"+view).style.display = "block";
    });
  });

  $("btnRefresh").addEventListener("click", load);
  $("monthSelect").addEventListener("change", load);

  // init
  (async function init(){
    try{
      // carga inicial sin month para que el script devuelva availableMonths, luego load() usará el select
      const res = await jsonp(`${APPS_SCRIPT_URL}?action=data`);
      if(!res.ok){ $("err").textContent = res.error; return; }
      state.payload = res.payload;
      fillMonths(state.payload.meta.availableMonths, state.payload.meta.selectedPeriod.month);
      await load();
    }catch(e){
      $("err").textContent = "No se pudo cargar desde Apps Script: " + e.message;
    }
  })();
</script>
</body>
</html>
