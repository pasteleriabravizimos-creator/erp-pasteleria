<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BRAVIZIMO'S | Dashboard Financiero</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg1:#0b1020; --bg2:#120a2b;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.65);
      --line:rgba(255,255,255,.10);
      --ok:#24d17e; --warn:#ffd34d; --bad:#ff4d6d;
      --btn:rgba(255,255,255,.10);
      --btn2:rgba(255,255,255,.16);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:radial-gradient(1200px 700px at 30% 10%, #21325c 0%, rgba(33,50,92,0) 60%),
                 radial-gradient(900px 600px at 70% 20%, #4b1b74 0%, rgba(75,27,116,0) 60%),
                 linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px; margin:30px auto; padding:0 16px}
    .title{font-weight:800; letter-spacing:.4px}
    .sub{color:var(--mut); margin-top:2px; font-size:13px}
    .bar{
      margin-top:14px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius:14px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.18);
    }
    .badge.ok{border-color:rgba(36,209,126,.35)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select, input, button{
      color:var(--txt);
      background:var(--btn);
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      outline:none;
    }
    button{cursor:pointer}
    button:hover{background:var(--btn2)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{background:rgba(255,255,255,.14)}
    .grid{
      margin-top:12px;
      display:grid; gap:12px;
      grid-template-columns:repeat(4,1fr);
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius:16px;
      padding:12px;
      overflow:hidden;
    }
    .k{font-size:12px; color:var(--mut)}
    .bigNumber{font-size:22px; font-weight:800; margin-top:4px}
    .span2{grid-column:span 2}
    .span4{grid-column:span 4}
    .chartBox{height:300px}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:6px}
    .pillRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
      background:rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:8px}
    .dot.bad{background:var(--bad)}
    .dot.warn{background:var(--warn)}
    .dot.ok{background:var(--ok)}
    table{width:100%; border-collapse:collapse; font-size:12px}
    th,td{padding:8px 8px; border-bottom:1px solid var(--line); text-align:left}
    th{color:var(--mut); font-weight:700}
    .mut{color:var(--mut)}
    @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr} .span2,.span4{grid-column:span 1} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">BRAVIZIMO'S | Dashboard Financiero</div>
    <div class="sub">Sincronizado con Google Sheets (Apps Script)</div>

    <div class="bar">
      <div id="status" class="badge">Cargando...</div>

      <div class="row">
        <span class="mut" style="font-size:12px;">Modo</span>
        <select id="mode">
          <option value="month" selected>Mes</option>
          <option value="range">Rango</option>
        </select>

        <span class="mut" style="font-size:12px;">Mes</span>
        <select id="month"></select>

        <span class="mut" style="font-size:12px;">Año</span>
        <select id="year"></select>

        <button id="btnUpdate">Actualizar</button>
        <button id="btnPing">Probar API</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="finanzas">Finanzas</div>
      <div class="tab" data-tab="delivery">Delivery</div>
      <div class="tab" data-tab="clientes">Clientes</div>
      <div class="tab" data-tab="gastos">Gastos</div>
      <div class="tab" data-tab="servicios">Servicios</div>
    </div>

    <div id="view"></div>
  </div>

<script>
/** ========= CONFIG ========= **/
const API_URL = "https://script.google.com/macros/s/AKfycbw2YcPLQXZjLdgm5CTAoCQMycfanKca29JaX60UEYR5EEq1D1kle3IaTBTxflVAdMwL/exec";
/** ========================== **/

let currentTab = "finanzas";
let lastData = null;
let charts = {};

/** Utils **/
const money = (n)=> "S/ " + (Number(n||0).toLocaleString("es-PE",{minimumFractionDigits:2, maximumFractionDigits:2}));
const esc = (s)=> String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
const setStatus = (txt, ok=null)=>{
  const el=document.getElementById("status");
  el.textContent = txt;
  el.className = "badge" + (ok===true ? " ok" : "");
};

function destroyChart(id){
  if(charts[id]){ charts[id].destroy(); delete charts[id]; }
}

/** Dropdowns **/
(function initFilters(){
  const monthSel=document.getElementById("month");
  const yearSel=document.getElementById("year");
  const months=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  months.forEach((m,i)=>{
    const o=document.createElement("option");
    o.value=String(i+1);
    o.textContent=m;
    monthSel.appendChild(o);
  });
  const now=new Date();
  monthSel.value=String(now.getMonth()+1);

  const y0=now.getFullYear()-3;
  for(let y=y0;y<=now.getFullYear()+1;y++){
    const o=document.createElement("option");
    o.value=String(y);
    o.textContent=String(y);
    yearSel.appendChild(o);
  }
  yearSel.value=String(now.getFullYear());
})();

/** Tabs **/
document.getElementById("tabs").addEventListener("click",(e)=>{
  const t=e.target.closest(".tab");
  if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  currentTab = t.dataset.tab;
  if(lastData) renderAll(lastData);
});

/** Buttons **/
document.getElementById("btnPing").addEventListener("click", async ()=>{
  setStatus("Probando API...");
  const url = API_URL + "?action=ping&callback=?";
  try{
    const res = await jsonp(url);
    if(res.ok) setStatus("OK ✅ " + (res.now || ""), true);
    else setStatus("ERROR: " + (res.error || "ping"));
  }catch(err){
    setStatus("ERROR: " + err.message);
  }
});

document.getElementById("btnUpdate").addEventListener("click", ()=> loadData());

/** JSONP loader **/
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const s = document.createElement("script");
    const timer = setTimeout(()=>{
      cleanup();
      reject(new Error("Timeout"));
    }, 20000);

    function cleanup(){
      clearTimeout(timer);
      delete window[cb];
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{
      cleanup();
      resolve(data);
    };

    s.onerror = ()=>{
      cleanup();
      reject(new Error("Error cargando JSONP"));
    };

    s.src = url.replace("callback=?", "callback="+cb);
    document.body.appendChild(s);
  });
}

/** Load **/
async function loadData(){
  setStatus("Cargando...");
  const mode = document.getElementById("mode").value;
  const month = document.getElementById("month").value;
  const year = document.getElementById("year").value;

  const url = API_URL + `?action=dashboard&mode=${encodeURIComponent(mode)}&month=${encodeURIComponent(month)}&year=${encodeURIComponent(year)}&callback=?`;

  try{
    const data = await jsonp(url);
    if(!data.ok) throw new Error(data.error || "Error API");
    lastData = data;
    setStatus("OK ✅ Actualizado", true);
    renderAll(data);
  }catch(err){
    setStatus("ERROR: " + err.message);
    document.getElementById("view").innerHTML = "";
  }
}

/** Render wrapper **/
function renderAll(data){
  // limpiar charts viejos por vista
  ["ch_fin1","ch_fin2","ch_g1","ch_d1"].forEach(destroyChart);

  if(currentTab === "finanzas") renderFinanzas(data);
  else if(currentTab === "gastos") renderGastos(data);
  else if(currentTab === "delivery") renderDelivery(data);
  else if(currentTab === "clientes") renderClientes(data);
  else if(currentTab === "servicios") renderServicios(data);
}

/** FINANZAS **/
function renderFinanzas(data){
  const k = data.kpis || {};
  const ch = data.charts || {};
  const b = data.breakdowns || {};

  const html = `
    <div class="grid">
      <div class="card"><div class="k">Ventas totales</div><div class="bigNumber">${money(k.ventasTotal)}</div></div>
      <div class="card"><div class="k">Gastos totales</div><div class="bigNumber">${money(k.gastosTotal)}</div></div>
      <div class="card"><div class="k">Utilidad</div><div class="bigNumber">${money(k.utilidad)}</div></div>
      <div class="card"><div class="k">Saldo pendiente</div><div class="bigNumber">${money(k.saldoPendiente)}</div></div>

      <div class="card"><div class="k">Delivery cobrado</div><div class="bigNumber">${money(k.deliveryCobrado)}</div></div>
      <div class="card"><div class="k">Costo delivery</div><div class="bigNumber">${money(k.costoDelivery)}</div></div>
      <div class="card"><div class="k">Margen delivery</div><div class="bigNumber">${money(k.margenDelivery)}</div></div>
      <div class="card"><div class="k">Clientes (período)</div><div class="bigNumber">${(k.clientesTotalPeriodo||0)}</div></div>

      <div class="card"><div class="k">Boletas / Facturas</div><div class="bigNumber">${(k.boletasFacturas||0)}</div></div>
      <div class="card"><div class="k">Comprobantes faltantes</div><div class="bigNumber">${(k.comprobantesFaltantes||0)}</div></div>
      <div class="card"><div class="k">Promedio diario (ventas / días con ventas)</div><div class="bigNumber">${money(k.promedioDiario)}</div></div>
      <div class="card"><div class="k">Proyección mensual (prom × 30)</div><div class="bigNumber">${money(k.proyeccionMensual)}</div></div>

      <div class="card span2">
        <div class="k" style="margin-bottom:6px;">Ventas vs Gastos (por día)</div>
        <div class="chartBox"><canvas id="ch_fin1"></canvas></div>
      </div>

      <div class="card span2">
        <div class="k" style="margin-bottom:6px;">Acumulado de ventas</div>
        <div class="chartBox"><canvas id="ch_fin2"></canvas></div>
      </div>

      <div class="card span2">
        <div class="k">Top Gastos por categoría</div>
        <div class="list">
          ${(b.gastosPorCategoria||[]).slice(0,10).map(x=>`
            <div class="pillRow"><b>${esc(x.name)}</b><span>${money(x.total)}</span></div>
          `).join("")}
        </div>
      </div>

      <div class="card span2">
        <div class="k">Recojos en tienda (período)</div>
        <div class="bigNumber">${(k.recojoCount||0)}</div>
        <div class="mut" style="font-size:12px;margin-top:6px;">Se cuenta cuando Costo Delivery es “-”.</div>
      </div>
    </div>
  `;
  document.getElementById("view").innerHTML = html;

  // charts
  const vsg = ch.ventasVsGastos || { labels:[], ventas:[], gastos:[] };
  charts["ch_fin1"] = new Chart(document.getElementById("ch_fin1"),{
    type:"line",
    data:{
      labels:vsg.labels,
      datasets:[
        {label:"Ventas", data:vsg.ventas, tension:.25},
        {label:"Gastos", data:vsg.gastos, tension:.25}
      ]
    },
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:"#fff"}}}, scales:{x:{ticks:{color:"#bbb"}}, y:{ticks:{color:"#bbb"}}}}
  });

  const acc = ch.acumuladoVentas || { labels:[], values:[] };
  charts["ch_fin2"] = new Chart(document.getElementById("ch_fin2"),{
    type:"line",
    data:{ labels:acc.labels, datasets:[{label:"Acumulado", data:acc.values, tension:.25}] },
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:"#fff"}}}, scales:{x:{ticks:{color:"#bbb"}}, y:{ticks:{color:"#bbb"}}}}
  });
}

/** GASTOS **/
function renderGastos(data){
  const mod = data.modules?.gastos || {};
  const top = mod.topCategorias || [];
  const per = mod.porDia || { labels:[], total:[] };

  const html = `
    <div class="grid">
      <div class="card span2">
        <div class="k" style="margin-bottom:6px;">Gastos por día</div>
        <div class="chartBox"><canvas id="ch_g1"></canvas></div>
      </div>

      <div class="card span2">
        <div class="k">Top categorías (monto)</div>
        <div class="list">
          ${top.slice(0,12).map(x=>`
            <div class="pillRow"><b>${esc(x.name)}</b><span>${money(x.total)}</span></div>
          `).join("")}
        </div>

        <div class="card" style="margin-top:12px">
          <div class="k">Total gastos (acumulado)</div>
          <div class="bigNumber">${money(mod.totalAcumulado||0)}</div>
        </div>
      </div>
    </div>
  `;
  document.getElementById("view").innerHTML = html;

  charts["ch_g1"] = new Chart(document.getElementById("ch_g1"),{
    type:"line",
    data:{ labels:per.labels, datasets:[{label:"Gastos", data:per.total, tension:.25}] },
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:"#fff"}}}, scales:{x:{ticks:{color:"#bbb"}}, y:{ticks:{color:"#bbb"}}}}
  });
}

/** DELIVERY **/
function renderDelivery(data){
  const mod = data.modules?.delivery || {};
  const per = mod.porDia || { labels:[], cobrado:[], costo:[], diferencia:[], recojoSeries:[] };
  const top = mod.top || [];
  const recojos = data.kpis?.recojoCount || 0;

  const html = `
    <div class="grid">
      <div class="card span2">
        <div class="k" style="margin-bottom:6px;">Delivery (Cobrado vs Costo) por día</div>
        <div class="mut" style="font-size:12px;margin-bottom:8px;">Diferencia = Delivery cliente - Costo delivery. Si costo es “-” es recojo (costo 0).</div>
        <div class="chartBox"><canvas id="ch_d1"></canvas></div>
      </div>

      <div class="card span2">
        <div class="k">Top delivery (por diferencia)</div>
        <div class="list">
          ${top.slice(0,12).map(x=>`
            <div class="pillRow">
              <b>${esc(x.name)}</b>
              <span>${money(x.diferencia)} <span class="mut">(Cob: ${money(x.cobrado)} | Cos: ${money(x.costo)})</span></span>
            </div>
          `).join("")}
        </div>

        <div class="card" style="margin-top:12px">
          <div class="k">Recojos en tienda (período)</div>
          <div class="bigNumber">${recojos}</div>
        </div>
      </div>
    </div>
  `;
  document.getElementById("view").innerHTML = html;

  charts["ch_d1"] = new Chart(document.getElementById("ch_d1"),{
    type:"line",
    data:{
      labels:per.labels,
      datasets:[
        {label:"Cobrado", data:per.cobrado, tension:.25},
        {label:"Costo", data:per.costo, tension:.25},
        {label:"Diferencia", data:per.diferencia, tension:.25},
      ]
    },
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:"#fff"}}}, scales:{x:{ticks:{color:"#bbb"}}, y:{ticks:{color:"#bbb"}}}}
  });
}

/** CLIENTES **/
function renderClientes(data){
  const list = data.modules?.clientes?.top || [];
  const html = `
    <div class="grid">
      <div class="card span4">
        <div class="k">Clientes del período (hasta 200)</div>
        <div style="overflow:auto; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Cliente</th>
                <th>Celular</th>
                <th>Última compra</th>
              </tr>
            </thead>
            <tbody>
              ${list.map((x,i)=>`
                <tr>
                  <td>${i+1}</td>
                  <td><b>${esc(x.cliente)}</b></td>
                  <td>${esc(x.celular||"")}</td>
                  <td>${esc(x.ultimaCompra||"")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  document.getElementById("view").innerHTML = html;
}

/** SERVICIOS **/
function renderServicios(data){
  const a = data.modules?.servicios?.alertas || {};
  const p = data.modules?.servicios?.pendientes || [];
  const html = `
    <div class="grid">
      <div class="card span2">
        <div class="k">Resumen alertas (PENDIENTE)</div>
        <div class="list" style="margin-top:10px;">
          <div class="pillRow"><span><span class="dot bad"></span><b>Vencidos</b></span><span>${a.vencidos?.count||0} | ${money(a.vencidos?.total||0)}</span></div>
          <div class="pillRow"><span><span class="dot warn"></span><b>Hoy</b></span><span>${a.hoy?.count||0} | ${money(a.hoy?.total||0)}</span></div>
          <div class="pillRow"><span><span class="dot ok"></span><b>Próximos</b></span><span>${a.proximos?.count||0} | ${money(a.proximos?.total||0)}</span></div>
        </div>
      </div>

      <div class="card span2">
        <div class="k">Pendientes (detalle)</div>
        <div style="overflow:auto; margin-top:10px; max-height:420px;">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Monto</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              ${p.map(x=>`
                <tr>
                  <td>${esc(x.fecha)}</td>
                  <td>${esc(x.tipo||"")}</td>
                  <td><b>${esc(x.descripcion||"")}</b></td>
                  <td>${money(x.monto||0)}</td>
                  <td>${esc(x.estado||"")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div class="mut" style="font-size:12px;margin-top:8px;">*Se usa DESCRIPCION de la hoja “servicios”.</div>
      </div>
    </div>
  `;
  document.getElementById("view").innerHTML = html;
}

/** Auto-load **/
loadData();
</script>
</body>
</html>
