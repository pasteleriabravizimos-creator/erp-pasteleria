<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial, sans-serif; margin:16px; background:#fafafa;}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px;}
    .card{background:#fff; border:1px solid #ddd; border-radius:12px; padding:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap;}
    label{font-size:12px; color:#333; display:block; margin-bottom:4px;}
    input, select, textarea{padding:10px; border:1px solid #ccc; border-radius:10px; width:100%;}
    textarea{min-height:70px;}
    button{padding:10px 14px; border:0; border-radius:10px; cursor:pointer;}
    .btn{background:#111; color:#fff;}
    .btn2{background:#e9e9e9;}
    .btnDanger{background:#c62828; color:#fff;}
    table{width:100%; border-collapse:collapse;}
    th,td{border-bottom:1px solid #eee; padding:8px; font-size:13px; text-align:left;}
    th{background:#f6f6f6;}
    .kpi{font-size:22px; font-weight:700;}
    .muted{color:#666; font-size:12px;}
    .pill{padding:4px 8px; border-radius:999px; font-size:12px; display:inline-block;}
    .pPaid{background:#d7ffd9;}
    .pPend{background:#fff3cd;}
    .pDue{background:#ffd7d7;}
  </style>
</head>
<body>
  <h2>Panel Servicios</h2>
  <div class="muted">Registra, edita, paga, adjunta voucher/recibo/contrato y se guarda historial + gastos + backup en Sheets.</div>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h3>INDEX - Servicio</h3>
      <input type="hidden" id="id">

      <div class="row">
        <div style="flex:1; min-width:220px;">
          <label>Proveedor</label>
          <input id="proveedor" placeholder="Ej: CALIDDA">
        </div>
        <div style="flex:1; min-width:220px;">
          <label>Servicio</label>
          <input id="servicio" placeholder="Ej: Gas">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1; min-width:180px;">
          <label>Código</label>
          <input id="codigo" placeholder="Opcional">
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Categoría</label>
          <select id="categoria">
            <option value="SERVICIOS">SERVICIOS</option>
            <option value="ALQUILER">ALQUILER</option>
            <option value="PLANILLA">PLANILLA</option>
            <option value="INSUMOS">INSUMOS</option>
            <option value="MARKETING">MARKETING</option>
            <option value="TRANSPORTE">TRANSPORTE</option>
            <option value="OTROS">OTROS</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1; min-width:180px;">
          <label>Fecha servicio (vencimiento)</label>
          <input type="date" id="fecha_servicio">
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Monto</label>
          <input type="number" step="0.01" id="monto" placeholder="0.00">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1; min-width:180px;">
          <label>Estado</label>
          <select id="estado">
            <option>FALTA PAGAR</option>
            <option>PENDIENTE</option>
            <option>PAGADO</option>
          </select>
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Medio de pago</label>
          <select id="medio_pago">
            <option value="">--</option>
            <option>BCP</option>
            <option>YAPE</option>
            <option>PLIN</option>
            <option>EFECTIVO</option>
            <option>TRANSFERENCIA</option>
            <option>OTRO</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1; min-width:180px;">
          <label>Cuenta / Banco</label>
          <input id="cuenta" placeholder="Ej: BCP Bravizimos / Yape ...">
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Notas</label>
          <input id="notas" placeholder="Opcional">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="saveService()">Guardar / Actualizar</button>
        <button class="btn2" onclick="clearForm()">Nuevo</button>
        <button class="btnDanger" onclick="removeService()">Eliminar</button>
      </div>

      <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

      <h4>Pagar (crea historial + gasto)</h4>
      <div class="row">
        <div style="flex:1; min-width:180px;">
          <label>Fecha pago</label>
          <input type="date" id="p_fecha_pago">
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Monto pagado</label>
          <input type="number" step="0.01" id="p_monto_pagado" placeholder="0.00">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1; min-width:180px;">
          <label>Medio pago</label>
          <select id="p_medio_pago">
            <option>BCP</option>
            <option>YAPE</option>
            <option>PLIN</option>
            <option>EFECTIVO</option>
            <option>TRANSFERENCIA</option>
            <option>OTRO</option>
          </select>
        </div>
        <div style="flex:1; min-width:180px;">
          <label>Cuenta</label>
          <input id="p_cuenta" placeholder="Ej: BCP Bravizimos">
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Observación</label>
        <input id="p_observacion" placeholder="Ej: pago completo / parcial">
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" onclick="payService()">Marcar como Pagado</button>
        <button class="btn2" onclick="loadHistory()">Ver historial</button>
      </div>

      <div style="margin-top:12px;">
        <h4>Adjuntos a Drive</h4>
        <div class="muted">Sube voucher/recibo/contrato/otros. Se guarda en Drive y se registra el link.</div>
        <div class="row" style="margin-top:8px;">
          <select id="a_tipo">
            <option value="VOUCHER">VOUCHER</option>
            <option value="RECIBO">RECIBO</option>
            <option value="CONTRATO">CONTRATO</option>
            <option value="OTRO">OTRO</option>
          </select>
          <input type="file" id="a_file">
          <button class="btn2" onclick="uploadFile()">Subir</button>
        </div>
        <div id="a_result" class="muted" style="margin-top:6px;"></div>
      </div>

      <div style="margin-top:12px;">
        <h4>Historial</h4>
        <div id="history" class="muted">Selecciona un servicio y presiona “Ver historial”.</div>
      </div>
    </div>

    <div class="card">
      <h3>Dashboard</h3>
      <div class="row">
        <div style="flex:1;">
          <div class="muted">Monto total</div>
          <div class="kpi" id="k_total">0.00</div>
        </div>
        <div style="flex:1;">
          <div class="muted">Monto pagado</div>
          <div class="kpi" id="k_pagado">0.00</div>
        </div>
        <div style="flex:1;">
          <div class="muted">% avance</div>
          <div class="kpi" id="k_pct">0%</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <canvas id="chartDonut"></canvas>
      </div>

      <div style="margin-top:14px;">
        <canvas id="chartCat"></canvas>
      </div>

      <div style="margin-top:14px;">
        <canvas id="chartPay"></canvas>
      </div>

      <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

      <h3>Servicios</h3>
      <div class="row" style="margin-bottom:8px;">
        <input id="q" placeholder="Buscar: proveedor/servicio/código" style="flex:1; min-width:240px;">
        <select id="f_estado">
          <option value="">Estado (todos)</option>
          <option>FALTA PAGAR</option>
          <option>PENDIENTE</option>
          <option>PAGADO</option>
        </select>
        <button class="btn2" onclick="loadServices()">Filtrar</button>
      </div>

      <div style="overflow:auto; max-height:520px;">
        <table>
          <thead>
            <tr>
              <th>Estado</th>
              <th>Proveedor</th>
              <th>Servicio</th>
              <th>Vence</th>
              <th>Monto</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  let donut, catChart, payChart;
  let lastUploadedUrl = null;

  function money(x){
    const n = Number(x||0);
    return n.toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function pill(estado){
    if(estado==='PAGADO') return `<span class="pill pPaid">PAGADO</span>`;
    if(estado==='PENDIENTE') return `<span class="pill pPend">PENDIENTE</span>`;
    return `<span class="pill pDue">FALTA PAGAR</span>`;
  }

  function clearForm(){
    ['id','proveedor','servicio','codigo','categoria','fecha_servicio','monto','estado','medio_pago','cuenta','notas'].forEach(x=>{
      document.getElementById(x).value = (x==='estado') ? 'FALTA PAGAR' : (x==='categoria' ? 'SERVICIOS' : '');
    });
    document.getElementById('history').innerHTML = 'Selecciona un servicio y presiona “Ver historial”.';
    lastUploadedUrl = null;
  }

  function getForm(){
    return {
      id: document.getElementById('id').value || null,
      proveedor: document.getElementById('proveedor').value,
      servicio: document.getElementById('servicio').value,
      codigo: document.getElementById('codigo').value,
      categoria: document.getElementById('categoria').value,
      fecha_servicio: document.getElementById('fecha_servicio').value,
      monto: document.getElementById('monto').value,
      estado: document.getElementById('estado').value,
      medio_pago: document.getElementById('medio_pago').value,
      cuenta: document.getElementById('cuenta').value,
      notas: document.getElementById('notas').value,
    };
  }

  function saveService(){
    const p = getForm();
    if(!p.servicio || !p.fecha_servicio || !p.monto){
      alert('Falta Servicio, Fecha servicio o Monto.');
      return;
    }
    google.script.run.withSuccessHandler(res=>{
      alert('Guardado OK');
      document.getElementById('id').value = res.id;
      loadServices(); loadDashboard();
    }).upsertService(p);
  }

  function removeService(){
    const id = document.getElementById('id').value;
    if(!id){ alert('Selecciona un servicio primero.'); return; }
    if(!confirm('¿Eliminar servicio?')) return;
    google.script.run.withSuccessHandler(res=>{
      if(res.ok){ alert('Eliminado'); clearForm(); loadServices(); loadDashboard(); }
      else alert(res.error || 'Error');
    }).deleteService(id);
  }

  function selectService(s){
    document.getElementById('id').value = s.id;
    document.getElementById('proveedor').value = s.proveedor || '';
    document.getElementById('servicio').value = s.servicio || '';
    document.getElementById('codigo').value = s.codigo || '';
    document.getElementById('categoria').value = s.categoria || 'SERVICIOS';
    document.getElementById('fecha_servicio').value = toISODate(s.fecha_servicio);
    document.getElementById('monto').value = s.monto || 0;
    document.getElementById('estado').value = s.estado || 'FALTA PAGAR';
    document.getElementById('medio_pago').value = s.medio_pago || '';
    document.getElementById('cuenta').value = s.cuenta || '';
    document.getElementById('notas').value = s.notas || '';

    // precargar pagar
    document.getElementById('p_monto_pagado').value = s.monto || 0;
    document.getElementById('p_medio_pago').value = (s.medio_pago || 'BCP');
    document.getElementById('p_cuenta').value = (s.cuenta || '');
    document.getElementById('p_fecha_pago').value = new Date().toISOString().slice(0,10);
  }

  function toISODate(v){
    if(!v) return '';
    // Apps Script puede devolver Date o string
    const d = (v instanceof Date) ? v : new Date(v);
    if(String(d)==='Invalid Date') return '';
    return d.toISOString().slice(0,10);
  }

  function loadServices(){
    const q = document.getElementById('q').value || '';
    const estado = document.getElementById('f_estado').value || '';
    google.script.run.withSuccessHandler(rows=>{
      const tb = document.getElementById('tbl');
      tb.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${pill(r.estado)}</td>
          <td>${r.proveedor||''}</td>
          <td>${r.servicio||''}</td>
          <td>${toISODate(r.fecha_servicio)}</td>
          <td>${money(r.monto)}</td>
          <td><button class="btn2" onclick='selectService(${JSON.stringify(r)})'>Editar</button></td>
        `;
        tb.appendChild(tr);
      });
    }).listServices({q, estado});
  }

  function payService(){
    const service_id = document.getElementById('id').value;
    if(!service_id){ alert('Selecciona un servicio primero.'); return; }

    const payload = {
      service_id,
      fecha_pago: document.getElementById('p_fecha_pago').value,
      monto_pagado: document.getElementById('p_monto_pagado').value,
      medio_pago: document.getElementById('p_medio_pago').value,
      cuenta: document.getElementById('p_cuenta').value,
      estado_mov: 'PAGADO',
      observacion: document.getElementById('p_observacion').value || '',
    };

    // Si subiste un archivo, úsalo como voucher/recibo/contrato según tipo seleccionado
    // (Puedes subir varios: repite la subida)
    if(lastUploadedUrl){
      const tipo = document.getElementById('a_tipo').value;
      if(tipo==='VOUCHER') payload.voucher_url = lastUploadedUrl;
      if(tipo==='RECIBO') payload.recibo_url = lastUploadedUrl;
      if(tipo==='CONTRATO') payload.contrato_url = lastUploadedUrl;
      if(tipo==='OTRO') payload.otros_urls = lastUploadedUrl;
    }

    if(!payload.fecha_pago || !payload.monto_pagado){
      alert('Falta fecha pago o monto pagado.');
      return;
    }

    google.script.run.withSuccessHandler(res=>{
      alert('Pago registrado. Historial + Gasto creado.');
      loadServices(); loadDashboard(); loadHistory();
    }).recordPayment(payload);
  }

  function loadHistory(){
    const serviceId = document.getElementById('id').value;
    if(!serviceId){ alert('Selecciona un servicio primero.'); return; }
    google.script.run.withSuccessHandler(rows=>{
      if(!rows.length){
        document.getElementById('history').innerHTML = 'Sin historial aún.';
        return;
      }
      const html = rows.map(r=>{
        const links = [r.voucher_url, r.recibo_url, r.contrato_url, r.otros_urls].filter(Boolean)
          .map(u=>`<a href="${u}" target="_blank">doc</a>`).join(' | ');
        return `<div style="padding:8px 0;border-bottom:1px solid #eee;">
          <b>${toISODate(r.fecha_pago)}</b> — S/ ${money(r.monto_pagado)} — ${r.medio_pago} — ${r.cuenta}<br>
          <span class="muted">${r.observacion||''}</span><br>
          ${links ? links : '<span class="muted">sin adjuntos</span>'}
        </div>`;
      }).join('');
      document.getElementById('history').innerHTML = html;
    }).listPayments(serviceId);
  }

  function loadDashboard(){
    google.script.run.withSuccessHandler(d=>{
      document.getElementById('k_total').innerText = 'S/ ' + money(d.montoTotal);
      document.getElementById('k_pagado').innerText = 'S/ ' + money(d.montoPagado);
      document.getElementById('k_pct').innerText = Math.round((d.pctPagado||0)*100) + '%';

      // donut
      const donutData = {
        labels: ['Pagado', 'Pendiente'],
        datasets: [{ data: [d.montoPagado, d.montoPendiente] }]
      };
      if(donut) donut.destroy();
      donut = new Chart(document.getElementById('chartDonut'), { type:'doughnut', data: donutData });

      // por categoria
      const cLabels = Object.keys(d.byCategoria||{});
      const cVals = cLabels.map(k=>d.byCategoria[k]);
      if(catChart) catChart.destroy();
      catChart = new Chart(document.getElementById('chartCat'), {
        type:'bar',
        data:{ labels:cLabels, datasets:[{ label:'Monto por categoría', data:cVals }] }
      });

      // por medio pago (gastos)
      const pLabels = Object.keys(d.byMedioPago||{});
      const pVals = pLabels.map(k=>d.byMedioPago[k]);
      if(payChart) payChart.destroy();
      payChart = new Chart(document.getElementById('chartPay'), {
        type:'bar',
        data:{ labels:pLabels, datasets:[{ label:'Pagado por medio', data:pVals }] }
      });

    }).getDashboardSummary();
  }

  async function uploadFile(){
    const service_id = document.getElementById('id').value;
    if(!service_id){ alert('Selecciona un servicio primero.'); return; }

    const tipo = document.getElementById('a_tipo').value;
    const fileInput = document.getElementById('a_file');
    if(!fileInput.files.length){ alert('Selecciona un archivo.'); return; }

    const file = fileInput.files[0];
    const base64Data = await readAsBase64(file);
    document.getElementById('a_result').innerText = 'Subiendo...';

    google.script.run.withSuccessHandler(res=>{
      if(res.ok){
        lastUploadedUrl = res.url;
        document.getElementById('a_result').innerHTML = `Subido OK: <a href="${res.url}" target="_blank">${tipo}</a>`;
      } else {
        document.getElementById('a_result').innerText = 'Error subiendo.';
      }
    }).uploadAttachment({
      service_id,
      tipo,
      filename: file.name,
      mimeType: file.type,
      base64Data
    });
  }

  function readAsBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = () => {
        const result = reader.result;
        // result: data:mime/type;base64,XXXX
        resolve(result.split(',')[1]);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // init
  clearForm();
  loadServices();
  loadDashboard();
</script>
</body>
</html>
