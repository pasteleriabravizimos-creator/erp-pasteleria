<script>
/************ CONFIG ************/
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyjcXUiyjhxP9TmIbgeuvPcasJqJtONkEbcnbQIkwlLCm7JAJy2JjoOtiZeR1sKc10_/exec";

/************ STATE ************/
let charts = {};

function money(n){
  const x = Number(n||0);
  return "S/ " + x.toLocaleString("es-PE", {minimumFractionDigits:2, maximumFractionDigits:2});
}
function setMsg(text, show=true){
  const el = document.getElementById("msg");
  if(!show){ el.classList.add("hidden"); el.textContent=""; return; }
  el.classList.remove("hidden"); el.textContent = text;
}

async function fetchData(){
  const mode = document.getElementById("mode").value;
  const month = document.getElementById("month").value;
  const year = document.getElementById("year").value;

  const url = `${APPS_SCRIPT_URL}?action=data&mode=${encodeURIComponent(mode)}&month=${encodeURIComponent(month)}&year=${encodeURIComponent(year)}&_=${Date.now()}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error("No se pudo cargar data");
  return await res.json();
}

function destroyChart(id){
  if(charts[id]){ charts[id].destroy(); delete charts[id]; }
}

/************ FIN CHARTS (ACTUALIZADO) ************/
function renderFinCharts(d){
  destroyChart("chart_fin1");
  destroyChart("chart_fin2");

  const series = d.finanzasSeries || [];
  const labels = series.map(x=>x.fecha);

  // 1) Ventas vs Gastos + Saldo Pendiente (por dÃ­a)
  const ctx1 = document.getElementById("chart_fin1");
  charts["chart_fin1"] = new Chart(ctx1, {
    type:"bar",
    data:{
      labels,
      datasets:[
        { label:"Ventas", data: series.map(x=>x.ventas||0) },
        { label:"Gastos", data: series.map(x=>x.gastos||0) },
        { label:"Saldo Pendiente", data: series.map(x=>x.saldoPendiente||0), type:"line" },
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:"rgba(255,255,255,.8)"}}},
      scales:{x:{ticks:{color:"rgba(255,255,255,.6)"}}, y:{ticks:{color:"rgba(255,255,255,.6)"}}}
    }
  });

  // 2) Acumulado de ventas
  const ctx2 = document.getElementById("chart_fin2");
  charts["chart_fin2"] = new Chart(ctx2, {
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Ventas acumuladas", data: series.map(x=>x.ventasAcum||0) }
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:"rgba(255,255,255,.8)"}}},
      scales:{x:{ticks:{color:"rgba(255,255,255,.6)"}}, y:{ticks:{color:"rgba(255,255,255,.6)"}}}
    }
  });
}
</script>
