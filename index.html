<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BRAVIZIMO'S | Dashboard Financiero</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#060b17;
      --bg2:#0b1630;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --text:#e8edf7;
      --muted:rgba(232,237,247,.70);
      --accent:#8ab4ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1000px 600px at 20% 10%, rgba(138,180,255,.20), transparent 60%),
                  radial-gradient(900px 700px at 80% 20%, rgba(167,139,250,.18), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 50px;}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      padding:8px 2px 16px;
      border-bottom:1px solid var(--stroke);
    }
    .title h1{font-size:18px;margin:0 0 4px;font-weight:700;letter-spacing:.3px}
    .title p{margin:0;color:var(--muted);font-size:12px}

    .controls{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;
      background:rgba(255,255,255,.03);
      padding:10px;border:1px solid var(--stroke);border-radius:14px;
    }
    .controls label{font-size:12px;color:var(--muted)}
    select, input, button{
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      font-size:12px;
      outline:none;
    }
    button{
      cursor:pointer;
      background:rgba(255,255,255,.12);
      font-weight:650;
      padding:9px 14px;
    }
    button:hover{filter:brightness(1.08)}
    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;margin:18px 0 12px;
    }
    .tab{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(255,255,255,.14);
      border-color:rgba(255,255,255,.18);
    }

    .grid-kpi{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
      margin-top:10px;
    }
    @media (max-width:1020px){ .grid-kpi{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width:520px){ .grid-kpi{grid-template-columns: 1fr;} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:0 14px 30px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .kpi-label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi-value{font-size:22px;font-weight:800;letter-spacing:.2px}
    .kpi-sub{margin-top:6px;color:var(--muted);font-size:11px}

    .section{display:none;margin-top:12px;}
    .section.active{display:block;}

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:980px){ .grid-2{grid-template-columns:1fr;} }

    .chart-card{height:340px;}
    .chart-wrap{position:relative;height:280px;margin-top:10px;}
    canvas{width:100% !important;height:100% !important;}

    .table-card{padding:0;overflow:hidden}
    .table-head{padding:14px;border-bottom:1px solid var(--stroke)}
    .table-head h3{margin:0;font-size:14px}
    .table-head p{margin:6px 0 0;color:var(--muted);font-size:12px}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;vertical-align:top}
    th{color:var(--muted);font-weight:650}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .scroll{max-height:360px;overflow:auto}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--stroke);border-radius:999px;font-size:11px;color:var(--muted)}
    .total-row td{font-weight:800;border-top:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.03)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>BRAVIZIMO'S | Dashboard Financiero</h1>
        <p>Sincronizado con Google Sheets (Apps Script)</p>
      </div>

      <div class="controls">
        <label>Modo</label>
        <select id="mode">
          <option value="mes" selected>Mes</option>
          <option value="rango">Rango</option>
        </select>

        <label>Mes</label>
        <select id="mesSelect"></select>

        <label class="rangoOnly" style="display:none;">Desde</label>
        <input class="rangoOnly" style="display:none;" id="desde" type="date"/>

        <label class="rangoOnly" style="display:none;">Hasta</label>
        <input class="rangoOnly" style="display:none;" id="hasta" type="date"/>

        <button id="btnRefresh">Actualizar</button>
      </div>
    </header>

    <div class="tabs" id="tabs"></div>

    <!-- FINANZAS -->
    <section class="section active" id="sec-finanzas">
      <div class="grid-kpi" id="kpis"></div>

      <div class="grid-2">
        <div class="card chart-card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
            <div>
              <div style="font-weight:800">Ventas vs Gastos (por día) + Saldo</div>
              <div class="muted" style="font-size:12px;margin-top:4px">Ventas (nota de ventas), Gastos (GASTOS), Saldo pendiente (por pagar).</div>
            </div>
            <span class="pill" id="periodLabel"></span>
          </div>
          <div class="chart-wrap"><canvas id="chVentasGastos"></canvas></div>
        </div>

        <div class="card chart-card">
          <div style="font-weight:800">Acumulado de ventas</div>
          <div class="muted" style="font-size:12px;margin-top:4px">Suma progresiva por día.</div>
          <div class="chart-wrap"><canvas id="chAcumulado"></canvas></div>
        </div>
      </div>
    </section>

    <!-- ALERTAS -->
    <section class="section" id="sec-alertas">
      <div class="grid-2">
        <div class="card table-card">
          <div class="table-head">
            <h3>Pendientes de comprobante (hasta 200)</h3>
            <p>Incluye numeración y columna <b>Comprobante</b>.</p>
          </div>
          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Fecha</th><th>Pedido</th><th>Nota</th><th>Cliente</th><th>Comprobante</th><th class="right">Total</th>
                </tr>
              </thead>
              <tbody id="tbPendComp"></tbody>
            </table>
          </div>
        </div>

        <div class="card table-card">
          <div class="table-head">
            <h3>Saldos pendientes (hasta 200)</h3>
            <p>Incluye <b>TOTAL FINAL</b> (resultado monto final).</p>
          </div>
          <div class="scroll">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th><th>Cliente</th><th class="right">Total</th><th class="right">Por pagar</th>
                </tr>
              </thead>
              <tbody id="tbSaldosPend"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- DISTRITOS -->
    <section class="section" id="sec-distritos">
      <div class="card table-card">
        <div class="table-head">
          <h3>Ranking de distritos</h3>
          <p>Pedidos (entregas) y monto (suma delivery cliente).</p>
        </div>
        <div class="scroll">
          <table>
            <thead>
              <tr><th>Distrito</th><th class="right">Pedidos</th><th class="right">Monto</th></tr>
            </thead>
            <tbody id="tbDistritos"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VENDEDORAS -->
    <section class="section" id="sec-vendedoras">
      <div class="grid-2">
        <div class="card chart-card">
          <div style="font-weight:800">Resumen por vendedora (Top)</div>
          <div class="muted" style="font-size:12px;margin-top:4px">Monto y pedidos (nota de ventas).</div>
          <div class="chart-wrap"><canvas id="chVendedoras"></canvas></div>
        </div>

        <div class="card table-card">
          <div class="table-head">
            <h3>Vendedoras por día (ventas y saldo)</h3>
            <p>Detalle por fecha y vendedora.</p>
          </div>
          <div class="scroll">
            <table>
              <thead>
                <tr><th>Fecha</th><th>Vendedora</th><th class="right">Pedidos</th><th class="right">Monto</th><th class="right">Saldo</th></tr>
              </thead>
              <tbody id="tbVendedorasDia"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- DELIVERY -->
    <section class="section" id="sec-delivery">
      <div class="grid-2">
        <div class="card chart-card">
          <div style="font-weight:800">Delivery por día</div>
          <div class="muted" style="font-size:12px;margin-top:4px">Delivery cobrado vs costo de delivery.</div>
          <div class="chart-wrap"><canvas id="chDeliveryDia"></canvas></div>
        </div>

        <div class="card chart-card">
          <div style="font-weight:800">Recojo en tienda (por día)</div>
          <div class="muted" style="font-size:12px;margin-top:4px">Si Dirección contiene “RECOJO/TIENDA” o columna Recojo = SI.</div>
          <div class="chart-wrap"><canvas id="chRecojo"></canvas></div>
        </div>
      </div>

      <div class="card chart-card" style="margin-top:12px">
        <div style="font-weight:800">Ahorro delivery por día</div>
        <div class="muted" style="font-size:12px;margin-top:4px">Ahorro = Delivery cliente - Costo delivery.</div>
        <div class="chart-wrap"><canvas id="chAhorro"></canvas></div>
      </div>

      <div class="card table-card" style="margin-top:12px">
        <div class="table-head">
          <h3>Delivery por motorizado (ranking)</h3>
          <p>Entregas, cobrado y costo (periodo seleccionado).</p>
        </div>
        <div class="scroll">
          <table>
            <thead>
              <tr><th>Motorizado</th><th class="right">Entregas</th><th class="right">Cobrado</th><th class="right">Costo</th></tr>
            </thead>
            <tbody id="tbMotorizado"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PRODUCTOS -->
    <section class="section" id="sec-productos">
      <div class="card table-card">
        <div class="table-head">
          <h3>Top productos (ordenado por cantidad acumulada)</h3>
          <p>Incluye cantidad y monto (hoja <b>productos</b>).</p>
        </div>
        <div class="scroll">
          <table>
            <thead>
              <tr><th>Producto</th><th class="right">Cantidad</th><th class="right">Monto</th></tr>
            </thead>
            <tbody id="tbTopProd"></tbody>
          </table>
        </div>
      </div>

      <div class="card table-card" style="margin-top:12px">
        <div class="table-head">
          <h3>Productos por día (para saber qué preparar)</h3>
          <p>Agrupado por fecha entrega y producto (mes/rango seleccionado).</p>
        </div>
        <div class="scroll">
          <table>
            <thead>
              <tr><th>Fecha</th><th>Producto</th><th class="right">Cantidad</th></tr>
            </thead>
            <tbody id="tbProdDia"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section class="section" id="sec-clientes">
      <div class="card table-card">
        <div class="table-head">
          <h3>Clientes del período (hasta 200)</h3>
          <p>Ordenado por monto acumulado (desc). Incluye numeración, celular y cantidad de pedidos.</p>
        </div>
        <div class="scroll">
          <table>
            <thead>
              <tr><th>#</th><th>Cliente</th><th>Celular</th><th>Última compra</th><th class="right">Pedidos</th><th class="right">Monto</th></tr>
            </thead>
            <tbody id="tbClientes"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GASTOS -->
    <section class="section" id="sec-gastos">
      <div class="card table-card">
        <div class="table-head">
          <h3>Gastos por categoría</h3>
          <p>Lee de hoja <b>GASTOS</b>, columna <b>T.SOLES</b> (o Monto/Total).</p>
        </div>
        <div class="scroll">
          <table>
            <thead>
              <tr><th>Categoría</th><th class="right">Registros</th><th class="right">Monto</th></tr>
            </thead>
            <tbody id="tbGastosCat"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MEDIOS DE PAGO -->
    <section class="section" id="sec-medios">
      <div class="card table-card">
        <div class="table-head">
          <h3>Medios de pago</h3>
          <p><b>Solo ingresos</b>: suma de <b>Pagado</b> agrupado por Cuenta destino / Medio (nota de ventas).</p>
        </div>
        <div class="scroll">
          <table>
            <thead>
              <tr><th>Medio</th><th class="right">Registros</th><th class="right">Monto</th></tr>
            </thead>
            <tbody id="tbMedios"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SERVICIOS -->
    <section class="section" id="sec-servicios">
      <div class="grid-2">
        <div class="card chart-card">
          <div style="font-weight:800">Servicios: Pagado vs Pendiente (por día)</div>
          <div class="muted" style="font-size:12px;margin-top:4px">Lee hoja servicios: TIPO / FECHA / MONTO / ESTADO.</div>
          <div class="chart-wrap"><canvas id="chServicios"></canvas></div>
        </div>

        <div class="card table-card">
          <div class="table-head">
            <h3>Servicios (lista)</h3>
            <p>Tipo, Fecha, Monto, Estado, Medio y Obs (hasta 200 filas).</p>
          </div>
          <div class="scroll">
            <table>
              <thead>
                <tr><th>Tipo</th><th>Fecha</th><th class="right">Monto</th><th>Estado</th><th>Medio</th><th>Obs</th></tr>
              </thead>
              <tbody id="tbServicios"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </div>

<script>
/** =====================
 * CONFIG
 * ===================== */
// 1) pega tu URL de Apps Script (web app /exec)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyuaypIs7bVHtjYHVJIUrZng3CRT9V5b_g9G3ML12e0RlXY2XlD_r7XVYSLnEX5nD3-/exec"; // ej: https://script.google.com/macros/s/XXXX/exec
// 2) pega tu Spreadsheet ID (el largo del link)
const SPREADSHEET_ID = "PEGA_AQUI_TU_SPREADSHEET_ID";

/** =====================
 * UI / STATE
 * ===================== */
const TABS = [
  { id:"finanzas", label:"Finanzas" },
  { id:"alertas", label:"Alertas" },
  { id:"distritos", label:"Distritos" },
  { id:"vendedoras", label:"Vendedoras" },
  { id:"delivery", label:"Delivery" },
  { id:"productos", label:"Productos" },
  { id:"clientes", label:"Clientes" },
  { id:"gastos", label:"Gastos" },
  { id:"medios", label:"Medios de pago" },
  { id:"servicios", label:"Servicios" },
];

let charts = {};
let lastPayload = null;

function money(n){
  const x = Number(n || 0);
  return "S/ " + x.toLocaleString("es-PE",{minimumFractionDigits:2, maximumFractionDigits:2});
}

function buildMesOptions(){
  const sel = document.getElementById("mesSelect");
  sel.innerHTML = "";
  // 18 meses alrededor (12 atrás + 6 adelante)
  const now = new Date();
  for(let i=12;i>=-6;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const ym = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    const name = d.toLocaleString("es-PE",{month:"long", year:"numeric"});
    const op = document.createElement("option");
    op.value = ym;
    op.textContent = name.charAt(0).toUpperCase()+name.slice(1);
    if(i===0) op.selected = true;
    sel.appendChild(op);
  }
}

function mountTabs(){
  const host = document.getElementById("tabs");
  host.innerHTML = "";
  TABS.forEach((t, idx)=>{
    const b = document.createElement("div");
    b.className = "tab" + (idx===0 ? " active":"");
    b.textContent = t.label;
    b.dataset.tab = t.id;
    b.onclick = ()=> activateTab(t.id);
    host.appendChild(b);
  });
}

function activateTab(id){
  document.querySelectorAll(".tab").forEach(x=>{
    x.classList.toggle("active", x.dataset.tab === id);
  });
  document.querySelectorAll(".section").forEach(s=> s.classList.remove("active"));
  document.getElementById(`sec-${id}`).classList.add("active");
}

function setModeUI(){
  const mode = document.getElementById("mode").value;
  document.querySelectorAll(".rangoOnly").forEach(el=>{
    el.style.display = (mode==="rango") ? "" : "none";
  });
  document.getElementById("mesSelect").style.display = (mode==="mes") ? "" : "none";
}

/** =====================
 * FETCH
 * ===================== */
async function loadData(){
  const mode = document.getElementById("mode").value;
  const mes = document.getElementById("mesSelect").value;
  const desde = document.getElementById("desde").value;
  const hasta = document.getElementById("hasta").value;

  const url = new URL(SCRIPT_URL);
  url.searchParams.set("ssId", SPREADSHEET_ID);
  url.searchParams.set("mode", mode);
  if(mode==="mes"){
    url.searchParams.set("mes", mes);
  } else {
    url.searchParams.set("desde", desde);
    url.searchParams.set("hasta", hasta);
  }

  const res = await fetch(url.toString());
  const json = await res.json();
  if(!json.ok) throw new Error(json.error || "Error desconocido");
  lastPayload = json;
  renderAll(json);
}

/** =====================
 * RENDER
 * ===================== */
function renderAll(p){
  document.getElementById("periodLabel").textContent = `${p.meta.mes} (${p.meta.desde} a ${p.meta.hasta})`;

  renderKpis(p.kpis);

  renderFinanzas(p.finanzas);
  renderAlertas(p.alertas);
  renderDistritos(p.distritos);
  renderVendedoras(p.vendedoras);
  renderDelivery(p.delivery);
  renderProductos(p.productos);
  renderClientes(p.clientes);
  renderGastos(p.gastos);
  renderMedios(p.mediosPago);
  renderServicios(p.servicios);
}

function renderKpis(k){
  const host = document.getElementById("kpis");
  host.innerHTML = "";

  const items = [
    { label:"Ventas totales", value: money(k.ventasTotales) },
    { label:"Gastos totales", value: money(k.gastosTotales) },
    { label:"Utilidad", value: money(k.utilidad), sub: k.utilidad>=0 ? "OK" : "En negativo" },
    { label:"Saldo pendiente", value: money(k.saldoPendiente) },

    { label:"Delivery cobrado", value: money(k.deliveryCobrado), sub:"(ENVÍOS → Delivery CLIENTE)" },
    { label:"Costo delivery", value: money(k.costoDelivery), sub:"(ENVÍOS → Costo Delivery)" },
    { label:"Margen delivery", value: money(k.margenDelivery) },
    { label:"Clientes (total)", value: String(k.clientesTotal) },

    { label:"Promedio diario (hasta hoy)", value: money(k.promedioDiario) },
    { label:"Proyección mensual (prom × 30)", value: money(k.proyeccionMensual) },
    { label:"Boletas / Facturas", value: `${k.boletas} / ${k.facturas}` },
    { label:"Comprobantes faltantes", value: String(k.comprobantesFaltantes) },
  ];

  items.forEach(it=>{
    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <div class="kpi-label">${it.label}</div>
      <div class="kpi-value">${it.value}</div>
      ${it.sub ? `<div class="kpi-sub">${it.sub}</div>` : ``}
    `;
    host.appendChild(c);
  });
}

function renderFinanzas(f){
  // Ventas vs Gastos
  const s1 = f.ventasVsGastos || [];
  const labels = s1.map(x=>x.fecha);
  const ventas = s1.map(x=>x.ventas);
  const gastos = s1.map(x=>x.gastos);
  const saldo = s1.map(x=>x.saldoPendiente);

  makeChart("chVentasGastos","line", labels, [
    { label:"Ventas", data: ventas, tension:.35 },
    { label:"Gastos", data: gastos, tension:.35 },
    { label:"Saldo pendiente", data: saldo, tension:.35 },
  ]);

  // Acumulado
  const s2 = f.acumuladoVentas || [];
  makeChart("chAcumulado","line", s2.map(x=>x.fecha), [
    { label:"Acumulado", data: s2.map(x=>x.acumulado), tension:.35 }
  ]);
}

function renderAlertas(a){
  // Pendientes comprobante
  const tb1 = document.getElementById("tbPendComp");
  tb1.innerHTML = "";
  (a.pendientesComprobante || []).forEach(r=>{
    tb1.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.n}</td>
        <td>${r.fecha}</td>
        <td>${r.pedido || ""}</td>
        <td>${r.nota || ""}</td>
        <td>${r.cliente || ""}</td>
        <td>${r.comprobante || ""}</td>
        <td class="right">${money(r.total)}</td>
      </tr>
    `);
  });
  if(!a.pendientesComprobante || a.pendientesComprobante.length===0){
    tb1.innerHTML = `<tr><td colspan="7" class="muted">Sin registros.</td></tr>`;
  }

  // Saldos pendientes
  const tb2 = document.getElementById("tbSaldosPend");
  tb2.innerHTML = "";
  (a.saldosPendientes || []).forEach(r=>{
    tb2.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.fecha}</td>
        <td>${r.cliente || ""}</td>
        <td class="right">${money(r.total)}</td>
        <td class="right">${money(r.porPagar)}</td>
      </tr>
    `);
  });
  const totalFinal = a.totalPendienteFinal || 0;
  tb2.insertAdjacentHTML("beforeend", `
    <tr class="total-row">
      <td colspan="3">TOTAL FINAL</td>
      <td class="right">${money(totalFinal)}</td>
    </tr>
  `);
  if(!a.saldosPendientes || a.saldosPendientes.length===0){
    tb2.innerHTML = `<tr><td colspan="4" class="muted">Sin registros.</td></tr>` + tb2.innerHTML;
  }
}

function renderDistritos(d){
  const tb = document.getElementById("tbDistritos");
  tb.innerHTML = "";
  (d.ranking || []).forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.distrito}</td>
        <td class="right">${r.pedidos}</td>
        <td class="right">${money(r.monto)}</td>
      </tr>
    `);
  });

  tb.insertAdjacentHTML("beforeend", `
    <tr class="total-row">
      <td>TOTAL</td>
      <td class="right">${d.totalPedidos || 0}</td>
      <td class="right">${money(d.totalMonto || 0)}</td>
    </tr>
  `);

  if(!d.ranking || d.ranking.length===0){
    tb.innerHTML = `<tr><td colspan="3" class="muted">Sin registros.</td></tr>` + tb.innerHTML;
  }
}

function renderVendedoras(v){
  const top = v.resumenTop || [];
  const labels = top.slice(0,12).map(x=>x.vendedora);
  const monto = top.slice(0,12).map(x=>x.monto);
  const pedidos = top.slice(0,12).map(x=>x.pedidos);

  makeChart("chVendedoras","bar", labels, [
    { label:"Monto", data:monto },
    { label:"Pedidos", data:pedidos }
  ]);

  const tb = document.getElementById("tbVendedorasDia");
  tb.innerHTML = "";
  (v.detalle || []).forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.fecha}</td>
        <td>${r.vendedora}</td>
        <td class="right">${r.pedidos}</td>
        <td class="right">${money(r.monto)}</td>
        <td class="right">${money(r.saldo)}</td>
      </tr>
    `);
  });
  if(!v.detalle || v.detalle.length===0){
    tb.innerHTML = `<tr><td colspan="5" class="muted">Sin registros.</td></tr>`;
  }
}

function renderDelivery(d){
  const porDia = d.porDia || [];
  makeChart("chDeliveryDia","bar", porDia.map(x=>x.fecha), [
    { label:"Cobrado", data: porDia.map(x=>x.cobrado) },
    { label:"Costo", data: porDia.map(x=>x.costo) },
  ]);

  const recojo = d.recojoPorDia || [];
  makeChart("chRecojo","line", recojo.map(x=>x.fecha), [
    { label:"Recojo (cant)", data: recojo.map(x=>x.recojo), tension:.35 }
  ]);

  const ahorro = d.ahorroPorDia || [];
  makeChart("chAhorro","line", ahorro.map(x=>x.fecha), [
    { label:"Cobrado", data: ahorro.map(x=>x.cobrado), tension:.35 },
    { label:"Costo", data: ahorro.map(x=>x.costo), tension:.35 },
    { label:"Ahorro", data: ahorro.map(x=>x.ahorro), tension:.35 },
  ]);

  const tb = document.getElementById("tbMotorizado");
  tb.innerHTML = "";
  (d.motorizado || []).forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.motorizado}</td>
        <td class="right">${r.entregas}</td>
        <td class="right">${money(r.cobrado)}</td>
        <td class="right">${money(r.costo)}</td>
      </tr>
    `);
  });
  if(!d.motorizado || d.motorizado.length===0){
    tb.innerHTML = `<tr><td colspan="4" class="muted">Sin registros.</td></tr>`;
  }
}

function renderProductos(p){
  const tb1 = document.getElementById("tbTopProd");
  tb1.innerHTML = "";
  (p.top || []).forEach(r=>{
    tb1.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.producto}</td>
        <td class="right">${Number(r.cantidad||0).toLocaleString("es-PE")}</td>
        <td class="right">${money(r.monto)}</td>
      </tr>
    `);
  });
  if(!p.top || p.top.length===0){
    tb1.innerHTML = `<tr><td colspan="3" class="muted">Sin registros.</td></tr>`;
  }

  const tb2 = document.getElementById("tbProdDia");
  tb2.innerHTML = "";
  (p.porDia || []).forEach(r=>{
    tb2.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.fecha}</td>
        <td>${r.producto}</td>
        <td class="right">${Number(r.cantidad||0).toLocaleString("es-PE")}</td>
      </tr>
    `);
  });
  if(!p.porDia || p.porDia.length===0){
    tb2.innerHTML = `<tr><td colspan="3" class="muted">Sin registros.</td></tr>`;
  }
}

function renderClientes(c){
  const tb = document.getElementById("tbClientes");
  tb.innerHTML = "";
  (c.list || []).forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.n}</td>
        <td>${r.cliente}</td>
        <td>${r.celular || ""}</td>
        <td>${r.ultimaCompra || ""}</td>
        <td class="right">${r.pedidos}</td>
        <td class="right">${money(r.monto)}</td>
      </tr>
    `);
  });
  if(!c.list || c.list.length===0){
    tb.innerHTML = `<tr><td colspan="6" class="muted">Sin registros.</td></tr>`;
  }
}

function renderGastos(g){
  const tb = document.getElementById("tbGastosCat");
  tb.innerHTML = "";
  (g.byCategoria || []).forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.categoria}</td>
        <td class="right">${r.registros}</td>
        <td class="right">${money(r.monto)}</td>
      </tr>
    `);
  });

  tb.insertAdjacentHTML("beforeend", `
    <tr class="total-row">
      <td colspan="2">TOTAL</td>
      <td class="right">${money(g.total || 0)}</td>
    </tr>
  `);

  if(!g.byCategoria || g.byCategoria.length===0){
    tb.innerHTML = `<tr><td colspan="3" class="muted">Sin registros.</td></tr>` + tb.innerHTML;
  }
}

function renderMedios(m){
  const tb = document.getElementById("tbMedios");
  tb.innerHTML = "";
  const list = (m.ranking || []).filter(x=>x.monto>0);
  list.forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.medio}</td>
        <td class="right">${r.registros}</td>
        <td class="right">${money(r.monto)}</td>
      </tr>
    `);
  });
  if(list.length===0){
    tb.innerHTML = `<tr><td colspan="3" class="muted">Sin registros.</td></tr>`;
  }
}

function renderServicios(s){
  const porDia = s.porDia || [];
  makeChart("chServicios","bar", porDia.map(x=>x.fecha), [
    { label:"Pagado", data: porDia.map(x=>x.pagado) },
    { label:"Pendiente", data: porDia.map(x=>x.pendiente) },
  ]);

  const tb = document.getElementById("tbServicios");
  tb.innerHTML = "";
  (s.list || []).forEach(r=>{
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${r.tipo||""}</td>
        <td>${r.fecha||""}</td>
        <td class="right">${money(r.monto)}</td>
        <td>${r.estado||""}</td>
        <td>${r.medio||""}</td>
        <td>${r.obs||""}</td>
      </tr>
    `);
  });
  if(!s.list || s.list.length===0){
    tb.innerHTML = `<tr><td colspan="6" class="muted">Sin registros.</td></tr>`;
  }
}

/** =====================
 * CHART HELPER
 * ===================== */
function makeChart(id, type, labels, datasets){
  const el = document.getElementById(id);
  if(!el) return;

  // Destruir si existe
  if(charts[id]) charts[id].destroy();

  // Compactar labels si son demasiadas
  const maxLabels = 18;
  const step = labels.length > maxLabels ? Math.ceil(labels.length / maxLabels) : 1;
  const labels2 = labels.map((x, i)=> i%step===0 ? x : "");

  charts[id] = new Chart(el, {
    type,
    data: { labels: labels2, datasets: datasets.map(ds=>({ ...ds })) },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{ labels:{ color:"rgba(232,237,247,.85)" } },
        tooltip:{ callbacks:{
          label: (ctx)=>{
            const v = ctx.raw;
            if(typeof v === "number") return `${ctx.dataset.label}: ${money(v)}`;
            return `${ctx.dataset.label}: ${v}`;
          }
        }}
      },
      scales:{
        x:{ ticks:{ color:"rgba(232,237,247,.65)", maxRotation:45, minRotation:45 }, grid:{ color:"rgba(255,255,255,.06)" } },
        y:{ ticks:{ color:"rgba(232,237,247,.65)" }, grid:{ color:"rgba(255,255,255,.06)" } }
      }
    }
  });
}

/** =====================
 * INIT
 * ===================== */
(function init(){
  buildMesOptions();
  mountTabs();

  document.getElementById("mode").addEventListener("change", ()=>{
    setModeUI();
  });

  document.getElementById("btnRefresh").addEventListener("click", async ()=>{
    try{
      await loadData();
    }catch(err){
      alert("Error: " + err.message);
      console.error(err);
    }
  });

  setModeUI();

  // primera carga
  document.getElementById("btnRefresh").click();
})();
</script>
</body>
</html>
