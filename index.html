<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BRAVIZIMO'S | Dashboard Financiero</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#f5f7fb; --card:#fff; --ink:#0b1220; --muted:#6b7280;
  --brand:#0f172a; --line:#e5e7eb; --radius:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--ink)}
header{
  background:linear-gradient(120deg,#0b1220,#111827,#0b1220);
  color:#fff;padding:22px 18px; position:sticky; top:0; z-index:10;
  box-shadow:0 12px 30px rgba(0,0,0,.22);
}
.wrap{max-width:1200px;margin:0 auto}
.hrow{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.title h1{margin:0;font-size:18px;letter-spacing:.4px}
.title p{margin:4px 0 0;color:rgba(255,255,255,.75);font-size:12px}

.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
select,input,button{
  border:1px solid rgba(255,255,255,.15);
  background:rgba(255,255,255,.06);
  color:#fff;border-radius:12px;padding:10px 12px;outline:none;
}
input{min-width:140px}
button{background:#fff;color:#111827;border:0;font-weight:700;cursor:pointer}
button:hover{opacity:.95}

.main{padding:18px}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px}
.card{
  background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
  padding:14px 14px 12px; box-shadow:0 10px 25px rgba(15,23,42,.06);
}
.card .k{font-size:12px;color:var(--muted)}
.card .v{font-size:22px;margin-top:6px;font-weight:800}
.row{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
@media (max-width: 980px){ .row{grid-template-columns:1fr} }

.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0 10px}
.tab{
  border:1px solid var(--line); background:#fff; color:#111827;
  border-radius:999px; padding:8px 12px; font-weight:700; cursor:pointer;
}
.tab.active{background:#111827;color:#fff;border-color:#111827}

.panel{display:none}
.panel.active{display:block}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

h2{margin:0 0 8px;font-size:14px}
small{color:var(--muted)}

.table{
  width:100%; border-collapse:separate; border-spacing:0; overflow:hidden;
  border:1px solid var(--line); border-radius:14px; background:#fff;
}
.table th,.table td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:12px}
.table th{background:#f9fafb;text-align:left;color:#111827}
.table tr:last-child td{border-bottom:0}
.badge{
  display:inline-block;padding:6px 10px;border-radius:999px;background:#fee2e2;color:#991b1b;
  font-weight:800;font-size:12px
}
</style>
</head>
<body>

<header>
  <div class="wrap hrow">
    <div class="title">
      <h1>BRAVIZIMO'S | Dashboard Financiero</h1>
      <p>Sincronizado con Google Sheets (Apps Script)</p>
    </div>

    <div class="controls">
      <select id="mode">
        <option value="month">Mes</option>
        <option value="range">Rango</option>
      </select>

      <input id="month" type="month"/>
      <input id="from" type="date" placeholder="dd/mm/aaaa" style="display:none"/>
      <input id="to" type="date" placeholder="dd/mm/aaaa" style="display:none"/>

      <button id="btn">Actualizar</button>
    </div>
  </div>
</header>

<div class="main wrap">
  <div id="err" style="margin:10px 0;display:none"><span class="badge" id="errTxt"></span></div>

  <div class="kpis" id="kpis"></div>

  <div class="tabs" id="tabs"></div>

  <div id="panels">
    <div class="panel active" data-panel="Finanzas">
      <div class="grid2">
        <div class="card"><h2>Ventas vs Gastos (por día) + Saldo</h2><canvas id="chart1" height="140"></canvas></div>
        <div class="card"><h2>Acumulado de ventas</h2><canvas id="chart2" height="140"></canvas></div>
      </div>
    </div>

    <div class="panel" data-panel="Alertas">
      <div class="card">
        <h2>Alertas</h2>
        <div id="alertasBox"></div>
      </div>
    </div>

    <div class="panel" data-panel="Distritos">
      <div class="card">
        <h2>Ranking por distritos</h2>
        <table class="table" id="tblDistritos"></table>
      </div>
    </div>

    <div class="panel" data-panel="Vendedoras">
      <div class="card">
        <h2>Vendedoras por día (ventas, saldo, pedidos)</h2>
        <div id="vendTot"></div>
        <table class="table" id="tblVend"></table>
      </div>
    </div>

    <div class="panel" data-panel="Delivery">
      <div class="grid2">
        <div class="card"><h2>Delivery por día (cobrado/costo) + Recojo tienda</h2><table class="table" id="tblDelDia"></table></div>
        <div class="card"><h2>Delivery por repartidor (para pago)</h2><table class="table" id="tblDelRep"></table></div>
      </div>
    </div>

    <div class="panel" data-panel="Productos">
      <div class="grid2">
        <div class="card"><h2>Top 20 productos por monto</h2><table class="table" id="tblProdMonto"></table></div>
        <div class="card"><h2>Top 20 productos por cantidad</h2><table class="table" id="tblProdCant"></table></div>
      </div>
    </div>

    <div class="panel" data-panel="Clientes">
      <div class="card">
        <h2>Clientes (hoja clientes)</h2>
        <small>Tip: aquí puedes filtrar con CTRL+F por nombre/celular.</small>
        <table class="table" id="tblCli"></table>
      </div>
    </div>

    <div class="panel" data-panel="Gastos">
      <div class="card">
        <h2>Gastos por categoría</h2>
        <table class="table" id="tblGastos"></table>
      </div>
    </div>

    <div class="panel" data-panel="Medios de pago">
      <div class="card">
        <h2>Medios de pago (1er y 2do pago por cuentas)</h2>
        <table class="table" id="tblMP"></table>
      </div>
    </div>

    <div class="panel" data-panel="Servicios">
      <div class="card">
        <h2>Servicios (pendientes y pagados)</h2>
        <table class="table" id="tblServ"></table>
      </div>
    </div>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbykGV3yTg5v1cKf9w50WAcr64ogSAyXkYGErBwAMvLsXlwXvPyqvcY3qFZZg59uuxsa/exec";

const TABS = ["Finanzas","Alertas","Distritos","Vendedoras","Delivery","Productos","Clientes","Gastos","Medios de pago","Servicios"];

const money = n => "S/ " + (Number(n||0)).toLocaleString("es-PE",{minimumFractionDigits:2,maximumFractionDigits:2});
const intFmt = n => (Number(n||0)).toLocaleString("es-PE");

const el = id => document.getElementById(id);

let chart1, chart2;

function setModeUI(){
  const mode = el("mode").value;
  el("month").style.display = mode==="month" ? "" : "none";
  el("from").style.display  = mode==="range" ? "" : "none";
  el("to").style.display    = mode==="range" ? "" : "none";
}
el("mode").addEventListener("change", setModeUI);

function buildQuery(){
  const mode = el("mode").value;
  const params = new URLSearchParams();
  if(mode==="month"){
    const m = el("month").value;
    if(m) params.set("month", m);
  } else {
    if(el("from").value) params.set("from", el("from").value);
    if(el("to").value) params.set("to", el("to").value);
  }
  return params.toString();
}

function showError(msg){
  el("err").style.display = msg ? "" : "none";
  el("errTxt").textContent = msg || "";
}

function renderTabs(){
  const tabs = el("tabs");
  tabs.innerHTML = "";
  TABS.forEach((t,i)=>{
    const b = document.createElement("button");
    b.className = "tab" + (i===0?" active":"");
    b.textContent = t;
    b.onclick = ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
      document.querySelector(`.panel[data-panel="${t}"]`).classList.add("active");
    };
    tabs.appendChild(b);
  });
}

function renderKPIs(k){
  const map = [
    ["Ventas totales", money(k.ventasTotal)],
    ["Gastos totales", money(k.gastosTotal)],
    ["Utilidad", money(k.utilidad)],
    ["Saldo pendiente", money(k.saldoPendiente)],
    ["Delivery cobrado", money(k.deliveryCobrado)],
    ["Costo delivery", money(k.deliveryCosto)],
    ["Margen delivery", money(k.margenDelivery)],
    ["Clientes (total hoja ventas)", intFmt(k.clientesTotalHojaVentas)],
    ["Clientes (periodo)", intFmt(k.clientesPeriodo)],
    ["Pedidos cerrados", intFmt(k.pedidosCerrados)],
    ["Promedio diario", money(k.promedioDiario)],
    ["Proyección mensual", money(k.proyeccionMensual)],
    ["Boletas / Facturas", `${intFmt(k.boletas)} / ${intFmt(k.facturas)}`],
    ["Servicios pendientes", money(k.serviciosPendientesMonto)]
  ];

  const box = el("kpis");
  box.innerHTML = "";
  map.forEach(([t,v])=>{
    const d = document.createElement("div");
    d.className="card";
    d.innerHTML = `<div class="k">${t}</div><div class="v">${v}</div>`;
    box.appendChild(d);
  });
}

function renderCharts(s){
  const labels = s.days || [];
  const ventas = labels.map(d=>Number(s.ventasPorDia[d]||0));
  const gastos = labels.map(d=>Number(s.gastosPorDia[d]||0));
  const saldo  = labels.map(d=>Number(s.saldoPorDia[d]||0));

  if(chart1) chart1.destroy();
  chart1 = new Chart(el("chart1"),{
    type:"line",
    data:{labels, datasets:[
      {label:"Ventas", data:ventas, borderWidth:2},
      {label:"Gastos", data:gastos, borderWidth:2},
      {label:"Saldo", data:saldo, borderWidth:2},
    ]},
    options:{responsive:true, plugins:{legend:{position:"bottom"}}}
  });

  if(chart2) chart2.destroy();
  chart2 = new Chart(el("chart2"),{
    type:"line",
    data:{labels: (s.acumulado||[]).map(x=>x.date),
      datasets:[{label:"Acumulado", data:(s.acumulado||[]).map(x=>x.value), borderWidth:2}]},
    options:{responsive:true, plugins:{legend:{position:"bottom"}}}
  });
}

function table(id, headers, rows){
  const t = el(id);
  const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
  const tbody = `<tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("")}</tbody>`;
  t.innerHTML = thead + tbody;
}

function renderAll(d){
  renderKPIs(d.kpis);
  renderCharts(d.series);

  // Alertas
  el("alertasBox").innerHTML = `
    <p><b>Comprobantes pendientes:</b> ${intFmt(d.alertas.comprobantesPendientes)}</p>
    <p><b>Saldo pendiente:</b> ${money(d.alertas.saldoPendiente)}</p>
    <p><b>Servicios pendientes:</b> ${intFmt(d.alertas.serviciosPendientesCant)} (${money(d.alertas.serviciosPendientesMonto)})</p>
  `;

  // Distritos
  table("tblDistritos",
    ["Distrito","Cantidad","Monto (aprox delivery)"],
    (d.tables.distritos||[]).slice(0,50).map(x=>[
      x.name, intFmt(x.cant), money(x.monto)
    ])
  );

  // Vendedoras
  const vend = d.tables.vendedoras||[];
  const totVentas = vend.reduce((a,b)=>a+Number(b.ventas||0),0);
  const totSaldo = vend.reduce((a,b)=>a+Number(b.saldo||0),0);
  const totPedidos = vend.reduce((a,b)=>a+Number(b.pedidos||0),0);
  el("vendTot").innerHTML = `<p><b>Total periodo:</b> Ventas ${money(totVentas)} | Saldo ${money(totSaldo)} | Pedidos ${intFmt(totPedidos)}</p>`;
  table("tblVend", ["Fecha","Vendedora","Ventas","Saldo","Pedidos"], vend.map(x=>[
    x.date, x.vendedor, money(x.ventas), money(x.saldo), intFmt(x.pedidos)
  ]));

  // Delivery
  table("tblDelDia",
    ["Fecha","Cobrado","Costo","Entregas","Recojo tienda"],
    (d.tables.deliveryDia||[]).map(x=>[
      x.date, money(x.cobrado), money(x.costo), intFmt(x.cant), intFmt(x.recojo)
    ])
  );
  table("tblDelRep",
    ["Repartidor","Cobrado","Costo","Entregas","Margen"],
    (d.tables.deliveryRepartidor||[]).map(x=>[
      x.name, money(x.cobrado), money(x.costo), intFmt(x.cant), money((x.cobrado||0)-(x.costo||0))
    ])
  );

  // Productos
  table("tblProdMonto", ["Producto","Monto"], (d.tables.topProductosMonto||[]).map(x=>[x.name, money(x.value)]));
  table("tblProdCant",  ["Producto","Cantidad"], (d.tables.topProductosCant||[]).map(x=>[x.name, intFmt(x.value)]));

  // Clientes
  table("tblCli", ["Cliente","Doc","Celular","Última compra"], (d.tables.clientes||[]).slice(0,200).map(x=>[
    x.cliente, x.doc, x.celular, x.ultimaCompra || ""
  ]));

  // Gastos
  table("tblGastos", ["Categoría","Cantidad","Monto"], (d.tables.gastosCategoria||[]).map(x=>[
    x.categoria, intFmt(x.cantidad), money(x.monto)
  ]));

  // Medios de pago
  table("tblMP", ["Cuenta","Tipo","Monto"], (d.tables.mediosPago||[]).map(x=>[
    x.cuenta, x.tipo, money(x.monto)
  ]));

  // Servicios
  table("tblServ", ["Servicio","Fecha","Monto","Estado","Medio"], (d.tables.servicios||[]).map(x=>[
    x.servicio, x.fecha||"", money(x.monto), x.estado, x.medio
  ]));
}

async function load(){
  showError("");
  const q = buildQuery();
  const url = API_URL + (q ? ("?"+q) : "");
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(data.error){
      showError("Error Apps Script: " + data.error);
      return;
    }
    renderAll(data);
  }catch(err){
    showError("No se pudo cargar data desde Apps Script: " + err.message);
  }
}

el("btn").addEventListener("click", load);

renderTabs();
setModeUI();

// mes por defecto: actual
const now = new Date();
el("month").value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
load();
</script>
</body>
</html>
