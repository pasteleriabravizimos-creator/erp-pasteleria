<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BRAVIZIMO'S | Dashboard Financiero</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg1:#0b1020; --bg2:#120a2b;
      --card:rgba(255,255,255,.06);
      --txt:rgba(255,255,255,.92);
      --mut:rgba(255,255,255,.65);
      --line:rgba(255,255,255,.10);
      --ok:#24d17e; --warn:#ffd34d; --bad:#ff4d6d;
      --btn:rgba(255,255,255,.10);
      --btn2:rgba(255,255,255,.16);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:radial-gradient(1200px 700px at 30% 10%, #21325c 0%, rgba(33,50,92,0) 60%),
                 radial-gradient(900px 600px at 70% 20%, #4b1b74 0%, rgba(75,27,116,0) 60%),
                 linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px; margin:30px auto; padding:0 16px}
    .title{font-weight:800; letter-spacing:.4px}
    .sub{color:var(--mut); margin-top:2px; font-size:13px}
    .bar{
      margin-top:14px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius:14px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background:rgba(0,0,0,.18);
    }
    .badge.ok{border-color:rgba(36,209,126,.35)}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    select, button{
      color:var(--txt);
      background:var(--btn);
      border:1px solid var(--line);
      border-radius:10px;
      padding:8px 10px;
      outline:none;
    }
    button{cursor:pointer}
    button:hover{background:var(--btn2)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tab{
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{background:rgba(255,255,255,.14)}
    .grid{
      margin-top:12px;
      display:grid; gap:12px;
      grid-template-columns:repeat(4,1fr);
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius:16px;
      padding:12px;
      overflow:hidden;
    }
    .k{font-size:12px; color:var(--mut)}
    .bigNumber{font-size:22px; font-weight:800; margin-top:4px}
    .span2{grid-column:span 2}
    .span4{grid-column:span 4}
    .chartBox{height:300px}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:6px}
    .pillRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
      background:rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
    }
    table{width:100%; border-collapse:collapse; font-size:12px}
    th,td{padding:8px 8px; border-bottom:1px solid var(--line); text-align:left}
    th{color:var(--mut); font-weight:700}
    .mut{color:var(--mut)}
    @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr} .span2,.span4{grid-column:span 1} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">BRAVIZIMO'S | Dashboard Financiero</div>
    <div class="sub">Sincronizado con Google Sheets (Apps Script)</div>

    <div class="bar">
      <div id="status" class="badge">Cargando...</div>

      <div class="row">
        <span class="mut" style="font-size:12px;">Modo</span>
        <select id="mode">
          <option value="month" selected>Mes</option>
        </select>

        <span class="mut" style="font-size:12px;">Mes</span>
        <select id="month"></select>

        <span class="mut" style="font-size:12px;">Año</span>
        <select id="year"></select>

        <button id="btnUpdate">Actualizar</button>
        <button id="btnPing">Probar API</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="finanzas">Finanzas</div>
      <div class="tab" data-tab="delivery">Delivery</div>
      <div class="tab" data-tab="clientes">Clientes</div>
      <div class="tab" data-tab="gastos">Gastos</div>
      <div class="tab" data-tab="servicios">Servicios</div>
    </div>

    <div id="view"></div>
  </div>

<script>
/** ✅ PON AQUÍ TU URL DE APPS SCRIPT (DEPLOY -> WEB APP) **/
const API_URL = "https://script.google.com/macros/s/AKfycbxQ_TLzOY1fDpxx2ruyT1KrhgoM955fnxoqBrWYFhyyiLID8b374nv7yNvYbJHiuqaY/exec";

let currentTab = "finanzas";
let lastData = null;
let charts = {};

const money = (n)=> "S/ " + (Number(n||0).toLocaleString("es-PE",{minimumFractionDigits:2, maximumFractionDigits:2}));
const esc = (s)=> String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
const setStatus = (txt, ok=null)=>{
  const el=document.getElementById("status");
  el.textContent = txt;
  el.className = "badge" + (ok===true ? " ok" : "");
};

function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }

(function initFilters(){
  const monthSel=document.getElementById("month");
  const yearSel=document.getElementById("year");
  const months=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  months.forEach((m,i)=>{
    const o=document.createElement("option");
    o.value=String(i+1);
    o.textContent=m;
    monthSel.appendChild(o);
  });
  const now=new Date();
  monthSel.value=String(now.getMonth()+1);

  const y0=now.getFullYear()-3;
  for(let y=y0;y<=now.getFullYear()+1;y++){
    const o=document.createElement("option");
    o.value=String(y);
    o.textContent=String(y);
    yearSel.appendChild(o);
  }
  yearSel.value=String(now.getFullYear());
})();

document.getElementById("tabs").addEventListener("click",(e)=>{
  const t=e.target.closest(".tab");
  if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  currentTab = t.dataset.tab;
  if(lastData) renderAll(lastData);
});

document.getElementById("btnPing").addEventListener("click", async ()=>{
  setStatus("Probando API...");
  const url = API_URL + "?action=ping&callback=?";
  try{
    const res = await jsonp(url);
    if(res.ok) setStatus("OK ✅ " + (res.now || ""), true);
    else setStatus("ERROR: " + (res.error || "ping"));
  }catch(err){
    setStatus("ERROR: " + err.message);
  }
});
document.getElementById("btnUpdate").addEventListener("click", ()=> loadData());

function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(16).slice(2);
    const s = document.createElement("script");
    const timer = setTimeout(()=>{
      cleanup(); reject(new Error("Timeout"));
    }, 20000);

    function cleanup(){
      clearTimeout(timer);
      delete window[cb];
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    window[cb] = (data)=>{ cleanup(); resolve(data); };
    s.onerror = ()=>{ cleanup(); reject(new Error("Error cargando JSONP")); };

    s.src = url.replace("callback=?", "callback="+cb);
    document.body.appendChild(s);
  });
}

async function loadData(){
  setStatus("Cargando...");
  const month = document.getElementById("month").value;
  const year = document.getElementById("year").value;

  const url = API_URL + `?action=dashboard&month=${encodeURIComponent(month)}&year=${encodeURIComponent(year)}&callback=?`;

  try{
    const data = await jsonp(url);
    if(!data.ok) throw new Error(data.error || "Error API");
    lastData = data;
    setStatus("OK ✅ Actualizado", true);
    renderAll(data);
  }catch(err){
    setStatus("ERROR: " + err.message);
    document.getElementById("view").innerHTML = "";
  }
}

function renderAll(data){
  // en este index dejamos charts solo si luego vuelves a ponerlos
  ["ch_fin1","ch_fin2","ch_g1"].forEach(destroyChart);

  if(currentTab === "finanzas") {
    document.getElementById("view").innerHTML = `<div class="card span4"><div class="k">Finanzas</div><div class="mut">Este index solo actualiza el módulo Servicios (lo demás lo tienes perfecto en tu versión). Si quieres, te vuelvo a pegar el index 100% completo con todos los módulos como el anterior.</div></div>`;
  }
  else if(currentTab === "delivery") {
    document.getElementById("view").innerHTML = `<div class="card span4"><div class="k">Delivery</div><div class="mut">Tu módulo Delivery ya está OK en tu versión anterior. Si deseas, lo integro aquí igual.</div></div>`;
  }
  else if(currentTab === "clientes") {
    document.getElementById("view").innerHTML = `<div class="card span4"><div class="k">Clientes</div><div class="mut">Tu módulo Clientes ya está OK en tu versión anterior. Si deseas, lo integro aquí igual.</div></div>`;
  }
  else if(currentTab === "gastos") {
    document.getElementById("view").innerHTML = `<div class="card span4"><div class="k">Gastos</div><div class="mut">Tu módulo Gastos ya está OK en tu versión anterior. Si deseas, lo integro aquí igual.</div></div>`;
  }
  else if(currentTab === "servicios") renderServicios(data);
}

/** ✅ SERVICIOS (ACTUALIZADO) **/
function renderServicios(data){
  const mod = data.modules?.servicios || {};
  const a = mod.alertas || {};
  const p = mod.pendientes || [];

  const html = `
    <div class="grid">
      <div class="card span2">
        <div class="k">Resumen alertas (PENDIENTE)</div>
        <div class="list" style="margin-top:10px;">
          <div class="pillRow"><b>Vencidos</b><span>${a.vencidos?.count||0} | ${money(a.vencidos?.total||0)}</span></div>
          <div class="pillRow"><b>Hoy</b><span>${a.hoy?.count||0} | ${money(a.hoy?.total||0)}</span></div>
          <div class="pillRow"><b>Próximos</b><span>${a.proximos?.count||0} | ${money(a.proximos?.total||0)}</span></div>
        </div>
        <div class="mut" style="font-size:12px;margin-top:8px;">
          *Se calcula desde la hoja <b>servicios</b> usando: <b>FECHA DE PAGO, PAGA, DESCRIPCIÓN, MONTO, ESTADO</b>.
        </div>
      </div>

      <div class="card span2">
        <div class="k">Pendientes (detalle)</div>
        <div style="overflow:auto; margin-top:10px; max-height:420px;">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Monto</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              ${p.length ? p.map(x=>`
                <tr>
                  <td>${esc(x.fecha||"")}</td>
                  <td>${esc(x.tipo||"")}</td>
                  <td><b>${esc(x.descripcion||"")}</b></td>
                  <td>${money(x.monto||0)}</td>
                  <td>${esc(x.estado||"")}</td>
                </tr>
              `).join("") : `
                <tr><td colspan="5" class="mut">No hay pendientes en este período.</td></tr>
              `}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  document.getElementById("view").innerHTML = html;
}

loadData();
</script>
</body>
</html>
