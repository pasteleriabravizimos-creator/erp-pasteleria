<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BRAVIZIMO'S | Dashboard Financiero</title>

  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --shadow:0 10px 25px rgba(15,23,42,.08);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:var(--bg);color:var(--text);}
    header{
      background: radial-gradient(1200px 500px at 70% 10%, #2b3a55 0%, #0b1220 55%, #05070e 100%);
      color:#fff;padding:22px 22px 18px;
      position:sticky;top:0;z-index:10;
      box-shadow: var(--shadow);
    }
    header .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    h1{font-size:18px;margin:0;}
    .sub{font-size:12px;opacity:.85;margin-top:4px;}
    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    select,input,button{
      border-radius:999px;border:1px solid rgba(255,255,255,.22);
      padding:10px 12px;background:rgba(255,255,255,.08);color:#fff;outline:none;
    }
    input{width:150px}
    button{background:#fff;color:#0b1220;border:none;font-weight:700;cursor:pointer}
    button:hover{opacity:.9}

    main{max-width:1200px;margin:18px auto;padding:0 16px 60px;}
    .error{display:none;background:#ffe4e6;color:#9f1239;border:1px solid #fecdd3;padding:10px 12px;border-radius:999px;margin:10px 0;}
    .grid-kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:14px;}
    .card{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:14px 14px;
    }
    .kpi-title{font-size:12px;color:var(--muted);margin:0 0 6px}
    .kpi-value{font-size:20px;font-weight:800;margin:0}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0 10px;}
    .tab{background:#fff;border:1px solid #e2e8f0;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700;font-size:12px;}
    .tab.active{background:#0b1220;color:#fff;border-color:#0b1220;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .grid-1{display:grid;grid-template-columns:1fr;gap:12px;}
    .table{width:100%;border-collapse:collapse;font-size:12px;}
    .table th,.table td{padding:10px;border-bottom:1px solid #eef2f7;text-align:left;}
    .table th{color:var(--muted);font-weight:800;font-size:11px;text-transform:uppercase;}
    .muted{color:var(--muted);font-size:12px;}
    .foot{margin-top:10px;color:var(--muted);font-size:12px;}
    @media(max-width:980px){.grid-kpi{grid-template-columns:repeat(2,1fr)} .grid-2{grid-template-columns:1fr}}
  </style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <h1>BRAVIZIMO'S | Dashboard Financiero</h1>
      <div class="sub">Sincronizado con Google Sheets (Apps Script)</div>
    </div>
    <div class="filters">
      <select id="mode">
        <option value="month">Mes</option>
        <option value="range">Rango</option>
      </select>
      <input id="month" type="month" />
      <input id="from" type="date" style="display:none;" />
      <input id="to" type="date" style="display:none;" />
      <button id="btn">Actualizar</button>
    </div>
  </div>
</header>

<main>
  <div id="err" class="error"></div>

  <div class="grid-kpi" id="kpis">
    <!-- KPI cards -->
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" data-view="finanzas">Finanzas</div>
    <div class="tab" data-view="alertas">Alertas</div>
    <div class="tab" data-view="distritos">Distritos</div>
    <div class="tab" data-view="vendedoras">Vendedoras</div>
    <div class="tab" data-view="delivery">Delivery</div>
    <div class="tab" data-view="productos">Productos</div>
    <div class="tab" data-view="clientes">Clientes</div>
    <div class="tab" data-view="gastos">Gastos</div>
    <div class="tab" data-view="medios">Medios de pago</div>
    <div class="tab" data-view="servicios">Servicios</div>
  </div>

  <section id="view-finanzas" class="grid-2">
    <div class="card">
      <h3>Ventas vs Gastos (por d√≠a) + Saldo</h3>
      <div id="chart-finanzas" style="height:320px;"></div>
    </div>
    <div class="card">
      <h3>Acumulado de ventas</h3>
      <div id="chart-acumulado" style="height:320px;"></div>
    </div>
  </section>

  <section id="view-alertas" class="grid-1" style="display:none;">
    <div class="card">
      <h3>Alertas</h3>
      <div id="alertasBox" class="muted"></div>
    </div>
  </section>

  <section id="view-distritos" class="grid-1" style="display:none;">
    <div class="card">
      <h3>Ranking por distrito (monto y veces)</h3>
      <table class="table" id="tbl-distritos"></table>
    </div>
  </section>

  <section id="view-vendedoras" class="grid-1" style="display:none;">
    <div class="card">
      <h3>Vendedoras por d√≠a (ventas, saldo, pedidos)</h3>
      <table class="table" id="tbl-vendedoras"></table>
    </div>
  </section>

  <section id="view-delivery" class="grid-2" style="display:none;">
    <div class="card">
      <h3>Delivery vs Costo (por d√≠a)</h3>
      <div id="chart-delivery-dia" style="height:320px;"></div>
    </div>
    <div class="card">
      <h3>Delivery por motorizado</h3>
      <table class="table" id="tbl-delivery-mot"></table>
    </div>
  </section>

  <section id="view-productos" class="grid-1" style="display:none;">
    <div class="card">
      <h3>Top 20 productos (seg√∫n fecha de entrega)</h3>
      <div id="chart-top-prod" style="height:360px;"></div>
      <table class="table" id="tbl-top-prod"></table>
    </div>
  </section>

  <section id="view-clientes" class="grid-1" style="display:none;">
    <div class="card">
      <h3>Clientes (se toma el total de clientes √∫nicos del periodo desde Nota de Ventas)</h3>
      <div class="muted" id="clientesInfo"></div>
    </div>
  </section>

  <section id="view-gastos" class="grid-1" style="display:none;">
    <div class="card">
      <h3>Gastos por categor√≠a</h3>
      <div id="chart-gastos-cat" style="height:320px;"></div>
      <table class="table" id="tbl-gastos-cat"></table>
    </div>
  </section>

  <section id="view-medios" class="grid-1" style="display:none;">
    <div class="card">
      <h3>Medios de pago (suma 1er pago + 2do pago)</h3>
      <table class="table" id="tbl-medios"></table>
    </div>
  </section>

  <section id="view-servicios" class="grid-1" style="display:none;">
    <div class="card">
      <h3>Servicios (pendiente / pagado)</h3>
      <div class="muted" id="serviciosKpi"></div>
      <table class="table" id="tbl-servicios"></table>
    </div>
  </section>

  <div class="foot" id="updated"></div>
</main>

<script>
  // üî• PEGA TU URL /exec AQU√ç:
  const API_URL = "https://script.google.com/macros/s/AKfycbyydt-z7J02V5uuVbyh_AQjWfP6b5ncI9mxWw2CWqnY2ywQ7cDweD4NeqBB7yyZYUaa/exec";

  google.charts.load('current', {'packages':['corechart','bar']});

  const $ = (id)=>document.getElementById(id);
  const errBox = $("err");

  function showError(msg){
    if(!msg){ errBox.style.display="none"; errBox.textContent=""; return; }
    errBox.style.display="block";
    errBox.textContent = msg;
  }

  function money(n){
    const x = Number(n||0);
    return "S/ " + x.toLocaleString("es-PE",{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function buildQuery(){
    const mode = $("mode").value;
    const params = new URLSearchParams();
    params.set("mode", mode);

    if(mode==="month"){
      const m = $("month").value; // yyyy-mm
      if(m) params.set("month", m);
    }else{
      const f = $("from").value;
      const t = $("to").value;
      if(f) params.set("from", f);
      if(t) params.set("to", t);
    }
    return params.toString();
  }

  async function fetchJSON(){
    const url = API_URL + "?" + buildQuery();
    const res = await fetch(url, { redirect:"follow" });
    const text = await res.text();

    // si devuelve HTML -> este error te muestra el inicio
    try{
      return JSON.parse(text);
    }catch(e){
      throw new Error("Apps Script no devolvi√≥ JSON. Respuesta inicia: " + text.slice(0,100));
    }
  }

  function renderKpis(k){
    const cards = [
      ["Ventas totales", money(k.ventasTotal)],
      ["Gastos totales", money(k.gastosTotal)],
      ["Utilidad", money(k.utilidad)],
      ["Saldo pendiente", money(k.saldoPendiente)],
      ["Delivery cobrado", money(k.deliveryCobrado)],
      ["Costo delivery", money(k.costoDelivery)],
      ["Margen delivery", money(k.margenDelivery)],
      ["Clientes (periodo)", (k.clientesPeriodo||0).toLocaleString("es-PE")],
      ["Promedio diario", money(k.promedioDiario)],
      ["Proyecci√≥n mensual", money(k.proyeccionMensual)],
      ["Boletas / Facturas", (k.boletas||0) + " / " + (k.facturas||0)],
      ["Pendientes comprobante", (k.pendientesComprobante||0).toLocaleString("es-PE")],
    ];

    $("kpis").innerHTML = cards.map(([t,v])=>`
      <div class="card">
        <p class="kpi-title">${t}</p>
        <p class="kpi-value">${v}</p>
      </div>
    `).join("");
  }

  function drawFinanzas(series){
    const data = new google.visualization.DataTable();
    data.addColumn('string','Fecha');
    data.addColumn('number','Ventas');
    data.addColumn('number','Gastos');
    data.addColumn('number','Saldo');

    series.forEach(r=>{
      data.addRow([r.date, r.ventas, r.gastos, r.saldo]);
    });

    const chart = new google.visualization.LineChart($("chart-finanzas"));
    chart.draw(data, { legend:{position:'bottom'}, chartArea:{left:50,top:20,width:'85%',height:'70%'} });
  }

  function drawAcumulado(series){
    const data = new google.visualization.DataTable();
    data.addColumn('string','Fecha');
    data.addColumn('number','Acumulado');
    series.forEach(r=>data.addRow([r.date, r.acumulado]));
    const chart = new google.visualization.LineChart($("chart-acumulado"));
    chart.draw(data, { legend:{position:'bottom'}, chartArea:{left:50,top:20,width:'85%',height:'70%'} });
  }

  function drawDeliveryDia(rows){
    const data = new google.visualization.DataTable();
    data.addColumn('string','Fecha');
    data.addColumn('number','Delivery cobrado');
    data.addColumn('number','Costo delivery');
    rows.forEach(r=>data.addRow([r.date, r.deliveryCobrado, r.costoDelivery]));
    const chart = new google.visualization.ColumnChart($("chart-delivery-dia"));
    chart.draw(data, { legend:{position:'bottom'}, chartArea:{left:60,top:20,width:'80%',height:'70%'} });
  }

  function drawGastosCat(rows){
    const data = new google.visualization.DataTable();
    data.addColumn('string','Categor√≠a');
    data.addColumn('number','Monto');
    rows.slice(0,12).forEach(r=>data.addRow([r.categoria, r.monto]));
    const chart = new google.visualization.PieChart($("chart-gastos-cat"));
    chart.draw(data, { legend:{position:'right'} });
  }

  function drawTopProductos(rows){
    const data = new google.visualization.DataTable();
    data.addColumn('string','Producto');
    data.addColumn('number','Monto');
    rows.forEach(r=>data.addRow([r.producto, r.monto]));
    const chart = new google.visualization.BarChart($("chart-top-prod"));
    chart.draw(data, { legend:{position:'none'}, chartArea:{left:220,top:20,width:'70%',height:'80%'} });
  }

  function table(el, cols, rows){
    const thead = `<tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr>`;
    const body = rows.map(r=>`<tr>${cols.map(c=>`<td>${r[c] ?? ""}</td>`).join("")}</tr>`).join("");
    el.innerHTML = thead + body;
  }

  function renderAll(payload){
    const {kpis, series, tables, alertas, updatedAt, period} = payload;

    renderKpis(kpis);

    // finanzas charts
    drawFinanzas(series.finanzasPorDia || []);
    drawAcumulado(series.acumuladoVentas || []);

    // delivery
    drawDeliveryDia(series.deliveryPorDia || []);
    table($("tbl-delivery-mot"),
      ["motorizado","deliveryCobrado","costoDelivery","entregas"],
      (tables.deliveryMotorizado||[]).map(x=>({
        motorizado:x.motorizado,
        deliveryCobrado:money(x.deliveryCobrado),
        costoDelivery:money(x.costoDelivery),
        entregas:x.entregas
      }))
    );

    // distritos
    table($("tbl-distritos"),
      ["distrito","monto","veces"],
      (tables.distritosRanking||[]).slice(0,50).map(x=>({
        distrito:x.distrito,
        monto:money(x.monto),
        veces:x.veces
      }))
    );

    // vendedoras
    table($("tbl-vendedoras"),
      ["date","seller","ventas","saldo","pedidos"],
      (tables.vendedorasDia||[]).map(x=>({
        date:x.date,
        seller:x.seller,
        ventas:money(x.ventas),
        saldo:money(x.saldo),
        pedidos:x.pedidos
      }))
    );

    // productos
    drawTopProductos(tables.topProductos||[]);
    table($("tbl-top-prod"),
      ["producto","cantidad","monto"],
      (tables.topProductos||[]).map(x=>({
        producto:x.producto,
        cantidad:(x.cantidad||0).toLocaleString("es-PE"),
        monto:money(x.monto)
      }))
    );

    // gastos
    drawGastosCat(tables.gastosPorCategoria||[]);
    table($("tbl-gastos-cat"),
      ["categoria","cantidad","monto"],
      (tables.gastosPorCategoria||[]).map(x=>({
        categoria:x.categoria,
        cantidad:x.cantidad,
        monto:money(x.monto)
      }))
    );

    // medios pago
    table($("tbl-medios"),
      ["cuenta","monto"],
      (tables.mediosPago||[]).map(x=>({
        cuenta:x.cuenta,
        monto:money(x.monto)
      }))
    );

    // servicios
    $("serviciosKpi").textContent =
      `Total: ${money(tables.serviciosKpi?.total)} | Pendiente: ${money(tables.serviciosKpi?.pendientes)} | Pagado: ${money(tables.serviciosKpi?.pagados)}`;

    table($("tbl-servicios"),
      ["fecha","servicio","estado","monto"],
      (tables.serviciosLista||[]).map(x=>({
        fecha:x.fecha,
        servicio:x.servicio,
        estado:x.estado,
        monto:money(x.monto)
      }))
    );

    // clientes
    $("clientesInfo").textContent =
      `Clientes √∫nicos en el periodo: ${(kpis.clientesPeriodo||0).toLocaleString("es-PE")}`;

    // alertas
    $("alertasBox").innerHTML = `
      <b>Comprobantes pendientes:</b> ${alertas.pendientesComprobante}<br/>
      <b>Boletas:</b> ${alertas.boletas} &nbsp; <b>Facturas:</b> ${alertas.facturas}<br/>
      <b>Clientes √∫nicos (periodo):</b> ${alertas.clientesPeriodo}
    `;

    $("updated").textContent =
      `Periodo: ${period.from} ‚Üí ${period.to} | Actualizado: ${updatedAt}`;
  }

  function setModeUI(){
    const mode = $("mode").value;
    $("month").style.display = (mode==="month") ? "" : "none";
    $("from").style.display = (mode==="range") ? "" : "none";
    $("to").style.display = (mode==="range") ? "" : "none";
  }

  function setTabs(){
    $("tabs").addEventListener("click",(e)=>{
      const t = e.target.closest(".tab");
      if(!t) return;
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");

      const view = t.dataset.view;
      document.querySelectorAll("section[id^='view-']").forEach(s=>s.style.display="none");
      $("view-"+view).style.display="";
    });
  }

  async function load(){
    showError("");
    try{
      const data = await fetchJSON();
      if(data.error) { showError("Error Apps Script: " + data.error); return; }
      google.charts.setOnLoadCallback(()=>renderAll(data));
    }catch(err){
      showError("No se pudo cargar data desde Apps Script: " + err.message);
    }
  }

  // init
  (function init(){
    const now = new Date();
    const ym = now.toISOString().slice(0,7);
    $("month").value = ym;
    $("mode").addEventListener("change", ()=>{ setModeUI(); });
    $("btn").addEventListener("click", load);
    setModeUI();
    setTabs();
    // primer load
    load();
  })();
</script>
</body>
</html>
