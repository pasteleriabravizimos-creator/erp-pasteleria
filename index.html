<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Servicios</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

  <style>
    body { background:#f8fafc; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>

<body class="min-h-screen">
  <nav class="gradient-bg text-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="font-bold text-lg">Gestión de Servicios</div>
      <div class="flex gap-3 items-center">
        <button class="px-3 py-2 rounded hover:bg-white/10" onclick="showTab('servicios')">Servicios</button>
        <button class="px-3 py-2 rounded hover:bg-white/10" onclick="showTab('dashboard')">Dashboard</button>
        <button class="px-3 py-2 rounded hover:bg-white/10" onclick="showTab('historial')">Historial</button>
        <button class="px-3 py-2 rounded hover:bg-white/10" onclick="openConfig()">⚙️</button>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-4 md:p-8">

    <!-- TAB: SERVICIOS -->
    <section id="tab-servicios" class="space-y-6">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">Nuevo / Editar Servicio</h2>
          <button class="text-sm px-3 py-2 rounded border" onclick="resetForm()">Limpiar</button>
        </div>

        <form id="formServicio" class="grid grid-cols-1 md:grid-cols-3 gap-4" onsubmit="saveServicio(event)">
          <div>
            <label class="text-sm font-medium">Código *</label>
            <input id="codigo" required class="w-full border rounded px-3 py-2" placeholder="SRV-001"/>
          </div>
          <div>
            <label class="text-sm font-medium">Proveedor *</label>
            <input id="proveedor" required class="w-full border rounded px-3 py-2" placeholder="Movistar"/>
          </div>
          <div>
            <label class="text-sm font-medium">Servicio *</label>
            <input id="servicio" required class="w-full border rounded px-3 py-2" placeholder="Internet Fibra 100Mbps"/>
          </div>

          <div>
            <label class="text-sm font-medium">Categoría</label>
            <select id="categoria" class="w-full border rounded px-3 py-2">
              <option value="">Seleccionar…</option>
              <option>Internet</option><option>Telefonía</option><option>Software</option><option>Energía</option><option>Otros</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">Monto (S/) *</label>
            <input id="monto" type="number" step="0.01" required class="w-full border rounded px-3 py-2" placeholder="1200"/>
          </div>

          <div class="flex items-center gap-2 mt-6">
            <input id="montoVariable" type="checkbox" class="w-4 h-4"/>
            <label class="text-sm">Monto variable</label>
          </div>

          <div>
            <label class="text-sm font-medium">Fecha Servicio</label>
            <input id="fechaServicio" class="w-full border rounded px-3 py-2" placeholder="yyyy-mm-dd"/>
          </div>
          <div>
            <label class="text-sm font-medium">Fecha Vencimiento</label>
            <input id="fechaVencimiento" class="w-full border rounded px-3 py-2" placeholder="yyyy-mm-dd"/>
          </div>
          <div>
            <label class="text-sm font-medium">Fecha Pago</label>
            <input id="fechaPago" class="w-full border rounded px-3 py-2" placeholder="yyyy-mm-dd"/>
          </div>

          <div>
            <label class="text-sm font-medium">Estado *</label>
            <select id="estado" required class="w-full border rounded px-3 py-2">
              <option>PENDIENTE</option>
              <option>FALTA PAGAR</option>
              <option>PAGADO</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">Medio de Pago</label>
            <select id="medioPago" class="w-full border rounded px-3 py-2">
              <option value="">Seleccionar…</option>
              <option>BCP</option><option>YAPE</option><option>PLIN</option><option>Efectivo</option><option>Transferencia</option><option>Tarjeta</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Cuenta</label>
            <input id="cuenta" class="w-full border rounded px-3 py-2" placeholder="N° cuenta / cel"/>
          </div>

          <div class="md:col-span-3">
            <label class="text-sm font-medium">Observaciones</label>
            <textarea id="observaciones" class="w-full border rounded px-3 py-2" rows="2"></textarea>
          </div>

          <div>
            <label class="text-sm font-medium">Voucher (1 archivo)</label>
            <input id="voucher" type="file" accept="image/*,application/pdf" class="w-full"/>
          </div>

          <div class="md:col-span-2">
            <label class="text-sm font-medium">Recibo/Contrato/Otros (múltiples)</label>
            <input id="docs" type="file" multiple accept="image/*,application/pdf" class="w-full"/>
          </div>

          <div class="md:col-span-3 flex gap-3 pt-2">
            <button class="gradient-bg text-white px-4 py-3 rounded-lg font-semibold" type="submit">
              Guardar Servicio
            </button>
            <button class="px-4 py-3 rounded-lg border" type="button" onclick="resetForm()">Cancelar</button>
          </div>
        </form>
      </div>

      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">Todos los Servicios</h2>
          <div class="flex gap-2">
            <input id="search" class="border rounded px-3 py-2" placeholder="Buscar…" onkeyup="renderServicios()"/>
            <select id="filterEstado" class="border rounded px-3 py-2" onchange="renderServicios()">
              <option value="">Todos</option>
              <option>PAGADO</option>
              <option>PENDIENTE</option>
              <option>FALTA PAGAR</option>
            </select>
          </div>
        </div>

        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50">
              <tr>
                <th class="p-2 text-left">Código</th>
                <th class="p-2 text-left">Proveedor</th>
                <th class="p-2 text-left">Servicio</th>
                <th class="p-2 text-left">Monto</th>
                <th class="p-2 text-left">Estado</th>
                <th class="p-2 text-left">Docs</th>
                <th class="p-2 text-left">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyServicios"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TAB: DASHBOARD -->
    <section id="tab-dashboard" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-slate-500">Total</div><div id="kpiTotal" class="text-2xl font-bold">0</div></div>
        <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-slate-500">Pagados</div><div id="kpiPagados" class="text-2xl font-bold text-green-600">0</div></div>
        <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-slate-500">Pendientes</div><div id="kpiPendientes" class="text-2xl font-bold text-yellow-600">0</div></div>
        <div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-slate-500">Avance</div><div id="kpiAvance" class="text-2xl font-bold">0%</div></div>
      </div>

      <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-2xl font-bold mb-4">Estado de Servicios</h2>
        <canvas id="chartEstado"></canvas>
      </div>
    </section>

    <!-- TAB: HISTORIAL -->
    <section id="tab-historial" class="hidden space-y-6">
      <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold">Historial</h2>
          <button class="px-3 py-2 rounded border" onclick="loadHistorial()">Recargar</button>
        </div>

        <div class="overflow-auto">
          <table class="w-full text-sm">
            <thead class="bg-slate-50">
              <tr>
                <th class="p-2 text-left">Fecha/Hora</th>
                <th class="p-2 text-left">Código</th>
                <th class="p-2 text-left">Proveedor</th>
                <th class="p-2 text-left">Servicio</th>
                <th class="p-2 text-left">Monto</th>
                <th class="p-2 text-left">Estado</th>
                <th class="p-2 text-left">Voucher</th>
                <th class="p-2 text-left">Docs</th>
              </tr>
            </thead>
            <tbody id="tbodyHistorial"></tbody>
          </table>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL CONFIG -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow max-w-lg w-full p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold">Configuración</h3>
        <button onclick="closeConfig()" class="text-slate-500">✖</button>
      </div>

      <label class="text-sm font-medium">URL Web App (Apps Script) *</label>
      <input id="webAppUrl" class="w-full border rounded px-3 py-2 mt-1"
        placeholder="https://script.google.com/macros/s/.../exec" />

      <p class="text-xs text-slate-500 mt-2">
        *Debe terminar en <b>/exec</b>. No pegues solo el ID "AKfycb...".
      </p>

      <button class="gradient-bg text-white px-4 py-3 rounded-lg font-semibold w-full mt-4"
        onclick="saveConfig()">Guardar</button>
    </div>
  </div>

<script>
  // ===== CONFIG =====
  let WEB_APP_URL = localStorage.getItem('webAppUrl') || '';
  let servicios = [];
  let historial = [];
  let chart = null;

  // flatpickr
  flatpickr("#fechaServicio", { locale:"es", dateFormat:"Y-m-d" });
  flatpickr("#fechaPago", { locale:"es", dateFormat:"Y-m-d" });
  flatpickr("#fechaVencimiento", { locale:"es", dateFormat:"Y-m-d" });

  function openConfig(){ document.getElementById('modal').classList.remove('hidden'); document.getElementById('modal').classList.add('flex'); document.getElementById('webAppUrl').value = WEB_APP_URL; }
  function closeConfig(){ document.getElementById('modal').classList.add('hidden'); }
  function saveConfig(){
    WEB_APP_URL = document.getElementById('webAppUrl').value.trim();
    localStorage.setItem('webAppUrl', WEB_APP_URL);
    closeConfig();
    boot();
    alert('✅ Configuración guardada');
  }

  // ===== TABS =====
  function showTab(name){
    document.getElementById('tab-servicios').classList.add('hidden');
    document.getElementById('tab-dashboard').classList.add('hidden');
    document.getElementById('tab-historial').classList.add('hidden');
    document.getElementById(`tab-${name}`).classList.remove('hidden');

    if (name === 'dashboard') loadStats();
    if (name === 'historial') loadHistorial();
  }

  // ===== JSONP (evita CORS) =====
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      window[cb] = (data) => { resolve(data); cleanup(); };
      const s = document.createElement('script');
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
      s.onerror = () => { reject(new Error('JSONP error')); cleanup(); };
      document.body.appendChild(s);
      function cleanup(){
        delete window[cb];
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
    });
  }

  async function loadServicios(){
    if (!WEB_APP_URL) return openConfig();
    const data = await jsonp(`${WEB_APP_URL}?action=servicios`);
    if (!data.ok) throw new Error(data.error || 'No se pudo cargar servicios');
    servicios = data.items || [];
    renderServicios();
  }

  async function loadStats(){
    if (!WEB_APP_URL) return openConfig();
    const data = await jsonp(`${WEB_APP_URL}?action=stats`);
    if (!data.ok) throw new Error(data.error || 'No se pudo cargar stats');

    document.getElementById('kpiTotal').textContent = data.total || 0;
    document.getElementById('kpiPagados').textContent = data.pagados || 0;
    document.getElementById('kpiPendientes').textContent = data.pendientes || 0;
    document.getElementById('kpiAvance').textContent = (data.avance || 0) + '%';

    const ctx = document.getElementById('chartEstado');
    const vals = [data.pagados||0, data.pendientes||0, data.faltaPagar||0];

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels: ['PAGADO','PENDIENTE','FALTA PAGAR'], datasets: [{ label:'Servicios', data: vals }] },
      options: { responsive:true }
    });
  }

  async function loadHistorial(){
    if (!WEB_APP_URL) return openConfig();
    const data = await jsonp(`${WEB_APP_URL}?action=historial`);
    if (!data.ok) throw new Error(data.error || 'No se pudo cargar historial');
    historial = data.items || [];
    renderHistorial();
  }

  // ===== RENDER =====
  function badge(estado){
    const e = (estado||'').toUpperCase();
    const base = 'px-2 py-1 rounded text-xs font-semibold';
    if (e === 'PAGADO') return `<span class="${base} bg-green-100 text-green-700">PAGADO</span>`;
    if (e === 'PENDIENTE') return `<span class="${base} bg-yellow-100 text-yellow-700">PENDIENTE</span>`;
    return `<span class="${base} bg-red-100 text-red-700">FALTA PAGAR</span>`;
  }

  function renderServicios(){
    const q = (document.getElementById('search').value||'').toLowerCase();
    const fe = (document.getElementById('filterEstado').value||'').toUpperCase();

    const rows = servicios
      .filter(s => {
        const txt = `${s.codigo} ${s.proveedor} ${s.servicio}`.toLowerCase();
        const okQ = !q || txt.includes(q);
        const okE = !fe || (String(s.estado||'').toUpperCase() === fe);
        return okQ && okE;
      })
      .map(s => `
        <tr class="border-b">
          <td class="p-2 font-mono text-indigo-600">${s.codigo||''}</td>
          <td class="p-2">${s.proveedor||''}</td>
          <td class="p-2">${s.servicio||''}</td>
          <td class="p-2 font-semibold">S/ ${(Number(s.monto||0)).toFixed(2)}</td>
          <td class="p-2">${badge(s.estado)}</td>
          <td class="p-2">
            ${s.voucherUrl ? `<a class="text-indigo-600 underline" href="${s.voucherUrl}" target="_blank">Voucher</a>` : ''}
            ${s.docsUrl ? ` · <span class="text-slate-500">Docs</span>` : ''}
          </td>
          <td class="p-2">
            <button class="text-indigo-600 underline" onclick="editServicio('${(s.codigo||'').replace(/'/g,"\\'")}')">Editar</button>
          </td>
        </tr>
      `).join('');

    document.getElementById('tbodyServicios').innerHTML = rows || `<tr><td class="p-3 text-slate-500" colspan="7">Sin datos</td></tr>`;
  }

  function renderHistorial(){
    const rows = historial.slice().reverse().map(h => `
      <tr class="border-b">
        <td class="p-2">${h.fechaHora ? new Date(h.fechaHora).toLocaleString() : ''}</td>
        <td class="p-2 font-mono text-indigo-600">${h.codigo||''}</td>
        <td class="p-2">${h.proveedor||''}</td>
        <td class="p-2">${h.servicio||''}</td>
        <td class="p-2 font-semibold">S/ ${(Number(h.monto||0)).toFixed(2)}</td>
        <td class="p-2">${badge(h.estado)}</td>
        <td class="p-2">${h.voucherUrl ? `<a class="text-indigo-600 underline" href="${h.voucherUrl}" target="_blank">Ver</a>` : ''}</td>
        <td class="p-2">${h.docsUrl ? `<span class="text-slate-500">Ver en hoja</span>` : ''}</td>
      </tr>
    `).join('');
    document.getElementById('tbodyHistorial').innerHTML = rows || `<tr><td class="p-3 text-slate-500" colspan="8">Sin historial</td></tr>`;
  }

  // ===== FORM =====
  function resetForm(){
    document.getElementById('formServicio').reset();
  }

  function editServicio(codigo){
    const s = servicios.find(x => String(x.codigo||'') === String(codigo||''));
    if (!s) return;

    document.getElementById('codigo').value = s.codigo || '';
    document.getElementById('proveedor').value = s.proveedor || '';
    document.getElementById('servicio').value = s.servicio || '';
    document.getElementById('categoria').value = s.categoria || '';
    document.getElementById('monto').value = s.monto || 0;
    document.getElementById('fechaServicio').value = s.fechaServicio || '';
    document.getElementById('fechaVencimiento').value = s.fechaVencimiento || '';
    document.getElementById('fechaPago').value = s.fechaPago || '';
    document.getElementById('estado').value = s.estado || 'PENDIENTE';
    document.getElementById('medioPago').value = s.medioPago || '';
    document.getElementById('cuenta').value = s.cuenta || '';
    document.getElementById('observaciones').value = s.observaciones || '';
    document.getElementById('montoVariable').checked = !!s.montoVariable;

    window.scrollTo({ top:0, behavior:'smooth' });
  }

  function fileToDataUrl(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function saveServicio(ev){
    ev.preventDefault();
    if (!WEB_APP_URL) return openConfig();

    const voucherInput = document.getElementById('voucher');
    const docsInput = document.getElementById('docs');

    const voucherFile = voucherInput.files && voucherInput.files[0] ? voucherInput.files[0] : null;
    const docsFiles = docsInput.files ? Array.from(docsInput.files) : [];

    // convierte a base64 (dataURL)
    const voucherPayload = voucherFile ? {
      name: voucherFile.name,
      type: voucherFile.type,
      dataUrl: await fileToDataUrl(voucherFile)
    } : null;

    const docsPayload = [];
    for (const f of docsFiles) {
      docsPayload.push({
        name: f.name,
        type: f.type,
        dataUrl: await fileToDataUrl(f)
      });
    }

    const payload = {
      codigo: document.getElementById('codigo').value.trim(),
      proveedor: document.getElementById('proveedor').value.trim(),
      servicio: document.getElementById('servicio').value.trim(),
      categoria: document.getElementById('categoria').value,
      monto: Number(document.getElementById('monto').value || 0),
      fechaServicio: document.getElementById('fechaServicio').value,
      fechaVencimiento: document.getElementById('fechaVencimiento').value,
      fechaPago: document.getElementById('fechaPago').value,
      estado: document.getElementById('estado').value,
      medioPago: document.getElementById('medioPago').value,
      cuenta: document.getElementById('cuenta').value,
      observaciones: document.getElementById('observaciones').value,
      montoVariable: document.getElementById('montoVariable').checked,
      voucherFile: voucherPayload,
      docsFiles: docsPayload
    };

    try{
      // POST sin CORS (igual escribe en Sheet / Drive)
      await fetch(WEB_APP_URL, {
        method:'POST',
        mode:'no-cors',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      alert('✅ Guardado. Actualizando…');
      resetForm();
      setTimeout(async () => {
        await loadServicios();
        if (!document.getElementById('tab-dashboard').classList.contains('hidden')) await loadStats();
        if (!document.getElementById('tab-historial').classList.contains('hidden')) await loadHistorial();
      }, 1500);

    }catch(err){
      console.error(err);
      alert('❌ Error al guardar. Revisa URL / permisos del Web App.');
    }
  }

  async function boot(){
    if (!WEB_APP_URL) return openConfig();
    await loadServicios();
  }

  window.onload = boot;
</script>
</body>
</html>
