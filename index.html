<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BRAVIZIMO'S | Dashboard Financiero</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    :root{
      --bg:#0b1220;
      --bg2:#0f1a33;
      --card:#0f172a;
      --panel:#111c37;
      --text:#e7eefc;
      --muted:#a9b6d6;
      --line:rgba(255,255,255,.08);
      --accent:#ffffff;
      --chip:#0b1220;
      --ok:#2ecc71;
      --bad:#ff5c7a;
      --warn:#ffcc00;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      background: radial-gradient(1200px 600px at 30% 0%, #1b2a5a 0%, var(--bg) 40%, #070b15 100%);
      color:var(--text);
    }
    header{
      padding:26px 20px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 100%);
      border-bottom:1px solid var(--line);
    }
    .top{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
    .brand p{margin:2px 0 0; color:var(--muted); font-size:12px}
    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    select, input, button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    input[type="month"]{padding:9px 12px}
    input[type="date"]{padding:9px 12px}
    button{
      background:rgba(255,255,255,.9);
      color:#0b1220;
      font-weight:700;
      cursor:pointer;
    }
    button:hover{filter:brightness(.95)}

    .wrap{max-width:1200px;margin:0 auto;padding:18px 20px 28px}
    .error{
      display:none;
      margin:14px 0;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(255, 92, 122, .12);
      border:1px solid rgba(255, 92, 122, .35);
      color:#ffd6de;
      font-weight:600;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin:12px 0 14px;
    }
    .tab{
      padding:9px 12px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:700;
      font-size:13px;
      cursor:pointer;
    }
    .tab.active{
      background:rgba(255,255,255,.92);
      color:#0b1220;
      border-color:rgba(255,255,255,.6);
    }

    .grid-kpi{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media(max-width:1000px){ .grid-kpi{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media(max-width:520px){ .grid-kpi{grid-template-columns:1fr;} }

    .card{
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .kpi-title{color:var(--muted); font-size:12px; margin:0 0 6px}
    .kpi-value{font-size:20px; margin:0; font-weight:900; letter-spacing:.2px}
    .kpi-sub{margin:4px 0 0; color:var(--muted); font-size:12px}

    .grid-2{
      display:grid; grid-template-columns: 1fr 1fr; gap:12px;
      margin-top:12px;
    }
    @media(max-width:900px){ .grid-2{grid-template-columns:1fr;} }

    .card h3{margin:0 0 6px;font-size:14px}
    .muted{color:var(--muted); font-size:12px}
    .chartBox{
      height:280px; /* <- fijo para que NO se haga gigante */
      margin-top:10px;
    }
    canvas{width:100% !important; height:100% !important;}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      font-size:13px;
      text-align:left;
    }
    th{color:var(--muted); font-weight:800; font-size:12px; background:rgba(255,255,255,.04)}
    tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .pill{
      display:inline-block; padding:4px 9px; border-radius:999px; font-weight:800; font-size:11px;
      background:rgba(255,255,255,.08); border:1px solid var(--line);
    }
    .pill.ok{background:rgba(46,204,113,.12); border-color:rgba(46,204,113,.35); color:#cfffdf}
    .pill.bad{background:rgba(255,92,122,.12); border-color:rgba(255,92,122,.35); color:#ffd6de}
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">
      <h1>BRAVIZIMO'S | Dashboard Financiero</h1>
      <p>Sincronizado con Google Sheets (Apps Script)</p>
    </div>

    <div class="controls">
      <select id="mode">
        <option value="month">Mes</option>
        <option value="range">Rango</option>
      </select>

      <input id="month" type="month"/>
      <input id="from" type="date" style="display:none"/>
      <input id="to" type="date" style="display:none"/>

      <button id="btn">Actualizar</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div id="err" class="error"></div>

  <div class="tabs" id="tabs"></div>

  <div id="finanzas">
    <div class="grid-kpi" id="kpis"></div>

    <div class="grid-2">
      <div class="card">
        <h3>Ventas vs Gastos (por día) + Saldo</h3>
        <div class="muted">Basado en fecha de emisión (ventas) y fecha de gasto (GASTOS).</div>
        <div class="chartBox"><canvas id="chVG"></canvas></div>
      </div>
      <div class="card">
        <h3>Acumulado de ventas</h3>
        <div class="muted">Suma progresiva por día.</div>
        <div class="chartBox"><canvas id="chAcc"></canvas></div>
      </div>
    </div>
  </div>

  <div id="alertas" style="display:none"></div>
  <div id="distritos" style="display:none"></div>
  <div id="vendedoras" style="display:none"></div>
  <div id="delivery" style="display:none"></div>
  <div id="productos" style="display:none"></div>
  <div id="clientes" style="display:none"></div>
  <div id="gastos" style="display:none"></div>
  <div id="mediosPago" style="display:none"></div>
  <div id="servicios" style="display:none"></div>
</div>

<script>
  // === TU API
  const API_URL = "https://script.google.com/macros/s/AKfycbzxZ-2pTE5ltSDXXVn9Wjd9USG1FomaTScLuM-wDQMuKiu92mzwGQhnkL0mZYZF9AtI/exec";

  const state = { data:null, charts:{} };

  const tabList = [
    { id:"finanzas", label:"Finanzas" },
    { id:"alertas", label:"Alertas" },
    { id:"distritos", label:"Distritos" },
    { id:"vendedoras", label:"Vendedoras" },
    { id:"delivery", label:"Delivery" },
    { id:"productos", label:"Productos" },
    { id:"clientes", label:"Clientes" },
    { id:"gastos", label:"Gastos" },
    { id:"mediosPago", label:"Medios de pago" },
    { id:"servicios", label:"Servicios" }
  ];

  const $ = (id)=>document.getElementById(id);

  function money(n){
    n = Number(n||0);
    return "S/ " + n.toLocaleString("es-PE",{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function showError(msg){
    const el = $("err");
    if(!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block";
    el.textContent = msg;
  }

  function setTabs(activeId){
    const t = $("tabs");
    t.innerHTML = "";
    tabList.forEach(x=>{
      const b=document.createElement("button");
      b.className="tab"+(x.id===activeId?" active":"");
      b.textContent=x.label;
      b.onclick=()=>activateTab(x.id);
      t.appendChild(b);
    });
  }

  function activateTab(id){
    tabList.forEach(x=>{
      const el=$(x.id);
      el.style.display = (x.id===id) ? "" : "none";
    });
    setTabs(id);
  }

  function bindMode(){
    const mode = $("mode").value;
    const month = $("month");
    const from = $("from");
    const to = $("to");

    if(mode==="month"){
      month.style.display="";
      from.style.display="none";
      to.style.display="none";
    }else{
      month.style.display="none";
      from.style.display="";
      to.style.display="";
    }
  }

  $("mode").addEventListener("change", bindMode);

  function buildUrl(){
    const mode = $("mode").value;
    const qs = new URLSearchParams({ action:"data", mode });
    if(mode==="month"){
      const m = $("month").value; // yyyy-mm
      qs.set("month", m);
    }else{
      qs.set("from", $("from").value);
      qs.set("to", $("to").value);
    }
    return API_URL + "?" + qs.toString();
  }

  async function load(){
    showError("");
    const url = buildUrl();

    let json;
    try{
      const res = await fetch(url, { cache:"no-store" });
      const text = await res.text();

      // si devuelve HTML (por mala URL o despliegue), te avisamos claro
      if(text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html")){
        throw new Error("El endpoint está devolviendo HTML (no JSON). Revisa que el Apps Script esté desplegado como Web App y uses /exec.");
      }
      json = JSON.parse(text);
    }catch(err){
      showError("No se pudo cargar data desde Apps Script: " + (err.message || err));
      return;
    }

    if(!json.ok){
      showError("Error Apps Script: " + (json.error || "desconocido"));
      return;
    }

    state.data = json;
    renderAll();
  }

  function renderAll(){
    const d = state.data;

    // KPIs
    const kpis = [
      ["Ventas totales", money(d.kpis.ventasTotales)],
      ["Gastos totales", money(d.kpis.gastosTotales)],
      ["Utilidad", money(d.kpis.utilidad)],
      ["Saldo pendiente", money(d.kpis.saldoPendiente)],

      ["Delivery cobrado", money(d.kpis.deliveryCobrado)],
      ["Costo delivery", money(d.kpis.costoDelivery)],
      ["Margen delivery", money(d.kpis.margenDelivery)],
      ["Clientes (total)", String(d.kpis.clientesTotal || 0)],

      ["Promedio diario (hasta hoy)", money(d.kpis.promedioDiario)],
      ["Proyección mensual (prom * 30)", money(d.kpis.proyeccionMensual)],
      ["Boletas / Facturas", `${d.kpis.boletas || 0} / ${d.kpis.facturas || 0}`],
      ["Comprobantes faltantes", String(d.kpis.comprobantesFaltantes || 0)]
    ];

    $("kpis").innerHTML = kpis.map(([t,v])=>`
      <div class="card">
        <p class="kpi-title">${t}</p>
        <p class="kpi-value">${v}</p>
      </div>
    `).join("");

    // Charts (limpiamos si existían)
    Object.values(state.charts).forEach(ch=>{ try{ ch.destroy(); }catch(e){} });
    state.charts = {};

    // Ventas vs gastos + saldo
    state.charts.vg = new Chart($("chVG"),{
      type:"line",
      data:{
        labels: d.charts.days,
        datasets:[
          { label:"Ventas", data:d.charts.ventasByDay, tension:.25 },
          { label:"Gastos", data:d.charts.gastosByDay, tension:.25 },
          { label:"Saldo pendiente", data:d.charts.saldoByDay, tension:.25 }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color:"#e7eefc" } } },
        scales:{
          x:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } },
          y:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } }
        }
      }
    });

    // acumulado ventas
    state.charts.acc = new Chart($("chAcc"),{
      type:"line",
      data:{
        labels: d.charts.days,
        datasets:[
          { label:"Acumulado", data:d.charts.acumuladoVentas, tension:.25 }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color:"#e7eefc" } } },
        scales:{
          x:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } },
          y:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } }
        }
      }
    });

    renderAlertas(d);
    renderDistritos(d);
    renderVendedoras(d);
    renderDelivery(d);
    renderProductos(d);
    renderClientes(d);
    renderGastos(d);
    renderMediosPago(d);
    renderServicios(d);
  }

  function renderAlertas(d){
    const a = d.tabs.alertas;
    $("alertas").innerHTML = `
      <div class="card">
        <h3>Pendientes de comprobante (hasta 200)</h3>
        <div class="muted">Si un comprobante está vacío o 0, aparece aquí.</div>
        ${table(a.pendientesComprobante, [
          ["fecha","Fecha"],
          ["pedido","Pedido"],
          ["nota","Nota"],
          ["cliente","Cliente"],
          ["total","Total", "money"]
        ])}
      </div>
      <div style="height:12px"></div>
      <div class="card">
        <h3>Saldos pendientes (hasta 200)</h3>
        ${table(a.saldosPendientes, [
          ["fecha","Fecha"],
          ["cliente","Cliente"],
          ["total","Total","money"],
          ["porPagar","Por pagar","money"]
        ])}
      </div>
    `;
  }

  function renderDistritos(d){
    const r = d.tabs.distritos.ranking;
    $("distritos").innerHTML = `
      <div class="card">
        <h3>Ranking de distritos</h3>
        <div class="muted">Monto (desc) y cantidad de pedidos.</div>
        ${table(r, [
          ["key","Distrito"],
          ["pedidos","Pedidos"],
          ["monto","Monto","money"]
        ])}
      </div>
    `;
  }

  function renderVendedoras(d){
    const rows = d.tabs.vendedoras.rows;
    const tot = d.tabs.vendedoras.totals;
    $("vendedoras").innerHTML = `
      <div class="card">
        <h3>Vendedoras por día (ventas y saldo)</h3>
        <div class="muted">Total del periodo: ${money(tot.monto)} | Pedidos: ${tot.pedidos} | Saldo: ${money(tot.saldo)}</div>
        ${table(rows, [
          ["fecha","Fecha"],
          ["nombre","Vendedora"],
          ["pedidos","Pedidos"],
          ["monto","Monto","money"],
          ["saldo","Saldo","money"]
        ])}
      </div>
    `;
  }

  function renderDelivery(d){
    $("delivery").innerHTML = `
      <div class="grid-2">
        <div class="card">
          <h3>Delivery por día</h3>
          <div class="muted">Cobrado, costo y cantidad de entregas.</div>
          <div class="chartBox"><canvas id="chDel"></canvas></div>
        </div>
        <div class="card">
          <h3>Recojo en tienda (por día)</h3>
          <div class="muted">Cantidad de pedidos con recojo.</div>
          <div class="chartBox"><canvas id="chRec"></canvas></div>
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="card">
        <h3>Delivery por motorizado (ranking)</h3>
        ${table(d.tabs.delivery.ranking,[
          ["key","Motorizado"],
          ["entregas","Entregas"],
          ["cobrado","Cobrado","money"],
          ["costo","Costo","money"]
        ])}
      </div>
    `;

    const ds = state.data.charts;
    state.charts.del = new Chart(document.getElementById("chDel"),{
      type:"bar",
      data:{
        labels: ds.days,
        datasets:[
          { label:"Cobrado", data: ds.deliveryCobradoByDay },
          { label:"Costo", data: ds.deliveryCostoByDay }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color:"#e7eefc" } } },
        scales:{
          x:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } },
          y:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } }
        }
      }
    });

    state.charts.rec = new Chart(document.getElementById("chRec"),{
      type:"bar",
      data:{ labels: ds.days, datasets:[{ label:"Recojo (cant)", data: ds.recojoCantByDay }] },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color:"#e7eefc" } } },
        scales:{
          x:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } },
          y:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } }
        }
      }
    });
  }

  function renderProductos(d){
    $("productos").innerHTML = `
      <div class="card">
        <h3>Top 20 productos</h3>
        <div class="muted">Ordenado por monto (desc). Incluye cantidad.</div>
        ${table(d.tabs.productos.top20,[
          ["key","Producto"],
          ["cant","Cantidad"],
          ["monto","Monto","money"]
        ])}
      </div>
    `;
  }

  function renderClientes(d){
    $("clientes").innerHTML = `
      <div class="card">
        <h3>Clientes del período (hasta 200)</h3>
        <div class="muted">Total clientes en el período: <b>${d.tabs.clientes.totalPeriodo}</b>. Ordenado por última compra.</div>
        ${table(d.tabs.clientes.list,[
          ["cliente","Cliente"],
          ["celular","Celular"],
          ["ultima","Última compra"],
          ["pedidos","Pedidos"],
          ["monto","Monto","money"]
        ])}
      </div>
    `;
  }

  function renderGastos(d){
    $("gastos").innerHTML = `
      <div class="grid-2">
        <div class="card">
          <h3>Gastos por categoría</h3>
          ${table(d.tabs.gastos.porCategoria,[
            ["key","Categoría"],
            ["cant","Cant"],
            ["monto","Monto","money"]
          ])}
        </div>
        <div class="card">
          <h3>Gastos (total)</h3>
          <p class="kpi-value">${money(d.tabs.gastos.total)}</p>
          <p class="muted">En el período seleccionado.</p>
        </div>
      </div>
    `;
  }

  function renderMediosPago(d){
    $("mediosPago").innerHTML = `
      <div class="card">
        <h3>Medios de pago (1er pago + 2do pago)</h3>
        <div class="muted">Suma por cuenta destino.</div>
        ${table(d.tabs.mediosPago.cuentas,[
          ["cuenta","Cuenta"],
          ["monto","Monto","money"]
        ])}
      </div>
    `;
  }

  function renderServicios(d){
    $("servicios").innerHTML = `
      <div class="grid-2">
        <div class="card">
          <h3>Servicios: Pagado vs Pendiente (por día)</h3>
          <div class="muted">Se toma TIPO / FECHA / MONTO / ESTADO.</div>
          <div class="chartBox"><canvas id="chServ"></canvas></div>
        </div>
        <div class="card">
          <h3>Servicios (lista)</h3>
          <div class="muted">Hasta 200 filas del período.</div>
          ${table(d.tabs.servicios.list,[
            ["tipo","TIPO"],
            ["fecha","FECHA"],
            ["monto","MONTO","money"],
            ["estado","ESTADO"]
          ])}
        </div>
      </div>
      <div style="height:12px"></div>
      <div class="card">
        <h3>Servicios (KPI)</h3>
        <div class="muted">
          Total: <b>${money(d.tabs.servicios.kpi.total)}</b> |
          Pagados: <b>${money(d.tabs.servicios.kpi.pagados)}</b> |
          Pendientes: <b>${money(d.tabs.servicios.kpi.pendientes)}</b>
        </div>
      </div>
    `;

    const ds = state.data.charts;
    state.charts.serv = new Chart(document.getElementById("chServ"),{
      type:"bar",
      data:{
        labels: ds.days,
        datasets:[
          { label:"Pagado", data: ds.servPagadoByDay },
          { label:"Pendiente", data: ds.servPendienteByDay }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color:"#e7eefc" } } },
        scales:{
          x:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } },
          y:{ ticks:{ color:"#a9b6d6" }, grid:{ color:"rgba(255,255,255,.06)" } }
        }
      }
    });
  }

  function table(rows, cols){
    rows = rows || [];
    const head = cols.map(c=>`<th>${c[1]}</th>`).join("");
    const body = rows.map(r=>{
      const tds = cols.map(c=>{
        const key=c[0], type=c[2]||"";
        let v = (r && r[key]!==undefined) ? r[key] : "";
        if(type==="money") v = money(v);
        return `<td class="${type==="money"?"right":""}">${v}</td>`;
      }).join("");
      return `<tr>${tds}</tr>`;
    }).join("");

    return `
      <table>
        <thead><tr>${head}</tr></thead>
        <tbody>${body || `<tr><td colspan="${cols.length}" class="muted">Sin datos en el período.</td></tr>`}</tbody>
      </table>
    `;
  }

  // Init defaults
  (function init(){
    // pestañas
    setTabs("finanzas");
    activateTab("finanzas");

    // defaults fecha
    const now = new Date();
    const m = String(now.getMonth()+1).padStart(2,"0");
    $("month").value = `${now.getFullYear()}-${m}`;
    $("from").value = `${now.getFullYear()}-${m}-01`;
    $("to").value = `${now.getFullYear()}-${m}-${String(now.getDate()).padStart(2,"0")}`;

    bindMode();
    $("btn").onclick = load;

    load();
  })();
</script>
</body>
</html>
