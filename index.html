<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BRAVIZIMO'S | Dashboard Financiero</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#071018;
      --card:rgba(255,255,255,0.06);
      --card2:rgba(255,255,255,0.04);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,0.7);
      --line:rgba(255,255,255,0.08);
      --pill:rgba(255,255,255,0.08);
    }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      background: radial-gradient(1200px 600px at 30% 0%, rgba(90,150,255,0.16), transparent 60%),
                  radial-gradient(1200px 600px at 70% 20%, rgba(255,120,200,0.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:24px 18px 60px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1{ font-size:18px; margin:0; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    select, button{
      background:rgba(255,255,255,0.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:9px 12px; border-radius:12px; outline:none;
    }
    button{ cursor:pointer; font-weight:600; }
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap; margin:18px 0 14px;
    }
    .tab{
      padding:8px 12px; border-radius:999px; border:1px solid var(--line);
      background:var(--pill); cursor:pointer; font-weight:600; font-size:12px;
    }
    .tab.active{ background:rgba(255,255,255,0.16); }
    .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 14px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
    }
    .kpi-title{ font-size:12px; color:var(--muted); }
    .kpi-value{ font-size:20px; font-weight:800; margin-top:6px; }
    .section{ margin-top:14px; display:none; }
    .section.active{ display:block; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .row1{ display:grid; grid-template-columns:1fr; gap:12px; }
    .chartBox{ height:260px; } /* evita que se vea ‚Äúextenso‚Äù */
    canvas{ width:100% !important; height:100% !important; }
    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th,td{ padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; }
    th{ color:rgba(160,195,255,0.9); font-weight:800; }
    td.right, th.right{ text-align:right; }
    .scroll{ max-height:460px; overflow:auto; border-radius:14px; }
    .footerTotal{ display:flex; justify-content:space-between; padding:10px 8px; font-weight:900; }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px; }
    .error{ background:rgba(255,70,70,0.12); border:1px solid rgba(255,70,70,0.35); padding:10px 12px; border-radius:12px; margin-top:12px; }
    @media (max-width: 980px){
      .grid{ grid-template-columns:repeat(2,1fr); }
      .row2{ grid-template-columns:1fr; }
      .chartBox{ height:240px; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>BRAVIZIMO'S | Dashboard Financiero</h1>
      <div class="sub">Sincronizado con Google Sheets (Apps Script)</div>
    </div>
    <div class="controls">
      <label style="font-size:12px;color:var(--muted)">Modo</label>
      <select id="mode">
        <option value="month" selected>Mes</option>
      </select>

      <label style="font-size:12px;color:var(--muted)">Mes</label>
      <select id="month"></select>

      <button id="btn">Actualizar</button>
    </div>
  </header>

  <div id="err" class="error" style="display:none;"></div>

  <div class="tabs" id="tabs"></div>

  <!-- FINANZAS -->
  <section class="section active" id="sec-finanzas">
    <div class="grid" id="kpis"></div>

    <div class="row2" style="margin-top:12px">
      <div class="card">
        <div style="font-weight:900">Ventas vs Gastos (por d√≠a) + Saldo</div>
        <div class="hint">Ventas (nota de ventas) vs Gastos (GASTOS) por fecha.</div>
        <div class="chartBox"><canvas id="chVentasGastos"></canvas></div>
      </div>
      <div class="card">
        <div style="font-weight:900">Acumulado de ventas</div>
        <div class="hint">Suma progresiva por d√≠a.</div>
        <div class="chartBox"><canvas id="chAcum"></canvas></div>
      </div>
    </div>
  </section>

  <!-- ALERTAS -->
  <section class="section" id="sec-alertas">
    <div class="card">
      <div style="font-weight:900">Pendientes de comprobante (hasta 200)</div>
      <div class="hint">Incluye numeraci√≥n + comprobante.</div>
      <div class="scroll">
        <table>
          <thead>
          <tr>
            <th>#</th><th>Fecha</th><th>Pedido</th><th>Nota</th><th>Cliente</th><th>Comprobante</th><th class="right">Total</th>
          </tr>
          </thead>
          <tbody id="tbAlertas"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:900">Saldos pendientes (hasta 200)</div>
      <div class="hint">Incluye TOTAL FINAL (resultado monto final).</div>
      <div class="scroll">
        <table>
          <thead><tr><th>Fecha</th><th>Cliente</th><th class="right">Total</th><th class="right">Por pagar</th></tr></thead>
          <tbody id="tbSaldos"></tbody>
        </table>
      </div>
      <div class="footerTotal">
        <div>TOTAL FINAL</div>
        <div id="saldosTotal">S/ 0.00</div>
      </div>
    </div>
  </section>

  <!-- DISTRITOS -->
  <section class="section" id="sec-distritos">
    <div class="card">
      <div style="font-weight:900">Ranking de distritos</div>
      <div class="hint">Pedidos (entregas) y monto (suma Delivery CLIENTE).</div>
      <div class="scroll">
        <table>
          <thead><tr><th>Distrito</th><th class="right">Pedidos</th><th class="right">Monto</th></tr></thead>
          <tbody id="tbDistritos"></tbody>
        </table>
      </div>
      <div class="footerTotal">
        <div>TOTAL FINAL</div>
        <div id="distritosTotal">S/ 0.00</div>
      </div>
    </div>
  </section>

  <!-- VENDEDORAS -->
  <section class="section" id="sec-vendedoras">
    <div class="row2">
      <div class="card">
        <div style="font-weight:900">Resumen por vendedora (Top)</div>
        <div class="hint">Monto total + pedidos (gr√°fico).</div>
        <div class="chartBox"><canvas id="chVendedoras"></canvas></div>
      </div>

      <div class="card">
        <div style="font-weight:900">Vendedoras por d√≠a (ventas y saldo)</div>
        <div class="hint">Detalle por fecha y vendedora.</div>
        <div class="scroll">
          <table>
            <thead><tr><th>Fecha</th><th>Vendedora</th><th class="right">Pedidos</th><th class="right">Monto</th><th class="right">Saldo</th></tr></thead>
            <tbody id="tbVendedorasDia"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- DELIVERY -->
  <section class="section" id="sec-delivery">
    <div class="row2">
      <div class="card">
        <div style="font-weight:900">Delivery por d√≠a</div>
        <div class="hint">Cobrado vs costo (y diferencia/ahorro).</div>
        <div class="chartBox"><canvas id="chDeliveryDia"></canvas></div>
      </div>
      <div class="card">
        <div style="font-weight:900">Recojo en tienda (por d√≠a)</div>
        <div class="hint">Detecta por Direcci√≥n con ‚ÄúRECOJO/TIENDA‚Äù o campo Recojo = ‚ÄúSI‚Äù.</div>
        <div class="chartBox"><canvas id="chRecojo"></canvas></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:900">Delivery por motorizado (por d√≠a)</div>
      <div class="hint">Incluye fechas, cobrado y costo.</div>
      <div class="scroll">
        <table>
          <thead><tr><th>Fecha</th><th>Motorizado</th><th class="right">Cobrado</th><th class="right">Costo</th></tr></thead>
          <tbody id="tbMotorizado"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PRODUCTOS -->
  <section class="section" id="sec-productos">
    <div class="card">
      <div style="font-weight:900">Top productos (por monto)</div>
      <div class="hint">Incluye cantidad y monto.</div>
      <div class="scroll">
        <table>
          <thead><tr><th>Producto</th><th class="right">Cantidad</th><th class="right">Monto</th></tr></thead>
          <tbody id="tbProductos"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div style="font-weight:900">Productos por d√≠a (para saber qu√© preparar)</div>
      <div class="hint">Filtrado por el mes seleccionado (si quieres lo mejoramos a selector de d√≠a).</div>
      <div class="scroll">
        <table>
          <thead><tr><th>Fecha</th><th>Producto</th><th class="right">Cantidad</th></tr></thead>
          <tbody id="tbProductosDia"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CLIENTES -->
  <section class="section" id="sec-clientes">
    <div class="card">
      <div style="font-weight:900">Clientes del per√≠odo (hasta 200)</div>
      <div class="hint">Ordenado por monto acumulado (desc). Incluye numeraci√≥n y cantidad de pedidos.</div>
      <div class="scroll">
        <table>
          <thead><tr><th>#</th><th>Cliente</th><th>Celular</th><th>√öltima compra</th><th class="right">Pedidos</th><th class="right">Monto</th></tr></thead>
          <tbody id="tbClientes"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- GASTOS -->
  <section class="section" id="sec-gastos">
    <div class="card">
      <div style="font-weight:900">Gastos por categor√≠a</div>
      <div class="hint">Se lee de hoja GASTOS (columna T.SOLES / Monto / Total).</div>
      <div class="scroll">
        <table>
          <thead><tr><th>Categor√≠a</th><th class="right">Registros</th><th class="right">Monto</th></tr></thead>
          <tbody id="tbGastosCat"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- MEDIOS DE PAGO -->
  <section class="section" id="sec-medios">
    <div class="card">
      <div style="font-weight:900">Medios de pago</div>
      <div class="hint">Ranking por monto (ventas + si existe medio en env√≠os).</div>
      <div class="scroll">
        <table>
          <thead><tr><th>Medio</th><th class="right">Registros</th><th class="right">Monto</th></tr></thead>
          <tbody id="tbMedios"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SERVICIOS -->
  <section class="section" id="sec-servicios">
    <div class="row2">
      <div class="card">
        <div style="font-weight:900">Servicios: Pagado vs Pendiente (por d√≠a)</div>
        <div class="hint">Lee de hoja servicios: TIPO / FECHA / MONTO / ESTADO / MEDIO DE PAGO.</div>
        <div class="chartBox"><canvas id="chServicios"></canvas></div>
      </div>

      <div class="card">
        <div style="font-weight:900">Servicios (lista)</div>
        <div class="hint">Tipo ¬∑ Fecha ¬∑ Monto ¬∑ Estado ¬∑ Medio</div>
        <div class="scroll">
          <table>
            <thead><tr><th>Tipo</th><th>Fecha</th><th class="right">Monto</th><th>Estado</th><th>Medio</th><th>Obs</th></tr></thead>
            <tbody id="tbServicios"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

</div>

<script>
  // üîÅ CAMBIA ESTO por tu webapp actual
  const API_URL = "https://script.google.com/macros/s/AKfycbyuaypIs7bVHtjYHVJIUrZng3CRT9V5b_g9G3ML12e0RlXY2XlD_r7XVYSLnEX5nD3-/exec";

  const tabs = [
    ["finanzas","Finanzas"],
    ["alertas","Alertas"],
    ["distritos","Distritos"],
    ["vendedoras","Vendedoras"],
    ["delivery","Delivery"],
    ["productos","Productos"],
    ["clientes","Clientes"],
    ["gastos","Gastos"],
    ["medios","Medios de pago"],
    ["servicios","Servicios"],
  ];

  const elTabs = document.getElementById("tabs");
  const elMonth = document.getElementById("month");
  const elBtn = document.getElementById("btn");
  const elErr = document.getElementById("err");

  const charts = {};

  function money(n){
    const v = Number(n||0);
    return "S/ " + v.toLocaleString("es-PE",{minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function setError(msg){
    if(!msg){ elErr.style.display="none"; elErr.textContent=""; return; }
    elErr.style.display="block";
    elErr.textContent = msg;
  }

  function initMonths(){
    // √∫ltimos 18 meses + este
    const now = new Date();
    const items = [];
    for(let i=0;i<18;i++){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const val = `${y}-${m}`;
      const label = d.toLocaleDateString("es-PE",{month:"long", year:"numeric"});
      items.push([val, label.charAt(0).toUpperCase()+label.slice(1)]);
    }
    elMonth.innerHTML = items.map(([v,l])=>`<option value="${v}">${l}</option>`).join("");
  }

  function initTabs(){
    elTabs.innerHTML = tabs.map(([id,label],i)=>(
      `<div class="tab ${i===0?"active":""}" data-id="${id}">${label}</div>`
    )).join("");

    elTabs.addEventListener("click", (e)=>{
      const t = e.target.closest(".tab");
      if(!t) return;
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");

      const id = t.dataset.id;
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      document.getElementById("sec-"+id).classList.add("active");
    });
  }

  function destroyChart(id){
    if(charts[id]) { charts[id].destroy(); charts[id]=null; }
  }

  function renderKpis(k){
    const items = [
      ["Ventas totales", money(k.ventasTotal)],
      ["Gastos totales", money(k.gastosTotal)],
      ["Utilidad", money(k.utilidad)],
      ["Saldo pendiente", money(k.saldoPendiente)],
      ["Delivery cobrado (ENVIOS ‚Üí Delivery CLIENTE)", money(k.deliveryCobrado)],
      ["Costo delivery (ENVIOS ‚Üí Costo Delivery)", money(k.costoDelivery)],
      ["Margen delivery", money(k.margenDelivery)],
      ["Clientes (total)", String(k.clientesTotal || 0)],
      ["Promedio diario (hasta hoy)", money(k.promedioDiario)],
      ["Proyecci√≥n mensual (prom √ó 30)", money(k.proyeccionMensual)],
      ["Boletas / Facturas", `${k.boletas || 0} / ${k.facturas || 0}`],
      ["Comprobantes faltantes", String(k.comprobantesFaltantes || 0)],
    ];
    document.getElementById("kpis").innerHTML = items.map(([t,v])=>`
      <div class="card">
        <div class="kpi-title">${t}</div>
        <div class="kpi-value">${v}</div>
      </div>
    `).join("");
  }

  function fillTable(tbodyId, rows, cols, emptyText="Sin registros."){
    const tb = document.getElementById(tbodyId);
    if(!rows || !rows.length){
      tb.innerHTML = `<tr><td colspan="${cols}" style="color:rgba(234,242,255,0.65)">${emptyText}</td></tr>`;
      return;
    }
    tb.innerHTML = rows.map(r => r).join("");
  }

  function drawLine(id, labels, datasets){
    destroyChart(id);
    const ctx = document.getElementById(id);
    charts[id] = new Chart(ctx, {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color:"rgba(234,242,255,0.75)" } } },
        scales:{
          x:{ ticks:{ color:"rgba(234,242,255,0.55)" }, grid:{ color:"rgba(255,255,255,0.05)" } },
          y:{ ticks:{ color:"rgba(234,242,255,0.55)" }, grid:{ color:"rgba(255,255,255,0.05)" } }
        }
      }
    });
  }

  function drawBar(id, labels, datasets){
    destroyChart(id);
    const ctx = document.getElementById(id);
    charts[id] = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ labels:{ color:"rgba(234,242,255,0.75)" } } },
        scales:{
          x:{ ticks:{ color:"rgba(234,242,255,0.55)" }, grid:{ color:"rgba(255,255,255,0.05)" } },
          y:{ ticks:{ color:"rgba(234,242,255,0.55)" }, grid:{ color:"rgba(255,255,255,0.05)" } }
        }
      }
    });
  }

  async function load(){
    setError("");
    const month = elMonth.value;
    const mode = document.getElementById("mode").value;
    const url = `${API_URL}?mode=${encodeURIComponent(mode)}&month=${encodeURIComponent(month)}&limit=200`;

    const res = await fetch(url, { method:"GET" });
    const data = await res.json();
    if(!data.ok){
      setError("Error Apps Script: " + (data.error || "desconocido"));
      return;
    }

    renderKpis(data.kpis);

    // FINANZAS charts
    const vg = data.charts.ventasVsGastosPorDia;
    drawLine("chVentasGastos", vg.labels, [
      { label:"Ventas", data: vg.series.ventas },
      { label:"Gastos", data: vg.series.gastos },
      { label:"Saldo", data: vg.series.saldo },
    ]);

    const ac = data.charts.acumuladoVentas;
    drawLine("chAcum", ac.labels, [
      { label:"Acumulado", data: ac.values }
    ]);

    // ALERTAS
    const alertRows = (data.tables.alertasComprobante.rows || []).map(x => `
      <tr>
        <td>${x.n}</td>
        <td>${x.fecha||""}</td>
        <td>${x.pedido||""}</td>
        <td>${x.nota||""}</td>
        <td>${x.cliente||""}</td>
        <td>${x.comprobante||""}</td>
        <td class="right">${money(x.total||0)}</td>
      </tr>
    `);
    fillTable("tbAlertas", alertRows, 7);

    const sal = data.tables.saldosPendientes;
    const salRows = (sal.rows || []).map(x => `
      <tr>
        <td>${x.fecha||""}</td>
        <td>${x.cliente||""}</td>
        <td class="right">${money(x.total||0)}</td>
        <td class="right">${money(x.porPagar||0)}</td>
      </tr>
    `);
    fillTable("tbSaldos", salRows, 4);
    document.getElementById("saldosTotal").textContent = money(sal.totalFinal || 0);

    // DISTRITOS
    const dist = data.tables.distritos;
    const distRows = (dist.rows || []).map(x => `
      <tr>
        <td>${x.distrito}</td>
        <td class="right">${x.pedidos}</td>
        <td class="right">${money(x.monto)}</td>
      </tr>
    `);
    fillTable("tbDistritos", distRows, 3);
    document.getElementById("distritosTotal").textContent = money(dist.totalFinal || 0);

    // VENDEDORAS
    const vendChart = data.charts.vendedorasResumen;
    drawBar("chVendedoras", vendChart.labels, [
      { label:"Monto", data: vendChart.series.monto },
      { label:"Pedidos", data: vendChart.series.pedidos },
    ]);

    const vendDiaRows = (data.tables.vendedorasPorDia.rows || []).map(x => `
      <tr>
        <td>${x.fecha}</td>
        <td>${x.vendedora}</td>
        <td class="right">${x.pedidos}</td>
        <td class="right">${money(x.monto)}</td>
        <td class="right">${money(x.saldo)}</td>
      </tr>
    `);
    fillTable("tbVendedorasDia", vendDiaRows, 5);

    // DELIVERY
    const del = data.charts.deliveryPorDia;
    drawBar("chDeliveryDia", del.labels, [
      { label:"Cobrado", data: del.series.cobrado },
      { label:"Costo", data: del.series.costo },
      { label:"Ahorro", data: del.series.ahorro },
    ]);

    const rec = data.charts.recojoPorDia;
    drawLine("chRecojo", rec.labels, [
      { label:"Recojo (cant)", data: rec.values }
    ]);

    const motRows = (data.tables.motorizadoPorDia.rows || []).map(x => `
      <tr>
        <td>${x.fecha}</td>
        <td>${x.motorizado}</td>
        <td class="right">${money(x.cobrado)}</td>
        <td class="right">${money(x.costo)}</td>
      </tr>
    `);
    fillTable("tbMotorizado", motRows, 4);

    // PRODUCTOS
    const prodRows = (data.tables.productosTop.rows || []).map(x => `
      <tr>
        <td>${x.producto}</td>
        <td class="right">${Number(x.cantidad||0).toLocaleString("es-PE")}</td>
        <td class="right">${money(x.monto||0)}</td>
      </tr>
    `);
    fillTable("tbProductos", prodRows, 3);

    const prodDiaRows = (data.tables.productosPorDia.rows || []).map(x => `
      <tr>
        <td>${x.fecha}</td>
        <td>${x.producto}</td>
        <td class="right">${Number(x.cantidad||0).toLocaleString("es-PE")}</td>
      </tr>
    `);
    fillTable("tbProductosDia", prodDiaRows, 3);

    // CLIENTES
    const cliRows = (data.tables.clientesAgg.rows || []).map(x => `
      <tr>
        <td>${x.n}</td>
        <td>${x.cliente}</td>
        <td>${x.celular||""}</td>
        <td>${x.ultimaCompra||""}</td>
        <td class="right">${x.pedidos}</td>
        <td class="right">${money(x.monto)}</td>
      </tr>
    `);
    fillTable("tbClientes", cliRows, 6);

    // GASTOS
    const gcatRows = (data.tables.gastosCategoria.rows || []).map(x => `
      <tr>
        <td>${x.categoria}</td>
        <td class="right">${x.registros}</td>
        <td class="right">${money(x.monto)}</td>
      </tr>
    `);
    fillTable("tbGastosCat", gcatRows, 3);

    // MEDIOS
    const mpRows = (data.tables.mediosPago.rows || []).map(x => `
      <tr>
        <td>${x.medio}</td>
        <td class="right">${x.registros}</td>
        <td class="right">${money(x.monto)}</td>
      </tr>
    `);
    fillTable("tbMedios", mpRows, 3);

    // SERVICIOS
    const serv = data.charts.serviciosPorDia;
    drawBar("chServicios", serv.labels, [
      { label:"Pagado", data: serv.series.pagado },
      { label:"Pendiente", data: serv.series.pendiente },
    ]);

    const servRows = (data.tables.serviciosLista.rows || []).map(x => `
      <tr>
        <td>${x.tipo||""}</td>
        <td>${x.fecha||""}</td>
        <td class="right">${money(x.monto||0)}</td>
        <td>${x.estado||""}</td>
        <td>${x.medio||""}</td>
        <td>${x.obs||""}</td>
      </tr>
    `);
    fillTable("tbServicios", servRows, 6);

  }

  initMonths();
  initTabs();
  elBtn.addEventListener("click", ()=> load().catch(e=> setError(String(e))));
  load().catch(e=> setError(String(e)));
</script>
</body>
</html>
