<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>BRAVIZIMO'S ERP V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN para estilos r√°pidos -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-slate-950/95 border-r border-slate-800 flex flex-col">
      <div class="px-4 py-4 border-b border-slate-800 flex items-center gap-2">
        <div class="h-8 w-8 rounded-full bg-amber-400 flex items-center justify-center font-bold text-slate-900">
          B
        </div>
        <div>
          <div class="text-xs text-slate-400 leading-tight">BRAVIZIMO'S</div>
          <div class="text-sm font-semibold">ERP ¬∑ Bocaditos</div>
        </div>
      </div>

      <nav class="flex-1 overflow-y-auto text-sm">
        <p class="px-4 pt-4 pb-1 text-[11px] uppercase tracking-wide text-slate-500">General</p>
        <ul>
          <li><button data-view="dashboard" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800 flex items-center gap-2 text-emerald-300 font-semibold">Dashboard</button></li>
        </ul>

        <p class="px-4 pt-4 pb-1 text-[11px] uppercase tracking-wide text-slate-500">Ventas & Entregas</p>
        <ul>
          <li><button data-view="ventas" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Ventas</button></li>
          <li><button data-view="delivery" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Delivery</button></li>
        </ul>

        <p class="px-4 pt-4 pb-1 text-[11px] uppercase tracking-wide text-slate-500">Operaci√≥n</p>
        <ul>
          <li><button data-view="inventario" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Inventario</button></li>
          <li><button data-view="insumos" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Insumos</button></li>
          <li><button data-view="produccion" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Producci√≥n</button></li>
          <li><button data-view="compras" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Compras</button></li>
          <li><button data-view="proveedores" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Proveedores</button></li>
        </ul>

        <p class="px-4 pt-4 pb-1 text-[11px] uppercase tracking-wide text-slate-500">Finanzas</p>
        <ul>
          <li><button data-view="gastos" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Gastos generales</button></li>
          <li><button data-view="servicios" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Servicios</button></li>
          <li><button data-view="facturas" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Facturas</button></li>
        </ul>

        <p class="px-4 pt-4 pb-1 text-[11px] uppercase tracking-wide text-slate-500">Personas & Clientes</p>
        <ul>
          <li><button data-view="clientes" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Clientes</button></li>
          <li><button data-view="personal" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">RRHH / Personal</button></li>
          <li><button data-view="reclamos" class="nav-btn w-full text-left px-4 py-2 hover:bg-slate-800">Reclamos</button></li>
        </ul>
      </nav>

      <div class="px-4 py-3 border-t border-slate-800 text-[11px] text-slate-500">
        BRAVIZIMO'S ERP v2<br />
        <span id="footer-connection">Conectado a Google Sheets</span>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 bg-slate-900/90">
      <!-- Top bar -->
      <header class="h-14 border-b border-slate-800 flex items-center justify-between px-6">
        <div>
          <h1 id="view-title" class="text-lg font-semibold">Dashboard</h1>
          <p class="text-xs text-slate-400" id="view-subtitle">Resumen de ventas, operaci√≥n y finanzas</p>
        </div>
        <div class="flex items-center gap-3">
          <button id="btn-sync" class="px-3 py-1.5 rounded-full text-xs border border-slate-700 hover:border-emerald-400 hover:text-emerald-300">
            Sincronizar ahora
          </button>
        </div>
      </header>

      <!-- Contenido -->
      <section id="view-container" class="p-6 space-y-6 text-sm overflow-y-auto h-[calc(100vh-3.5rem)]">
        <!-- Aqu√≠ se renderizan las vistas con JS -->
      </section>
    </main>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx-Y51fuMKIirWSwadTPWj4m_bdKjIriOIB8DBG2rTQQhk3X-r1iqdW5EDhX6bgiVX_5w/exec";

let ERP_DATA = null;

// Util: formato moneda
const fmtMoney = (n) => "S/ " + (Number(n || 0)).toFixed(2);

// ================== CARGA INICIAL ==================
async function loadAll() {
  setViewSubtitle("Cargando datos desde Google Sheets...");
  try {
    const res = await fetch(API_URL + "?action=getAll");
    const data = await res.json();
    ERP_DATA = data;
    setViewSubtitle("Datos actualizados " + new Date().toLocaleString());
    renderDashboard();
  } catch (e) {
    console.error(e);
    setViewSubtitle("Error al conectar con la API");
  }
}

function setViewTitle(t, s) {
  document.getElementById("view-title").textContent = t;
  if (s) document.getElementById("view-subtitle").textContent = s;
}
function setViewSubtitle(s) {
  document.getElementById("view-subtitle").textContent = s;
}

// ================== VISTAS ==================
function renderDashboard() {
  if (!ERP_DATA) return;

  setViewTitle("Dashboard", "Resumen de ventas, finanzas y operaci√≥n");

  const stats = ERP_DATA.estadisticas || {};
  const dash = ERP_DATA.dashboard || {};

  const totalVentas = stats.totalVentas || 0;
  const ticketProm = stats.ticketPromedio || 0;
  const totalClientes = stats.totalClientes || 0;
  const totalProductos = stats.totalProductos || 0;

  const container = document.getElementById("view-container");
  container.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-[11px] text-slate-400 mb-1">Total Ventas (hist√≥rico)</div>
        <div class="text-2xl font-semibold">${fmtMoney(totalVentas)}</div>
        <div class="text-[11px] text-emerald-400 mt-1">Ticket promedio: ${fmtMoney(ticketProm)}</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-[11px] text-slate-400 mb-1">Clientes registrados</div>
        <div class="text-2xl font-semibold">${totalClientes}</div>
        <div class="text-[11px] text-sky-400 mt-1">Base de datos de clientes</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-[11px] text-slate-400 mb-1">Productos en inventario</div>
        <div class="text-2xl font-semibold">${totalProductos}</div>
        <div class="text-[11px] text-amber-400 mt-1">Insumos + productos finales</div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-[11px] text-slate-400 mb-1">Fecha/Hora</div>
        <div class="text-lg font-semibold">${new Date().toLocaleDateString()}</div>
        <div class="text-[11px] text-slate-400 mt-1">${new Date().toLocaleTimeString()}</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-6">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold">Top productos por stock</h2>
        </div>
        <div class="overflow-x-auto text-xs">
          ${renderTablaSimple(ERP_DATA.inventario || [], ["codigo","nombreproducto","categoria","stockactual","precioventa"], {
            codigo: "C√≥digo",
            nombreproducto: "Producto",
            categoria: "Categor√≠a",
            stockactual: "Stock",
            precioventa: "P. Venta"
          })}
        </div>
      </div>
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <h2 class="text-sm font-semibold mb-2">Alertas de inventario</h2>
        <div id="alertas-box" class="space-y-2 text-xs">
          ${(ERP_DATA.alertas || []).map(a => `
            <div class="rounded-xl px-3 py-2 bg-${a.tipo === "error" ? "rose" : "amber"}-900/40 border border-${a.tipo === "error" ? "rose" : "amber"}-500/40">
              ${a.mensaje}
            </div>
          `).join("") || "<div class='text-slate-500 text-xs'>Sin alertas por ahora üéâ</div>"}
        </div>
      </div>
    </div>
  `;
}

function renderTablaSimple(rows, cols, labels) {
  if (!rows || rows.length === 0) {
    return `<div class="text-slate-500 py-4">Sin registros</div>`;
  }
  return `
    <table class="min-w-full text-left border-collapse">
      <thead>
        <tr>
          ${cols.map(c => `<th class="border-b border-slate-800 px-2 py-1 font-semibold text-[11px] text-slate-400">${labels[c] || c}</th>`).join("")}
        </tr>
      </thead>
      <tbody>
        ${rows.slice(0, 20).map(r => `
          <tr class="hover:bg-slate-800/60">
            ${cols.map(c => `<td class="border-b border-slate-900 px-2 py-1">${formatCell(c, r[c])}</td>`).join("")}
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}
function formatCell(key, val) {
  if (key === "total" || key === "monto" || key === "precioventa" || key === "costo") {
    return fmtMoney(val);
  }
  return val ?? "";
}

// --------- Vistas simples de tablas ----------
function renderTableView(nombre, titulo, columnas, labels) {
  if (!ERP_DATA) return;
  const rows = ERP_DATA[nombre] || [];
  setViewTitle(titulo, `Mostrando ${rows.length} registros`);
  const container = document.getElementById("view-container");
  container.innerHTML = `
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-sm font-semibold">${titulo}</h2>
        <span class="text-[11px] text-slate-500">Fuente: hoja ${nombre.toUpperCase()}</span>
      </div>
      <div class="overflow-x-auto text-xs">
        ${renderTablaSimple(rows, columnas, labels)}
      </div>
    </div>
  `;
}

// --------- Vista Servicios (con formulario) ----------
function renderServicios() {
  if (!ERP_DATA) return;
  const servicios = ERP_DATA.servicios || [];
  setViewTitle("Servicios", "Registrar luz, agua, internet, alquiler, etc. Se guardan tambi√©n en GASTOS");

  const container = document.getElementById("view-container");
  container.innerHTML = `
    <div class="space-y-4">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <h2 class="text-sm font-semibold mb-3">Registrar servicio r√°pido</h2>
        <div class="grid md:grid-cols-5 gap-3 text-xs">
          <input id="srv-nombre" type="text" placeholder="Servicio (ej: Luz Enel Enero)" class="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 focus:outline-none focus:border-emerald-400 md:col-span-2" />
          <input id="srv-monto" type="number" step="0.01" placeholder="Monto (S/)" class="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 focus:outline-none focus:border-emerald-400" />
          <select id="srv-medio" class="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 focus:outline-none focus:border-emerald-400">
            <option value="">Medio de pago</option>
            <option>Transferencia</option>
            <option>Yape</option>
            <option>Plin</option>
            <option>Efectivo</option>
            <option>D√©bito autom√°tico</option>
          </select>
          <select id="srv-cuenta" class="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 focus:outline-none focus:border-emerald-400">
            <option value="">Cuenta</option>
            <option>Bcp BRAVIZIMO‚ÄôS</option>
            <option>RUS Rosa</option>
            <option>RUS Mart√≠n</option>
            <option>RUS Milagros</option>
            <option>RUS Sandy</option>
          </select>
          <select id="srv-estado" class="bg-slate-950/70 border border-slate-700 rounded-xl px-3 py-2 focus:outline-none focus:border-emerald-400">
            <option>Pagado</option>
            <option>Pendiente</option>
          </select>
        </div>
        <div class="mt-3 flex justify-end">
          <button id="btn-guardar-servicio" class="px-4 py-2 rounded-full bg-emerald-500 text-slate-900 text-xs font-semibold hover:bg-emerald-400">
            Guardar servicio
          </button>
        </div>
        <div id="srv-msg" class="mt-2 text-[11px] text-slate-400"></div>
      </div>

      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <h2 class="text-sm font-semibold mb-3">Historial de servicios (gastos)</h2>
        <div class="overflow-x-auto text-xs">
          ${renderTablaSimple(servicios, ["id","fecha","servicio","monto","mediopago","cuenta","estado"], {
            id: "ID",
            fecha: "Fecha",
            servicio: "Servicio",
            monto: "Monto",
            mediopago: "Medio",
            cuenta: "Cuenta",
            estado: "Estado"
          })}
        </div>
      </div>
    </div>
  `;

  document.getElementById("btn-guardar-servicio").addEventListener("click", guardarServicio);
}

async function guardarServicio() {
  const nombre = document.getElementById("srv-nombre").value.trim();
  const monto = document.getElementById("srv-monto").value;
  const medio = document.getElementById("srv-medio").value;
  const cuenta = document.getElementById("srv-cuenta").value;
  const estado = document.getElementById("srv-estado").value;
  const msgEl = document.getElementById("srv-msg");

  if (!nombre || !monto) {
    msgEl.textContent = "Completa al menos servicio y monto.";
    msgEl.className = "mt-2 text-[11px] text-amber-400";
    return;
  }

  msgEl.textContent = "Guardando servicio...";
  msgEl.className = "mt-2 text-[11px] text-slate-400";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        action: "crear_servicio",
        servicio: nombre,
        monto: Number(monto),
        mediopago: medio,
        cuenta,
        estado
      })
    });
    const out = await res.json();
    if (out.success) {
      msgEl.textContent = "Servicio registrado correctamente ‚úÖ";
      msgEl.className = "mt-2 text-[11px] text-emerald-400";
      await loadAll();   // recarga ERP_DATA
      renderServicios(); // vuelve a pintar
    } else {
      msgEl.textContent = "Error: " + (out.mensaje || "No se pudo guardar");
      msgEl.className = "mt-2 text-[11px] text-rose-400";
    }
  } catch (e) {
    console.error(e);
    msgEl.textContent = "Error de conexi√≥n con la API";
    msgEl.className = "mt-2 text-[11px] text-rose-400";
  }
}

// ================== NAV ==================
document.querySelectorAll(".nav-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("bg-slate-800","text-emerald-300","font-semibold"));
    btn.classList.add("bg-slate-800","text-emerald-300","font-semibold");

    const view = btn.getAttribute("data-view");
    if (view === "dashboard") return renderDashboard();
    if (view === "servicios") return renderServicios();

    // tablas simples
    if (view === "ventas")      return renderTableView("ventas", "Ventas", ["idventa","fecharegistro","cliente","canal","total","estadopago","estadopedido"], {
      idventa: "ID",
      fecharegistro: "F. Registro",
      cliente: "Cliente",
      canal: "Canal",
      total: "Total",
      estadopago: "Pago",
      estadopedido: "Estado"
    });
    if (view === "inventario")  return renderTableView("inventario", "Inventario", ["codigo","nombreproducto","categoria","stockactual","stockminimo","precioventa"], {
      codigo: "C√≥digo",
      nombreproducto: "Producto",
      categoria: "Categor√≠a",
      stockactual: "Stock",
      stockminimo: "M√≠nimo",
      precioventa: "P. Venta"
    });
    if (view === "insumos")     return renderTableView("insumos", "Insumos", ["codigo","nombre","categoria","stock","minimo","costounit","proveedor"], {
      codigo: "C√≥digo",
      nombre: "Nombre",
      categoria: "Categor√≠a",
      stock: "Stock",
      minimo: "M√≠nimo",
      costounit: "Costo",
      proveedor: "Proveedor"
    });
    if (view === "produccion")  return renderTableView("produccion", "Producci√≥n", ["id","fecha","producto","cantidad","estado","costo"], {
      id: "ID",
      fecha: "Fecha",
      producto: "Producto",
      cantidad: "Cantidad",
      estado: "Estado",
      costo: "Costo"
    });
    if (view === "compras")     return renderTableView("compras", "Compras", ["id","fecha","proveedor","total","estadopago","estadocompra"], {
      id: "ID",
      fecha: "Fecha",
      proveedor: "Proveedor",
      total: "Total",
      estadopago: "Pago",
      estadocompra: "Estado"
    });
    if (view === "proveedores") return renderTableView("proveedores", "Proveedores", ["id","nombre","ruc","telefono","email","categoria","calificacion","estado"], {
      id: "ID",
      nombre: "Nombre",
      ruc: "RUC",
      telefono: "Tel√©fono",
      email: "Email",
      categoria: "Categor√≠a",
      calificacion: "Rating",
      estado: "Estado"
    });
    if (view === "gastos")      return renderTableView("gastos", "Gastos generales", ["id","fecha","categoria","descripcion","monto","metodopago","cuenta","estado"], {
      id: "ID",
      fecha: "Fecha",
      categoria: "Categor√≠a",
      descripcion: "Descripci√≥n",
      monto: "Monto",
      metodopago: "Medio",
      cuenta: "Cuenta",
      estado: "Estado"
    });
    if (view === "facturas")    return renderTableView("facturas", "Facturas", ["id","tipo","numero","fecha","cliente","total","estado"], {
      id: "ID",
      tipo: "Tipo",
      numero: "N√∫mero",
      fecha: "Fecha",
      cliente: "Cliente",
      total: "Total",
      estado: "Estado"
    });
    if (view === "clientes")    return renderTableView("clientes", "Clientes", ["id","nombre","documento","telefono","segmento","totalcompras","estado"], {
      id: "ID",
      nombre: "Nombre",
      documento: "Doc",
      telefono: "Tel√©fono",
      segmento: "Segmento",
      totalcompras: "Total compras",
      estado: "Estado"
    });
    if (view === "delivery")    return renderTableView("delivery", "Delivery", ["id","fecha","cliente","direccion","distrito","repartidor","costo","estado"], {
      id: "ID",
      fecha: "Fecha",
      cliente: "Cliente",
      direccion: "Direcci√≥n",
      distrito: "Distrito",
      repartidor: "Repartidor",
      costo: "Costo",
      estado: "Estado"
    });
    if (view === "personal")    return renderTableView("personal", "Personal / RRHH", ["id","nombre","dni","cargo","telefono","sueldo","comision","estado"], {
      id: "ID",
      nombre: "Nombre",
      dni: "DNI",
      cargo: "Cargo",
      telefono: "Tel√©fono",
      sueldo: "Sueldo",
      comision: "Comisi√≥n %",
      estado: "Estado"
    });
    if (view === "reclamos")    return renderTableView("reclamos", "Reclamos", ["id","fecha","cliente","tipo","descripcion","prioridad","estado"], {
      id: "ID",
      fecha: "Fecha",
      cliente: "Cliente",
      tipo: "Tipo",
      descripcion: "Descripci√≥n",
      prioridad: "Prioridad",
      estado: "Estado"
    });
  });
});

// Bot√≥n sincronizar
document.getElementById("btn-sync").addEventListener("click", async () => {
  setViewSubtitle("Sincronizando datos...");
  try {
    await fetch(API_URL + "?action=sync");
    await loadAll();
    setViewSubtitle("Datos sincronizados " + new Date().toLocaleString());
  } catch (e) {
    console.error(e);
    setViewSubtitle("Error al sincronizar");
  }
});

// Carga inicial
loadAll();
</script>
</body>
</html>
