<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BRAVIZIMO'S | Dashboard Financiero</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb;}
    header{background:#111;color:#fff;padding:16px 20px;}
    .wrap{max-width:1280px;margin:0 auto;padding:16px 20px;}
    .grid{display:grid;gap:12px;}
    .kpis{grid-template-columns:repeat(4,minmax(0,1fr));}
    .card{background:#fff;border:1px solid #e9e9ef;border-radius:16px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04);}
    .kpi-title{font-size:12px;color:#666;margin-bottom:6px;}
    .kpi-value{font-size:22px;font-weight:800;}
    .muted{color:#777;font-size:12px;}
    .btn{border:1px solid #ddd;background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:600;}
    .two{grid-template-columns:repeat(2,minmax(0,1fr));}
    .chart{height:360px;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:13px;white-space:nowrap;}
    th{color:#666;font-weight:700;}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:700;}
    .tab.active{background:#111;color:#fff;border-color:#111;}
    .hide{display:none;}
    @media(max-width:950px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}.two{grid-template-columns:1fr;}}
  </style>
</head>

<body>
<header>
  <div style="max-width:1280px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:12px;">
    <div>
      <div style="font-weight:900;font-size:16px;">Dashboard Financiero</div>
      <div class="muted">Sincronizado con Google Sheets (automático)</div>
    </div>
    <button class="btn" id="btnReload">Actualizar</button>
  </div>
</header>

<div class="wrap">
  <div id="status" class="muted">Cargando datos…</div>

  <!-- KPIs -->
  <div class="grid kpis" style="margin-top:12px;">
    <div class="card"><div class="kpi-title">Ventas totales</div><div id="k1" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Gastos totales</div><div id="k2" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Utilidad</div><div id="k3" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Saldo pendiente</div><div id="k4" class="kpi-value">—</div></div>

    <div class="card"><div class="kpi-title">Delivery cobrado</div><div id="k5" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Costo delivery</div><div id="k6" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Margen delivery</div><div id="k7" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Clientes (total)</div><div id="k8" class="kpi-value">—</div></div>

    <div class="card"><div class="kpi-title">Promedio diario</div><div id="k9" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Proyección mensual</div><div id="k10" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Boletas / Facturas</div><div id="k11" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Pendientes comprobante</div><div id="k12" class="kpi-value">—</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="t_fin">Finanzas</button>
    <button class="tab" data-tab="t_vend">Vendedoras</button>
    <button class="tab" data-tab="t_del">Delivery</button>
    <button class="tab" data-tab="t_prod">Productos</button>
    <button class="tab" data-tab="t_cli">Clientes</button>
    <button class="tab" data-tab="t_gas">Gastos</button>
  </div>

  <!-- FINANZAS -->
  <div id="t_fin">
    <div class="grid two">
      <div class="card">
        <div style="font-weight:900;margin-bottom:8px;">Ventas vs Gastos (por día) + Saldo</div>
        <div id="ch_vg" class="chart"></div>
      </div>
      <div class="card">
        <div style="font-weight:900;margin-bottom:8px;">Acumulado de ventas</div>
        <div id="ch_acc" class="chart"></div>
      </div>
    </div>
  </div>

  <!-- VENDEDORAS -->
  <div id="t_vend" class="hide">
    <div class="card">
      <div style="font-weight:900;margin-bottom:8px;">Vendedoras por día (ventas y saldo)</div>
      <div style="overflow:auto;max-height:420px;">
        <table id="tb_vend">
          <thead><tr><th>Fecha</th><th>Vendedor(a)</th><th>Ventas</th><th>Saldo</th><th>Pedidos</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DELIVERY -->
  <div id="t_del" class="hide">
    <div class="grid two">
      <div class="card">
        <div style="font-weight:900;margin-bottom:8px;">Delivery vs Costo (por día)</div>
        <div id="ch_del" class="chart"></div>
      </div>
      <div class="card">
        <div style="font-weight:900;margin-bottom:8px;">Delivery por motorizado</div>
        <div style="overflow:auto;max-height:360px;">
          <table id="tb_del">
            <thead><tr><th>Nombre</th><th>Delivery</th><th>Costo</th><th>Entregas</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- PRODUCTOS -->
  <div id="t_prod" class="hide">
    <div class="card">
      <div style="font-weight:900;margin-bottom:8px;">Top productos por monto (según fecha de entrega)</div>
      <div id="ch_prod" class="chart"></div>
      <div class="muted">Se basa en la hoja PRODUCTOS (Monto por producto).</div>
    </div>
  </div>

  <!-- CLIENTES -->
  <div id="t_cli" class="hide">
    <div class="card">
      <div style="font-weight:900;margin-bottom:8px;">Clientes por mes (según “Última compra”)</div>
      <div id="ch_cli" class="chart"></div>
    </div>
  </div>

  <!-- GASTOS -->
  <div id="t_gas" class="hide">
    <div class="card">
      <div style="font-weight:900;margin-bottom:8px;">Gastos por categoría</div>
      <div id="ch_gas" class="chart"></div>
    </div>
  </div>

  <div class="muted" id="footer" style="margin-top:12px;"></div>
</div>

<script>
  // ✅ TU WEB APP DE APPS SCRIPT
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfPaptyVNwsVD6YSn3Qe1Jnou6u8oEOUFWRQUkpkcstvw0nWBQwM4SS2oApqe3LZPZ/exec";

  google.charts.load('current', {packages:['corechart']});

  const money = (n) => new Intl.NumberFormat('es-PE', {style:'currency', currency:'PEN'}).format(Number(n||0));
  const num = (n) => new Intl.NumberFormat('es-PE').format(Number(n||0));

  function loadJSONP(){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      window[cbName] = (data) => { delete window[cbName]; script.remove(); resolve(data); };

      const script = document.createElement("script");
      script.src = `${APPS_SCRIPT_URL}?action=data&callback=${cbName}&_=${Date.now()}`;
      script.onerror = () => { delete window[cbName]; script.remove(); reject(new Error("No se pudo cargar data desde Apps Script")); };
      document.body.appendChild(script);
    });
  }

  function drawAll(data){
    // KPIs
    const k = data.kpis;
    document.getElementById("k1").textContent = money(k.totalVentas);
    document.getElementById("k2").textContent = money(k.totalGastos);
    document.getElementById("k3").textContent = money(k.utilidad);
    document.getElementById("k4").textContent = money(k.saldoPendiente);
    document.getElementById("k5").textContent = money(k.deliveryCobrado);
    document.getElementById("k6").textContent = money(k.deliveryCosto);
    document.getElementById("k7").textContent = money(k.deliveryMargen);
    document.getElementById("k8").textContent = num(k.totalClientes);
    document.getElementById("k9").textContent = money(k.promedioDiario);
    document.getElementById("k10").textContent = money(k.proyeccionMensual);
    document.getElementById("k11").textContent = `${num(k.comprobantes.boletas)} / ${num(k.comprobantes.facturas)}`;
    document.getElementById("k12").textContent = num(k.comprobantes.pendientes);

    // Finanzas: Ventas vs Gastos + Saldo
    const vg = new google.visualization.DataTable();
    vg.addColumn("string","Día");
    vg.addColumn("number","Ventas");
    vg.addColumn("number","Gastos");
    vg.addColumn("number","Saldo pendiente");
    data.series.ventasGastosSaldoDia.forEach(r => vg.addRow([r.date, Number(r.ventas), Number(r.gastos), Number(r.saldo)]));
    new google.visualization.LineChart(document.getElementById("ch_vg")).draw(vg, {legend:{position:"bottom"}, height:360});

    // Acumulado
    const ac = new google.visualization.DataTable();
    ac.addColumn("string","Día");
    ac.addColumn("number","Acumulado");
    data.series.acumulado.forEach(r => ac.addRow([r.date, Number(r.acumulado)]));
    new google.visualization.LineChart(document.getElementById("ch_acc")).draw(ac, {legend:{position:"bottom"}, height:360});

    // Delivery
    const dl = new google.visualization.DataTable();
    dl.addColumn("string","Día");
    dl.addColumn("number","Delivery");
    dl.addColumn("number","Costo");
    dl.addColumn("number","Margen");
    data.series.deliveryDia.forEach(r => dl.addRow([r.date, Number(r.delivery), Number(r.costo), Number(r.margen)]));
    new google.visualization.ColumnChart(document.getElementById("ch_del")).draw(dl, {legend:{position:"bottom"}, height:360});

    // Top productos
    const pr = new google.visualization.DataTable();
    pr.addColumn("string","Producto");
    pr.addColumn("number","Monto");
    (data.tables.topProductos||[]).slice(0,12).forEach(r => pr.addRow([r.name, Number(r.value)]));
    new google.visualization.BarChart(document.getElementById("ch_prod")).draw(pr, {legend:{position:"none"}, height:360});

    // Clientes por mes
    const cl = new google.visualization.DataTable();
    cl.addColumn("string","Mes");
    cl.addColumn("number","Clientes");
    (data.breakdowns.clientesPorMes||[]).forEach(r => cl.addRow([r.name, Number(r.value)]));
    new google.visualization.ColumnChart(document.getElementById("ch_cli")).draw(cl, {legend:{position:"none"}, height:360});

    // Gastos por categoría
    const ga = new google.visualization.DataTable();
    ga.addColumn("string","Categoría");
    ga.addColumn("number","Gastos");
    (data.breakdowns.gastosPorCategoria||[]).slice(0,12).forEach(r => ga.addRow([r.name, Number(r.value)]));
    new google.visualization.PieChart(document.getElementById("ch_gas")).draw(ga, {legend:{position:"right"}, height:360});

    // Tablas
    const tbv = document.querySelector("#tb_vend tbody");
    tbv.innerHTML = "";
    (data.tables.vendedorasPorDia||[]).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.date}</td><td>${r.vendedor}</td><td>${money(r.ventas)}</td><td>${money(r.saldo)}</td><td>${num(r.pedidos)}</td>`;
      tbv.appendChild(tr);
    });

    const tbd = document.querySelector("#tb_del tbody");
    tbd.innerHTML = "";
    (data.tables.deliveryPorNombre||[]).forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.nombre}</td><td>${money(r.delivery)}</td><td>${money(r.costo)}</td><td>${num(r.entregas)}</td>`;
      tbd.appendChild(tr);
    });

    document.getElementById("footer").textContent = `Actualizado: ${data.meta.generatedAt}`;
  }

  async function load(){
    document.getElementById("status").textContent = "Cargando datos…";
    try{
      const data = await loadJSONP();
      document.getElementById("status").textContent = "";
      drawAll(data);
      window.onresize = () => drawAll(data);
    }catch(err){
      document.getElementById("status").textContent = "Error: " + err.message;
      console.error(err);
    }
  }

  // Tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.getAttribute("data-tab");
      ["t_fin","t_vend","t_del","t_prod","t_cli","t_gas"].forEach(x=>{
        document.getElementById(x).classList.toggle("hide", x!==id);
      });
    });
  });

  document.getElementById("btnReload").addEventListener("click", load);
  google.charts.setOnLoadCallback(load);
</script>
</body>
</html>
