<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BRAVIZIMO'S | Dashboard Financiero</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --card:#ffffff;
      --muted:#96a0b5;
      --text:#0d1220;
      --line:#e8edf7;
      --shadow:0 18px 40px rgba(2,10,30,.10);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Arial;
      background:linear-gradient(180deg,var(--bg) 0%, #111a33 36%, #f3f6fb 36%, #f3f6fb 100%);
      color:#111;
    }
    .topbar{
      position:sticky; top:0;
      background:linear-gradient(180deg, rgba(11,16,32,.95), rgba(15,23,48,.80));
      backdrop-filter: blur(10px);
      padding:18px 20px;
      z-index:10;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topbar-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{color:#fff}
    .brand .title{font-weight:800; letter-spacing:.3px}
    .brand .sub{font-size:12px; color:rgba(255,255,255,.75); margin-top:4px}

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    select,input,button{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:#fff;
      padding:10px 12px;
      outline:none;
      font-weight:600;
    }
    input[type="month"], input[type="date"]{ color:#fff; }
    button{
      background:#fff; color:#0b1020;
      border:1px solid rgba(255,255,255,.18);
      cursor:pointer;
      padding:10px 14px;
    }
    button:hover{opacity:.94}

    .wrap{max-width:1200px; margin:0 auto; padding:18px 20px 60px;}
    .error{
      margin-top:14px;
      border-radius:14px;
      padding:12px 14px;
      background:#ffe7e7;
      color:#7a1313;
      border:1px solid #ffc6c6;
      display:none;
      font-weight:700;
    }
    .tabs{
      margin-top:16px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid rgba(255,255,255,.18);
      background:#fff;
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      color:#0b1020;
      box-shadow: 0 8px 20px rgba(0,0,0,.04);
    }
    .tab.active{
      background:#0b1020;
      color:#fff;
      border-color:#0b1020;
    }

    .kpis{
      margin-top:18px;
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:14px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 520px){ .kpis{grid-template-columns:1fr;} }

    .kpi{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px;
      border:1px solid var(--line);
    }
    .kpi .label{font-size:12px; color:#6c7892; font-weight:700}
    .kpi .value{font-size:22px; font-weight:900; margin-top:8px}

    .grid2{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr;} }

    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px;
      border:1px solid var(--line);
      min-height: 320px;
    }
    .card h3{margin:0 0 10px; font-size:16px}
    .muted{color:#6c7892; font-size:12px; font-weight:700}

    .section{display:none; margin-top:14px;}
    .section.active{display:block;}

    table{width:100%; border-collapse:collapse; font-size:13px;}
    th,td{padding:10px 8px; border-bottom:1px solid #eef2fb; text-align:left;}
    th{color:#6c7892; font-size:12px; text-transform:uppercase; letter-spacing:.4px;}
    .right{text-align:right;}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="title">BRAVIZIMO'S | Dashboard Financiero</div>
        <div class="sub">Sincronizado con Google Sheets (Apps Script)</div>
      </div>

      <div class="controls">
        <select id="mode">
          <option value="month">Mes</option>
          <option value="range">Rango</option>
        </select>

        <input id="month" type="month" />
        <input id="from" type="date" style="display:none" />
        <input id="to" type="date" style="display:none" />

        <button id="btn">Actualizar</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="err" class="error"></div>

    <div class="tabs">
      <div class="tab active" data-tab="finanzas">Finanzas</div>
      <div class="tab" data-tab="servicios">Servicios</div>
    </div>

    <div class="kpis" id="kpis"></div>

    <!-- FINANZAS -->
    <div class="section active" id="sec-finanzas">
      <div class="grid2">
        <div class="card">
          <h3>Ventas vs Gastos (por día) + Saldo</h3>
          <div class="muted">Basado en fecha de emisión (ventas) y fecha de pago (gastos).</div>
          <canvas id="ch1" height="140"></canvas>
        </div>
        <div class="card">
          <h3>Acumulado de ventas</h3>
          <div class="muted">Suma progresiva por día.</div>
          <canvas id="ch2" height="140"></canvas>
        </div>
      </div>
    </div>

    <!-- SERVICIOS -->
    <div class="section" id="sec-servicios">
      <div class="grid2">
        <div class="card">
          <h3>Servicios: Pagado vs Pendiente (por día)</h3>
          <div class="muted">Se toma TIPO / FECHA / MONTO / ESTADO.</div>
          <canvas id="chServ" height="140"></canvas>
        </div>
        <div class="card">
          <h3>Servicios (lista)</h3>
          <div class="muted">Hasta 200 filas del periodo.</div>
          <div style="max-height:260px; overflow:auto; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Fecha</th>
                  <th class="right">Monto</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="tbServ"></tbody>
            </table>
          </div>
          <div class="muted" id="servErr" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
 
  </div>
  
<script>
  // ✅ TU WEB APP
  const API_URL = "https://script.google.com/macros/s/AKfycbx3SbJaQ-QcYi5Vo71zE2leTGk7d_tvnIfezhQ63ZhurXecVV4H04hUG4zvSm048lMi/exec";

  const $ = (id) => document.getElementById(id);
  const fmt = (n) => new Intl.NumberFormat("es-PE", { style:"currency", currency:"PEN" }).format(Number(n||0));
  const fmtN = (n) => new Intl.NumberFormat("es-PE").format(Number(n||0));

  let ch1, ch2, chServ;

  function setError(msg){
    const el = $("err");
    if(!msg){ el.style.display="none"; el.textContent=""; return; }
    el.style.display="block";
    el.textContent = msg;
  }

  function setModeUI(){
    const mode = $("mode").value;
    $("month").style.display = mode === "month" ? "inline-flex" : "none";
    $("from").style.display = mode === "range" ? "inline-flex" : "none";
    $("to").style.display = mode === "range" ? "inline-flex" : "none";
  }

  function buildParams(){
    const mode = $("mode").value;
    const p = new URLSearchParams();
    p.set("mode", mode);

    if(mode === "month"){
      // input month devuelve YYYY-MM
      const m = $("month").value;
      if(m) p.set("month", m);
    }else{
      const from = $("from").value;
      const to = $("to").value;
      if(from) p.set("from", from);
      if(to) p.set("to", to);
    }
    return p;
  }

  // ✅ JSONP loader (evita CORS + evita error HTML)
  function fetchJSONP(url){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const script = document.createElement("script");

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      function cleanup(){
        if(script && script.parentNode) script.parentNode.removeChild(script);
        try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
      }

      script.onerror = () => {
        cleanup();
        reject(new Error("No se pudo cargar Apps Script (script error / permisos / URL)."));
      };

      const sep = url.includes("?") ? "&" : "?";
      script.src = url + sep + "callback=" + cbName;
      document.body.appendChild(script);
    });
  }

  function renderKPIs(data){
    const k = data.kpis || {};
    const cards = [
      ["Ventas totales", fmt(k.ventasTotales)],
      ["Gastos totales", fmt(k.gastosTotales)],
      ["Utilidad", fmt(k.utilidad)],
      ["Saldo pendiente", fmt(k.saldoPendiente)],
      ["Delivery cobrado", fmt(k.deliveryCobrado)],
      ["Costo delivery", fmt(k.costoDelivery)],
      ["Margen delivery", fmt(k.margenDelivery)],
      ["Clientes (total)", fmtN(k.clientesTotal)],
      ["Promedio diario (hasta hoy)", fmt(k.promedioDiario)],
      ["Proyección mensual (prom * 30)", fmt(k.proyeccionMensual)],
      ["Boletas / Facturas", `${fmtN(k.boletasFacturas?.boletas||0)} / ${fmtN(k.boletasFacturas?.facturas||0)}`],
      ["Comprobantes faltantes", fmtN(k.boletasFacturas?.sinComprobante||0)],
    ];

    $("kpis").innerHTML = cards.map(([label,value]) => `
      <div class="kpi">
        <div class="label">${label}</div>
        <div class="value">${value}</div>
      </div>
    `).join("");
  }

  function renderCharts(data){
    const rows = data.series?.daily || [];
    const labels = rows.map(r => r.date);
    const ventas = rows.map(r => r.ventas);
    const gastos = rows.map(r => r.gastos);
    const saldo  = rows.map(r => r.saldo);
    const acumulado = rows.map(r => r.acumulado);

    if(ch1) ch1.destroy();
    if(ch2) ch2.destroy();

    ch1 = new Chart($("ch1"),{
      type:"line",
      data:{
        labels,
        datasets:[
          { label:"Ventas", data:ventas, tension:.25 },
          { label:"Gastos", data:gastos, tension:.25 },
          { label:"Saldo pendiente", data:saldo, tension:.25 }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        scales:{ x:{ ticks:{ maxRotation:50, minRotation:50 } } }
      }
    });

    ch2 = new Chart($("ch2"),{
      type:"line",
      data:{
        labels,
        datasets:[
          { label:"Acumulado", data:acumulado, tension:.25 }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        scales:{ x:{ ticks:{ maxRotation:50, minRotation:50 } } }
      }
    });
  }

  function renderServicios(data){
    const sec = data.sections?.servicios || {};
    const err = sec.error || "";
    $("servErr").textContent = err ? ("Aviso servicios: " + err) : "";

    // tabla
    const list = sec.lista || [];
    $("tbServ").innerHTML = list.map(r => `
      <tr>
        <td>${(r.servicio||"")}</td>
        <td>${(r.fecha||"")}</td>
        <td class="right">${fmt(r.monto||0)}</td>
        <td>${(r.estado||"")}</td>
      </tr>
    `).join("");

    // grafico
    const daily = sec.daily || [];
    const labels = daily.map(d => d.date);
    const pagado = daily.map(d => d.pagado);
    const pendiente = daily.map(d => d.pendiente);

    if(chServ) chServ.destroy();
    chServ = new Chart($("chServ"),{
      type:"bar",
      data:{
        labels,
        datasets:[
          { label:"Pagado", data: pagado },
          { label:"Pendiente", data: pendiente }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ position:"bottom" } },
        scales:{
          x:{ stacked:true, ticks:{ maxRotation:50, minRotation:50 } },
          y:{ stacked:true }
        }
      }
    });
  }

  function setTab(tab){
    document.querySelectorAll(".tab").forEach(t=>{
      t.classList.toggle("active", t.dataset.tab === tab);
    });
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    $("sec-"+tab).classList.add("active");
  }

  async function load(){
    setError("");
    const params = buildParams();
    const url = API_URL + "?" + params.toString();

    try{
      const data = await fetchJSONP(url);
      if(!data || data.ok !== true){
        setError("Error Apps Script: " + (data?.error || "Respuesta inválida"));
        return;
      }
      renderKPIs(data);
      renderCharts(data);
      renderServicios(data);

    }catch(err){
      setError("No se pudo sincronizar: " + (err?.message || String(err)));
    }
  }

  // init
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  $("month").value = `${yyyy}-${mm}`;

  $("mode").addEventListener("change", () => { setModeUI(); });
  $("btn").addEventListener("click", load);

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=> setTab(t.dataset.tab));
  });

  setModeUI();
  load();
</script>
</body>
</html>
