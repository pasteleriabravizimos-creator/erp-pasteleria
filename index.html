<!doctype html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: Arial, sans-serif; margin: 18px; }
      .grid { display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 12px; }
      .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 12px; }
      .k { font-size: 12px; color: #666; }
      .v { font-size: 20px; font-weight: 700; margin-top: 6px; }
      h2 { margin-top: 22px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; }
      .row { display:flex; gap:12px; flex-wrap:wrap; }
      .pill { padding: 4px 10px; border-radius: 999px; background:#f3f3f3; display:inline-block; font-size:12px; }
      @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
  </head>
  <body>
    <div class="row">
      <div class="pill" id="range"></div>
      <div class="pill" id="tipo"></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card"><div class="k">Ingresos</div><div class="v" id="ingresos">-</div></div>
      <div class="card"><div class="k">Gastos</div><div class="v" id="gastos">-</div></div>
      <div class="card"><div class="k">Utilidad</div><div class="v" id="utilidad">-</div></div>
      <div class="card"><div class="k">Margen</div><div class="v" id="margen">-</div></div>

      <div class="card"><div class="k">Ventas (N°)</div><div class="v" id="ventasCount">-</div></div>
      <div class="card"><div class="k">Doc. Pendientes (N°)</div><div class="v" id="docPendCount">-</div></div>
      <div class="card"><div class="k">Monto Doc. Pendiente</div><div class="v" id="docPendMonto">-</div></div>
      <div class="card"><div class="k">Monto Pago Pendiente</div><div class="v" id="pagoPendMonto">-</div></div>

      <div class="card"><div class="k">Clientes Nuevos</div><div class="v" id="clientesNuevos">-</div></div>
      <div class="card"><div class="k">Clientes Frecuentes</div><div class="v" id="clientesFrecuentes">-</div></div>
      <div class="card"><div class="k">Días alerta servicios</div><div class="v" id="diasAlerta">-</div></div>
      <div class="card"><div class="k">Tipo de fecha</div><div class="v" id="tipoFecha2">-</div></div>
    </div>

    <h2>Top productos (por monto)</h2>
    <table id="topProductos">
      <thead><tr><th>Producto</th><th>Cantidad</th><th>Monto</th></tr></thead>
      <tbody></tbody>
    </table>

    <h2>Servicios próximos a vencer</h2>
    <table id="servicios">
      <thead><tr><th>Servicio</th><th>Categoría</th><th>Vencimiento</th><th>Monto</th></tr></thead>
      <tbody></tbody>
    </table>

    <script>
      const money = (n) => {
        const v = Number(n || 0);
        return v.toLocaleString(undefined, { style: "currency", currency: "PEN" });
      };
      const pct = (n) => (Number(n||0)*100).toFixed(1) + "%";

      function set(id, text) { document.getElementById(id).textContent = text; }

      function load() {
        google.script.run.withSuccessHandler((res) => {
          if (!res || !res.ok) {
            document.body.insertAdjacentHTML("afterbegin",
              `<div class="card" style="border-color:#f99;background:#fff0f0">
                ${res?.error || "Error cargando datos"}
              </div>`);
            return;
          }

          const k = res.kpi || {};
          set("range", `Rango: ${k.Desde} → ${k.Hasta}`);
          set("tipo", `Filtro: ${k.TipoFecha}`);

          set("ingresos", money(k.Ingresos));
          set("gastos", money(k.Gastos));
          set("utilidad", money(k.Utilidad));
          set("margen", pct(k.Margen));

          set("ventasCount", k.VentasCount ?? "-");
          set("docPendCount", k.DocPendCount ?? "-");
          set("docPendMonto", money(k.DocPendMonto));
          set("pagoPendMonto", money(k.PagoPendMonto));

          set("clientesNuevos", k.ClientesNuevos ?? "-");
          set("clientesFrecuentes", k.ClientesFrecuentes ?? "-");
          set("diasAlerta", k.DiasAlertaServicios ?? "-");
          set("tipoFecha2", k.TipoFecha ?? "-");

          // Top productos
          const tb1 = document.querySelector("#topProductos tbody");
          tb1.innerHTML = "";
          (res.topProductos || []).forEach(x => {
            tb1.insertAdjacentHTML("beforeend",
              `<tr><td>${x.producto}</td><td>${x.cantidad}</td><td>${money(x.monto)}</td></tr>`);
          });

          // Servicios alerta
          const tb2 = document.querySelector("#servicios tbody");
          tb2.innerHTML = "";
          (res.servicios || []).forEach(x => {
            const d = new Date(x.vencimiento);
            tb2.insertAdjacentHTML("beforeend",
              `<tr><td>${x.servicio}</td><td>${x.categoria}</td><td>${d.toLocaleDateString()}</td><td>${money(x.monto)}</td></tr>`);
          });

        }).getResumenData();
      }
      load();
    </script>
  </body>
</html>
