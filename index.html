const SHEETS = {
  PRODUCTOS: "PRODUCTOS",
  KARDEX: "KARDEX",
  RECETAS: "RECETAS",
  INGRESOS: "FORM_INGRESOS",
  SALIDAS: "FORM_SALIDAS",
  PRODUCCION: "FORM_PRODUCCION",
  VENTAS: "FORM_VENTAS",
};

const HEADERS = {
  PRODUCTOS: ["SKU","Producto","Categoria","UnidadBase","StockMin","Costo","Precio","Activo"],
  KARDEX: ["Fecha","Tipo","SKU","Producto","CantidadBase","UnidadBase","CostoUnit","Nota","Referencia"],
  RECETAS: ["ProductoFinal","SKU_Insumo","Insumo","CantidadPorUnidad","UnidadBase"],
  FORM_INGRESOS: ["Fecha","Producto","Cantidad","Unidad","CostoUnit","Nota","Referencia","PROCESADO"],
  FORM_SALIDAS: ["Fecha","Producto","Cantidad","Unidad","Motivo","Nota","Referencia","PROCESADO"],
  FORM_PRODUCCION: ["Fecha","ProductoFinal","CantidadProducida","Nota","Referencia","PROCESADO"],
  FORM_VENTAS: ["Fecha","ProductoFinal","CantidadVendida","PrecioUnit","Canal","Nota","Referencia","PROCESADO"],
};

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu("ERP")
    .addItem("1) Crear hojas (Setup)", "erpSetup")
    .addItem("2) Crear trigger onEdit", "createOnEditTrigger")
    .addToUi();
}

function erpSetup() {
  const ss = SpreadsheetApp.getActive();

  Object.keys(SHEETS).forEach(k => {
    const name = SHEETS[k];
    let sh = ss.getSheetByName(name);
    if (!sh) sh = ss.insertSheet(name);

    const headers = HEADERS[name];
    if (!headers) return;

    const firstRow = sh.getRange(1,1,1,sh.getLastColumn() || headers.length).getValues()[0];
    const hasAnyHeader = firstRow.some(v => String(v).trim() !== "");

    if (!hasAnyHeader) {
      sh.getRange(1,1,1,headers.length).setValues([headers]);
      sh.setFrozenRows(1);
    }
  });

  SpreadsheetApp.getUi().alert("Listo ✅ Se crearon las hojas y encabezados del ERP.");
}

function createOnEditTrigger() {
  // Borra triggers anteriores
  ScriptApp.getProjectTriggers().forEach(t => {
    if (t.getHandlerFunction() === "onEditRouter") ScriptApp.deleteTrigger(t);
  });

  ScriptApp.newTrigger("onEditRouter")
    .forSpreadsheet(SpreadsheetApp.getActive())
    .onEdit()
    .create();

  SpreadsheetApp.getUi().alert("Trigger onEdit creado ✅ Ahora registra en KARDEX cuando llenes los forms.");
}

// ---------- Router ----------
function onEditRouter(e) {
  const sh = e.range.getSheet();
  const name = sh.getName();
  const row = e.range.getRow();
  if (row < 2) return;

  if (name === SHEETS.INGRESOS) handleIngreso_(sh, row);
  if (name === SHEETS.SALIDAS) handleSalida_(sh, row);
  if (name === SHEETS.PRODUCCION) handleProduccion_(sh, row);
  if (name === SHEETS.VENTAS) handleVenta_(sh, row);
}

// ---------- Helpers ----------
function getHeaders_(sheet) {
  const values = sheet.getRange(1,1,1,sheet.getLastColumn()).getValues()[0];
  const map = {};
  values.forEach((h,i)=> map[String(h).trim()] = i+1);
  return map;
}
function getRowObject_(sheet,row) {
  const headers = getHeaders_(sheet);
  const vals = sheet.getRange(row,1,1,sheet.getLastColumn()).getValues()[0];
  const o = {};
  Object.keys(headers).forEach(h => o[h] = vals[headers[h]-1]);
  return o;
}
function norm_(s){
  return String(s||"").trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function isProcessed_(sheet,row){
  const h = getHeaders_(sheet);
  const c = h["PROCESADO"];
  if (!c) return false;
  return norm_(sheet.getRange(row,c).getValue()) === "SI";
}
function markProcessed_(sheet,row){
  const h = getHeaders_(sheet);
  const c = h["PROCESADO"];
  if (c) sheet.getRange(row,c).setValue("SI");
}

function getProductosMap_() {
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName(SHEETS.PRODUCTOS);
  const data = sh.getDataRange().getValues();
  const headers = data[0].map(h=>String(h).trim());
  const iSku = headers.indexOf("SKU");
  const iProd = headers.indexOf("Producto");
  const iUni = headers.indexOf("UnidadBase");
  const iCos = headers.indexOf("Costo");

  const byName = {};
  for (let i=1;i<data.length;i++){
    const sku = data[i][iSku];
    const prod = data[i][iProd];
    const unidad = iUni>=0 ? data[i][iUni] : "";
    const costo = iCos>=0 ? data[i][iCos] : "";
    if (!sku || !prod) continue;
    byName[norm_(prod)] = { sku, prod, unidad, costo };
  }
  return { byName };
}

function toBaseQty_(qty, unidadIngresada, unidadBase){
  const q = Number(qty||0);
  const uIn = norm_(unidadIngresada);
  const uBase = norm_(unidadBase);

  if (!q) return 0;
  if (uBase==="KG" && (uIn==="GR"||uIn==="G")) return q/1000;
  if ((uBase==="LT"||uBase==="L") && uIn==="ML") return q/1000;
  return q;
}

function appendKardex_(mov){
  const ss = SpreadsheetApp.getActive();
  const k = ss.getSheetByName(SHEETS.KARDEX);
  k.appendRow([
    mov.fecha || new Date(),
    mov.tipo,
    mov.sku,
    mov.producto,
    mov.cantidadBase,
    mov.unidadBase,
    mov.costoUnit || "",
    mov.nota || "",
    mov.referencia || "",
  ]);
}

// ---------- Handlers ----------
function handleIngreso_(sheet,row){
  if (isProcessed_(sheet,row)) return;
  const r = getRowObject_(sheet,row);
  const { byName } = getProductosMap_();
  const p = byName[norm_(r["Producto"])];
  if (!p) return;

  const qtyBase = toBaseQty_(r["Cantidad"], r["Unidad"], p.unidad);

  appendKardex_({
    fecha: r["Fecha"] || new Date(),
    tipo: "INGRESO",
    sku: p.sku,
    producto: p.prod,
    cantidadBase: qtyBase,
    unidadBase: p.unidad,
    costoUnit: r["CostoUnit"] || p.costo,
    nota: r["Nota"] || "Ingreso",
    referencia: r["Referencia"] || "",
  });
  markProcessed_(sheet,row);
}

function handleSalida_(sheet,row){
  if (isProcessed_(sheet,row)) return;
  const r = getRowObject_(sheet,row);
  const { byName } = getProductosMap_();
  const p = byName[norm_(r["Producto"])];
  if (!p) return;

  const qtyBase = toBaseQty_(r["Cantidad"], r["Unidad"], p.unidad);

  appendKardex_({
    fecha: r["Fecha"] || new Date(),
    tipo: "SALIDA",
    sku: p.sku,
    producto: p.prod,
    cantidadBase: -Math.abs(qtyBase),
    unidadBase: p.unidad,
    costoUnit: p.costo,
    nota: r["Motivo"] || "Salida",
    referencia: r["Referencia"] || "",
  });
  markProcessed_(sheet,row);
}

function handleProduccion_(sheet,row){
  if (isProcessed_(sheet,row)) return;
  // Aquí luego lo conectamos con RECETAS para descontar por insumo.
  const r = getRowObject_(sheet,row);
  appendKardex_({
    fecha: r["Fecha"] || new Date(),
    tipo: "PRODUCCION",
    sku: "",
    producto: r["ProductoFinal"],
    cantidadBase: 0,
    unidadBase: "",
    costoUnit: "",
    nota: "Producción (pendiente receta)",
    referencia: r["Referencia"] || "",
  });
  markProcessed_(sheet,row);
}

function handleVenta_(sheet,row){
  if (isProcessed_(sheet,row)) return;
  // Aquí luego lo conectamos con RECETAS para descontar por insumo.
  const r = getRowObject_(sheet,row);
  appendKardex_({
    fecha: r["Fecha"] || new Date(),
    tipo: "VENTA",
    sku: "",
    producto: r["ProductoFinal"],
    cantidadBase: 0,
    unidadBase: "",
    costoUnit: "",
    nota: "Venta (pendiente receta)",
    referencia: r["Referencia"] || "",
  });
  markProcessed_(sheet,row);
}
