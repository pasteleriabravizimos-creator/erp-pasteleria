<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ERP Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#fafafa;}
    header{padding:16px 20px; background:#111; color:#fff;}
    .wrap{padding:16px 20px; max-width:1200px; margin:0 auto;}
    .grid{display:grid; gap:12px;}
    .kpis{grid-template-columns:repeat(4,minmax(0,1fr));}
    .card{background:#fff; border:1px solid #eee; border-radius:14px; padding:14px;}
    .kpi-title{font-size:12px; color:#666; margin-bottom:6px;}
    .kpi-value{font-size:22px; font-weight:700;}
    .two{grid-template-columns:repeat(2,minmax(0,1fr));}
    .chart{height:360px;}
    table{width:100%; border-collapse:collapse;}
    th,td{padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:14px;}
    th{color:#666; font-weight:600;}
    .muted{color:#777; font-size:12px;}
    .btn{border:1px solid #ddd; background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer;}
    @media(max-width:900px){
      .kpis{grid-template-columns:repeat(2,minmax(0,1fr));}
      .two{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
<header>
  <div style="max-width:1200px;margin:0 auto; display:flex; justify-content:space-between; gap:12px; align-items:center;">
    <div>
      <div style="font-weight:700;">ERP Dashboard</div>
      <div class="muted">Sincronizado con Google Sheets</div>
    </div>
    <button class="btn" id="btnReload">Actualizar</button>
  </div>
</header>

<div class="wrap">
  <div id="status" class="muted">Cargando datos…</div>

  <div class="grid kpis" style="margin-top:12px;">
    <div class="card"><div class="kpi-title">Ingresos (caja)</div><div id="kpiIngresos" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Gastos</div><div id="kpiGastos" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Utilidad</div><div id="kpiUtilidad" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Pedidos</div><div id="kpiPedidos" class="kpi-value">—</div></div>

    <div class="card"><div class="kpi-title">Ventas (Total pedidos)</div><div id="kpiVentasPedidos" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Clientes nuevos</div><div id="kpiNuevos" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Clientes recurrentes</div><div id="kpiRecurrentes" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-title">Boletas / Facturas / Pend.</div><div id="kpiComp" class="kpi-value">—</div></div>
  </div>

  <div class="grid two" style="margin-top:12px;">
    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Ingresos vs Gastos por día</div>
      <div id="chartIngresosGastos" class="chart"></div>
    </div>
    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Ingresos acumulados</div>
      <div id="chartAcumulado" class="chart"></div>
    </div>
  </div>

  <div class="grid two" style="margin-top:12px;">
    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Ingresos por categoría</div>
      <div id="chartCategorias" class="chart"></div>
    </div>
    <div class="card">
      <div style="font-weight:700; margin-bottom:8px;">Ingresos por distrito</div>
      <div id="chartDistritos" class="chart"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div style="font-weight:700; margin-bottom:8px;">Reporte de vendedoras</div>
    <div style="overflow:auto; max-height:360px;">
      <table id="tablaVendedoras">
        <thead>
          <tr><th>Vendedora</th><th>Ingresos</th><th>Pedidos</th><th>Ticket prom.</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="muted" style="margin-top:12px;" id="footerMeta"></div>
</div>

<script>
  // ✅ Pega tu URL del Web App aquí
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyfPaptyVNwsVD6YSn3Qe1Jnou6u8oEOUFWRQUkpkcstvw0nWBQwM4SS2oApqe3LZPZ/exec";

  google.charts.load('current', {packages:['corechart']});

  const money = (n) => new Intl.NumberFormat('es-PE', {style:'currency', currency:'PEN'}).format(Number(n||0));
  const num = (n) => new Intl.NumberFormat('es-PE').format(Number(n||0));

  // ✅ JSONP loader (evita CORS)
  function loadJSONP(){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);

      window[cbName] = (data) => {
        delete window[cbName];
        script.remove();
        resolve(data);
      };

      const script = document.createElement("script");
      script.src = `${APPS_SCRIPT_URL}?action=data&callback=${cbName}&_=${Date.now()}`;
      script.onerror = () => {
        delete window[cbName];
        script.remove();
        reject(new Error("No se pudo cargar data desde Apps Script"));
      };

      document.body.appendChild(script);
    });
  }

  function draw(data){
    document.getElementById('kpiIngresos').textContent = money(data.kpis.ingresos);
    document.getElementById('kpiGastos').textContent = money(data.kpis.gastos);
    document.getElementById('kpiUtilidad').textContent = money(data.kpis.utilidad);
    document.getElementById('kpiPedidos').textContent = num(data.kpis.pedidos);
    document.getElementById('kpiVentasPedidos').textContent = money(data.kpis.ventasPedidos);
    document.getElementById('kpiNuevos').textContent = num(data.kpis.clientesNuevos);
    document.getElementById('kpiRecurrentes').textContent = num(data.kpis.clientesRecurrentes);

    const bo = data.kpis.comprobantes?.boletas ?? 0;
    const fa = data.kpis.comprobantes?.facturas ?? 0;
    const pe = data.kpis.comprobantes?.pendientes ?? 0;
    document.getElementById('kpiComp').textContent = `${num(bo)} / ${num(fa)} / ${num(pe)}`;

    const ig = new google.visualization.DataTable();
    ig.addColumn('string','Día');
    ig.addColumn('number','Ingresos');
    ig.addColumn('number','Gastos');
    data.series.ingresosGastosDia.forEach(r => ig.addRow([r.date, Number(r.ingresos), Number(r.gastos)]));
    new google.visualization.LineChart(document.getElementById('chartIngresosGastos'))
      .draw(ig, {legend:{position:'bottom'}, height:360});

    const ac = new google.visualization.DataTable();
    ac.addColumn('string','Día');
    ac.addColumn('number','Acumulado');
    data.series.acumulado.forEach(r => ac.addRow([r.date, Number(r.acumulado)]));
    new google.visualization.LineChart(document.getElementById('chartAcumulado'))
      .draw(ac, {legend:{position:'bottom'}, height:360});

    const cat = new google.visualization.DataTable();
    cat.addColumn('string','Categoría');
    cat.addColumn('number','Ingresos');
    (data.breakdowns.categorias || []).slice(0,12).forEach(r => cat.addRow([r.name, Number(r.value)]));
    new google.visualization.PieChart(document.getElementById('chartCategorias'))
      .draw(cat, {legend:{position:'right'}, height:360});

    const dist = new google.visualization.DataTable();
    dist.addColumn('string','Distrito');
    dist.addColumn('number','Ingresos');
    (data.breakdowns.distritos || []).slice(0,12).forEach(r => dist.addRow([r.name, Number(r.value)]));
    new google.visualization.BarChart(document.getElementById('chartDistritos'))
      .draw(dist, {legend:{position:'none'}, height:360});

    const tbody = document.querySelector('#tablaVendedoras tbody');
    tbody.innerHTML = '';
    (data.breakdowns.vendedoras || []).forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${money(r.ingresos)}</td>
        <td>${num(r.pedidos)}</td>
        <td>${money(r.ticketProm)}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('footerMeta').textContent = `Actualizado: ${data.meta.generatedAt}`;
  }

  async function loadAndRender(){
    document.getElementById('status').textContent = 'Cargando datos…';
    try{
      const data = await loadJSONP();
      document.getElementById('status').textContent = '';
      draw(data);
      window.onresize = () => draw(data);
    }catch(err){
      document.getElementById('status').textContent = 'Error: ' + err.message;
      console.error(err);
    }
  }

  document.getElementById('btnReload').addEventListener('click', loadAndRender);
  google.charts.setOnLoadCallback(loadAndRender);
</script>

</body>
</html>
