<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Servicios</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- Navbar -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i data-lucide="layers" class="text-white mr-2"></i>
                    <span class="text-white text-xl font-bold">Gesti√≥n de Servicios</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="location.href='dashboard-servicios.html'" class="text-white hover:text-gray-200 flex items-center">
                        <i data-lucide="bar-chart-3" class="mr-2" size="20"></i>
                        Dashboard
                    </button>
                    <button onclick="verHistorial()" class="text-white hover:text-gray-200 flex items-center">
                        <i data-lucide="clock" class="mr-2" size="20"></i>
                        Historial
                    </button>
                    <button onclick="location.reload()" class="text-white hover:text-gray-200 flex items-center">
                        <i data-lucide="home" class="mr-2" size="20"></i>
                        Servicios
                    </button>
                    <button onclick="abrirConfiguracion()" class="text-white hover:text-gray-200">
                        <i data-lucide="settings" size="20"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">üìã Gesti√≥n de Servicios</h1>
            <p class="text-gray-600">Registra y administra tus servicios de manera eficiente</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Formulario -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">
                            <span id="form-title">Nuevo Servicio</span>
                        </h2>
                        <button onclick="limpiarFormulario()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="refresh-ccw" size="20"></i>
                        </button>
                    </div>

                    <form id="servicioForm" class="space-y-6" onsubmit="guardarServicio(event)">
                        
                        <!-- Informaci√≥n B√°sica -->
                        <div class="border-b pb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i data-lucide="info" class="mr-2" size="20"></i>
                                Informaci√≥n B√°sica
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        C√≥digo <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="codigo" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="SRV-001">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Proveedor <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="proveedor" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Movistar">
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Servicio <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="servicio" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Internet Fibra 100Mbps">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Categor√≠a
                                    </label>
                                    <select id="categoria"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option value="">Seleccionar...</option>
                                        <option value="Internet">Internet</option>
                                        <option value="Telefon√≠a">Telefon√≠a</option>
                                        <option value="Hosting">Hosting</option>
                                        <option value="Software">Software</option>
                                        <option value="Energ√≠a">Energ√≠a</option>
                                        <option value="Otros">Otros</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Monto (S/) <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" id="monto" step="0.01" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="1200.00">
                                </div>

                                <div class="flex items-center md:col-span-2">
                                    <input type="checkbox" id="montoVariable"
                                        class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                    <label for="montoVariable" class="ml-2 text-sm text-gray-700">
                                        El monto var√≠a cada mes
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Fechas -->
                        <div class="border-b pb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i data-lucide="calendar" class="mr-2" size="20"></i>
                                Fechas
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Fecha del Servicio
                                    </label>
                                    <input type="text" id="fechaServicio"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Seleccionar fecha">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Fecha de Pago
                                    </label>
                                    <input type="text" id="fechaPago"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Seleccionar fecha">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Fecha Vencimiento
                                    </label>
                                    <input type="text" id="fechaVencimiento"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Seleccionar fecha">
                                </div>
                            </div>
                        </div>

                        <!-- Estado y Pago -->
                        <div class="border-b pb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i data-lucide="credit-card" class="mr-2" size="20"></i>
                                Estado y Pago
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Estado <span class="text-red-500">*</span>
                                    </label>
                                    <select id="estado" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option value="PENDIENTE">PENDIENTE</option>
                                        <option value="FALTA PAGAR">FALTA PAGAR</option>
                                        <option value="PAGADO">PAGADO</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Medio de Pago
                                    </label>
                                    <select id="medioPago"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option value="">Seleccionar...</option>
                                        <option value="BCP">BCP</option>
                                        <option value="YAPE">YAPE</option>
                                        <option value="PLIN">PLIN</option>
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Transferencia">Transferencia</option>
                                        <option value="Tarjeta">Tarjeta de Cr√©dito</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Cuenta
                                    </label>
                                    <input type="text" id="cuenta"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="999-888-777">
                                </div>
                            </div>
                        </div>

                        <!-- Notas -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Observaciones / Notas
                            </label>
                            <textarea id="observaciones" rows="3"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="Notas adicionales sobre el servicio..."></textarea>
                        </div>

                        <!-- Botones -->
                        <div class="flex gap-4 pt-6">
                            <button type="submit" class="flex-1 gradient-bg text-white font-semibold py-4 rounded-lg hover:opacity-90 transition flex items-center justify-center">
                                <i data-lucide="save" class="mr-2" size="20"></i>
                                Guardar Servicio
                            </button>
                            <button type="button" onclick="limpiarFormulario()" class="px-6 py-4 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                
                <!-- Stats -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">üìä Resumen R√°pido</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Total Servicios</span>
                            <span class="font-bold text-gray-900" id="stat-total">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Pagados</span>
                            <span class="font-bold text-green-600" id="stat-pagados">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Pendientes</span>
                            <span class="font-bold text-yellow-600" id="stat-pendientes">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Por Pagar</span>
                            <span class="font-bold text-red-600" id="stat-porpagar">0</span>
                        </div>
                    </div>
                </div>

                <!-- Recientes -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">üïí Recientes</h3>
                    <div id="serviciosRecientes" class="space-y-3">
                        <p class="text-sm text-gray-500">Cargando...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Servicios -->
        <div class="mt-8 bg-white rounded-2xl shadow-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">üìã Todos los Servicios</h2>
                <div class="flex gap-4">
                    <input type="text" id="searchInput" placeholder="üîç Buscar..." 
                        class="px-4 py-2 border border-gray-300 rounded-lg"
                        onkeyup="filtrarServicios()">
                    <select id="filterEstado" onchange="filtrarServicios()"
                        class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Todos los estados</option>
                        <option value="PAGADO">PAGADO</option>
                        <option value="PENDIENTE">PENDIENTE</option>
                        <option value="FALTA PAGAR">FALTA PAGAR</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√≥digo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proveedor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Servicio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaServiciosBody" class="divide-y divide-gray-200">
                        <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Cargando servicios...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Configuraci√≥n -->
    <div id="modalConfig" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">‚öôÔ∏è Configuraci√≥n</h3>
                <button onclick="cerrarConfiguracion()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" size="24"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ID de Google Sheet</label>
                    <input type="text" id="configSheetId" class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <input type="text" id="configApiKey" class="w-full px-4 py-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">URL del Web App (Apps Script)</label>
                    <input type="text" id="configWebAppUrl" class="w-full px-4 py-3 border rounded-lg" placeholder="https://script.google.com/macros/s/...">
                </div>
                <button onclick="guardarConfiguracion()" class="w-full gradient-bg text-white font-semibold py-3 rounded-lg">
                    üíæ Guardar Configuraci√≥n
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let SHEET_ID = localStorage.getItem('sheetId') || '';
        let API_KEY = localStorage.getItem('apiKey') || '';
        let WEB_APP_URL = localStorage.getItem('webAppUrl') || '';
        let servicios = [];

        flatpickr("#fechaServicio", { locale: "es", dateFormat: "Y-m-d" });
        flatpickr("#fechaPago", { locale: "es", dateFormat: "Y-m-d" });
        flatpickr("#fechaVencimiento", { locale: "es", dateFormat: "Y-m-d" });

        // Configuraci√≥n
        function abrirConfiguracion() {
            document.getElementById('modalConfig').classList.remove('hidden');
            document.getElementById('modalConfig').classList.add('flex');
            document.getElementById('configSheetId').value = SHEET_ID;
            document.getElementById('configApiKey').value = API_KEY;
            document.getElementById('configWebAppUrl').value = WEB_APP_URL;
        }

        function cerrarConfiguracion() {
            document.getElementById('modalConfig').classList.add('hidden');
        }

        function guardarConfiguracion() {
            SHEET_ID = document.getElementById('configSheetId').value;
            API_KEY = document.getElementById('configApiKey').value;
            WEB_APP_URL = document.getElementById('configWebAppUrl').value;
            
            localStorage.setItem('sheetId', SHEET_ID);
            localStorage.setItem('apiKey', API_KEY);
            localStorage.setItem('webAppUrl', WEB_APP_URL);
            
            cerrarConfiguracion();
            cargarServicios();
            alert('‚úÖ Configuraci√≥n guardada');
        }

        // Cargar servicios
        async function cargarServicios() {
            if (!SHEET_ID || !API_KEY) {
                abrirConfiguracion();
                return;
            }

            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/servicios!A2:J?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.values) {
                    servicios = data.values.map(row => ({
                        proveedor: row[0] || '',
                        servicio: row[1] || '',
                        codigo: row[2] || '',
                        fechaServicio: row[3] || '',
                        fechaPago: row[4] || '',
                        monto: parseFloat(row[5]) || 0,
                        estado: row[6] || '',
                        medioPago: row[7] || '',
                        cuenta: row[8] || '',
                        observaciones: row[9] || ''
                    }));

                    actualizarUI();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al cargar. Verifica tu configuraci√≥n.');
            }
        }

        // Guardar servicio
        async function guardarServicio(event) {
            event.preventDefault();
            
            if (!WEB_APP_URL) {
                alert('‚ö†Ô∏è Configura la URL del Web App primero');
                abrirConfiguracion();
                return;
            }

            const datos = {
                codigo: document.getElementById('codigo').value,
                proveedor: document.getElementById('proveedor').value,
                servicio: document.getElementById('servicio').value,
                categoria: document.getElementById('categoria').value,
                monto: parseFloat(document.getElementById('monto').value),
                fechaServicio: document.getElementById('fechaServicio').value,
                fechaPago: document.getElementById('fechaPago').value,
                fechaVencimiento: document.getElementById('fechaVencimiento').value,
                estado: document.getElementById('estado').value,
                medioPago: document.getElementById('medioPago').value,
                cuenta: document.getElementById('cuenta').value,
                observaciones: document.getElementById('observaciones').value
            };

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                alert('‚úÖ Servicio guardado correctamente');
                limpiarFormulario();
                setTimeout(() => cargarServicios(), 2000);
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al guardar. Verifica la configuraci√≥n.');
            }
        }

        // UI
        function actualizarUI() {
            actualizarStats();
            actualizarTabla();
            actualizarRecientes();
        }

        function actualizarStats() {
            document.getElementById('stat-total').textContent = servicios.length;
            document.getElementById('stat-pagados').textContent = servicios.filter(s => s.estado === 'PAGADO').length;
            document.getElementById('stat-pendientes').textContent = servicios.filter(s => s.estado === 'PENDIENTE').length;
            document.getElementById('stat-porpagar').textContent = servicios.filter(s => s.estado === 'FALTA PAGAR').length;
        }

        function actualizarTabla() {
            const tbody = document.getElementById('tablaServiciosBody');
            tbody.innerHTML = '';

            if (servicios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay servicios registrados</td></tr>';
                return;
            }

            servicios.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                let badgeColor = 'bg-red-100 text-red-800';
                if (s.estado === 'PAGADO') badgeColor = 'bg-green-100 text-green-800';
                if (s.estado === 'PENDIENTE') badgeColor = 'bg-yellow-100 text-yellow-800';

                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm font-mono text-purple-600">${s.codigo}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${s.proveedor}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${s.servicio}</td>
                    <td class="px-6 py-4 text-sm font-semibold">S/ ${s.monto.toFixed(2)}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded ${badgeColor}">${s.estado}</span></td>
                    <td class="px-6 py-4 text-sm">
                        <button onclick="editarServicio('${s.codigo}')" class="text-purple-600 hover:text-purple-800 mr-3">
                            Editar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function actualizarRecientes() {
            const container = document.getElementById('serviciosRecientes');
            const recientes = servicios.slice(-5).reverse();

            if (recientes.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Sin servicios</p>';
                return;
            }

            container.innerHTML = recientes.map(s => `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="font-semibold text-sm">${s.proveedor}</p>
                    <p class="text-xs text-gray-500">${s.servicio}</p>
                </div>
            `).join('');
        }

        function filtrarServicios() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const estado = document.getElementById('filterEstado').value;
            const rows = document.querySelectorAll('#tablaServiciosBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchSearch = text.includes(search);
                const matchEstado = !estado || text.includes(estado.toLowerCase());
                row.style.display = matchSearch && matchEstado ? '' : 'none';
            });
        }

        function limpiarFormulario() {
            document.getElementById('servicioForm').reset();
            document.getElementById('form-title').textContent = 'Nuevo Servicio';
        }

        function editarServicio(codigo) {
            const servicio = servicios.find(s => s.codigo === codigo);
            if (!servicio) return;

            document.getElementById('form-title').textContent = 'Editar Servicio';
            document.getElementById('codigo').value = servicio.codigo;
            document.getElementById('proveedor').value = servicio.proveedor;
            document.getElementById('servicio').value = servicio.servicio;
            document.getElementById('monto').value = servicio.monto;
            document.getElementById('fechaServicio').value = servicio.fechaServicio;
            document.getElementById('fechaPago').value = servicio.fechaPago;
            document.getElementById('estado').value = servicio.estado;
            document.getElementById('medioPago').value = servicio.medioPago;
            document.getElementById('cuenta').value = servicio.cuenta;
            document.getElementById('observaciones').value = servicio.observaciones;

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function verHistorial() {
            alert('üìú Historial - Ver hoja "historial" en Google Sheets');
        }

        window.onload = () => {
            if (SHEET_ID && API_KEY) {
                cargarServicios();
            } else {
                abrirConfiguracion();
            }
        };
    </script>
</body>
</html>
